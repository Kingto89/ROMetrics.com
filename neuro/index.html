<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ROMetrics â€” Clinical Anatomy Viewer</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* --- MODERN DARK UI --- */
:root{ --bg:#0f172a; --panel:rgba(15, 23, 42, 0.95); --accent:#38bdf8; --text:#f1f5f9; --muted:#94a3b8; --border:#334155; }
html,body{ margin:0;height:100%;overflow:hidden; background:var(--bg);color:var(--text); font-family:'Inter',sans-serif; }
canvas{ position:fixed;inset:0;width:100%;height:100%; outline:none; }

/* Floating Panel */
#uiPanel{
  position:fixed; right:20px; top:20px; width:340px;
  background:var(--panel); border:1px solid var(--border);
  border-radius:12px; padding:20px;
  box-shadow:0 10px 40px rgba(0,0,0,0.6);
  backdrop-filter: blur(10px);
  max-height:90vh; overflow-y:auto;
  transition: transform 0.2s ease;
}

h2 { margin:0 0 10px; font-size:18px; color:#fff; letter-spacing:-0.5px; }
h3 { margin:15px 0 5px; font-size:14px; color:var(--accent); text-transform:uppercase; letter-spacing:1px; border-bottom:1px solid var(--border); padding-bottom:5px; }

/* Form Elements */
select, input[type=range] {
  width:100%; padding:10px; border-radius:8px; margin-bottom:10px;
  background:#1e293b; color:#fff; border:1px solid var(--border); font-size:14px; outline:none;
}
label { font-size:12px; font-weight:600; color:var(--muted); display:block; margin-bottom:6px; text-transform:uppercase; }

/* Data Display Area */
#dataDisplay {
  margin-top:15px; font-size:14px; line-height:1.6;
}
.data-row { margin-bottom:8px; }
.data-label { color:var(--muted); font-size:12px; display:block; }
.data-val { color:#fff; font-weight:500; }
.highlight { color:var(--accent); font-weight:700; }
</style>

<script type="importmap">
{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
</script>
</head>

<body>
<canvas id="c"></canvas>

<div id="uiPanel">
  <h2>Clinical Examiner</h2>
  
  <label>Visualization Mode</label>
  <select id="modeSel">
    <option value="derm">Dermatomes (Sensory Map)</option>
    <option value="myo">Myotomes (Motor Map)</option>
    <option value="none">Model Only</option>
  </select>

  <label>Overlay Opacity</label>
  <input id="opacitySel" type="range" min="0" max="1" step="0.05" value="0.85" />

  <div id="dataDisplay">
    <div style="padding:20px; text-align:center; color:#64748b; border:2px dashed #334155; border-radius:8px;">
      Hover or Click a colored region on the body to view clinical data.
    </div>
  </div>
</div>

<script type="module">
import * as THREE from 'three';
import {OrbitControls} from 'three/addons/controls/OrbitControls.js';
import {GLTFLoader} from 'three/addons/loaders/GLTFLoader.js';
import {DRACOLoader} from 'three/addons/loaders/DRACOLoader.js';
import {KTX2Loader} from 'three/addons/loaders/KTX2Loader.js';

/* ------------------------------------------------------------------
   1. CLINICAL DATABASE (Colors + Anatomy)
------------------------------------------------------------------ */
const DB = {
  "C2": { color:0xff0000, muscle:"Sternocleidomastoid", action:"Neck Flexion/Rotation", origin:"Sternum/Clavicle", insert:"Mastoid Process" },
  "C3": { color:0xff2a00, muscle:"Trapezius (Upper)", action:"Neck Lateral Flexion", origin:"Occipital Bone/C7", insert:"Clavicle" },
  "C4": { color:0xff5500, muscle:"Levator Scapulae", action:"Shoulder Elevation", origin:"C1-C4 Transverse Processes", insert:"Scapula (Superior)" },
  "C5": { color:0xff8000, muscle:"Deltoid / Biceps", action:"Shoulder Abduction / Elbow Flexion", origin:"Clavicle/Acromion", insert:"Deltoid Tuberosity" },
  "C6": { color:0xffaa00, muscle:"Wrist Extensors (ECRL/B)", action:"Wrist Extension", origin:"Lateral Epicondyle", insert:"Metacarpals 2-3" },
  "C7": { color:0xffff00, muscle:"Triceps", action:"Elbow Extension", origin:"Humerus/Scapula", insert:"Olecranon Process" },
  "C8": { color:0xaaff00, muscle:"Finger Flexors (FDP)", action:"Finger Flexion", origin:"Ulna", insert:"Distal Phalanxes" },
  "T1": { color:0x55ff00, muscle:"Interossei", action:"Finger Abduction/Adduction", origin:"Metacarpals", insert:"Proximal Phalanx" },
  "T4": { color:0x00ff00, muscle:"Intercostals", action:"Thoracic Expansion", origin:"Ribs 1-11", insert:"Ribs 2-12" },
  "T10":{ color:0x00ff80, muscle:"Abdominals", action:"Trunk Flexion", origin:"Pubic Crest", insert:"Xiphoid Process/Ribs" },
  "L1": { color:0x00ffff, muscle:"Iliopsoas (Minor)", action:"Hip Flexion", origin:"T12-L5 Vertebrae", insert:"Lesser Trochanter" },
  "L2": { color:0x00aaff, muscle:"Iliopsoas", action:"Hip Flexion", origin:"Iliac Fossa/Lumbar Spine", insert:"Lesser Trochanter" },
  "L3": { color:0x0055ff, muscle:"Quadriceps", action:"Knee Extension", origin:"Femur/Ilium", insert:"Tibial Tuberosity" },
  "L4": { color:0x0000ff, muscle:"Tibialis Anterior", action:"Ankle Dorsiflexion", origin:"Lateral Tibia", insert:"Medial Cuneiform" },
  "L5": { color:0x5500ff, muscle:"Extensor Hallucis Longus", action:"Great Toe Extension", origin:"Fibula", insert:"Distal Phalanx (Big Toe)" },
  "S1": { color:0xaa00ff, muscle:"Gastrocnemius/Soleus", action:"Ankle Plantarflexion", origin:"Femoral Condyles", insert:"Calcaneus (Achilles)" },
  "S2": { color:0xff00ff, muscle:"Hamstrings", action:"Knee Flexion", origin:"Ischial Tuberosity", insert:"Tibia/Fibula" }
};

// Mapping Bone Keywords to Levels (Fuzzy Match)
const BONE_MAP = [
    { k:["head"], v:"C2" }, { k:["neck"], v:"C3" },
    { k:["shoulder","clavicle"], v:"C4" },
    { k:["arm","humerus"], v:"C5" },
    { k:["forearm","radius","ulna","thumb","index"], v:"C6" }, // C6 Thumb side
    { k:["middle","hand","wrist"], v:"C7" },
    { k:["pinky","ring"], v:"C8" },
    { k:["spine2","chest"], v:"T4" },
    { k:["spine1","abdomen"], v:"T10" },
    { k:["hips","pelvis","spine"], v:"L1" },
    { k:["upleg","thigh","femur"], v:"L2" },
    { k:["leg","calf","shin"], v:"L4" }, // L3/L4 mix
    { k:["foot","ankle"], v:"L5" },
    { k:["toe","ball"], v:"S1" }
];

/* ------------------------------------------------------------------
   2. SCENE & RENDERER
------------------------------------------------------------------ */
const canvas = document.getElementById('c');
const renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.outputColorSpace = THREE.SRGBColorSpace;

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0f172a); // Dark Blue-Grey

const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 100);
camera.position.set(0, 1.2, 3);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.05;
controls.enablePan = false;

// Lights
const amb = new THREE.AmbientLight(0xffffff, 1);
scene.add(amb);
const dir = new THREE.DirectionalLight(0xffffff, 2);
dir.position.set(5, 10, 7);
scene.add(dir);

/* ------------------------------------------------------------------
   3. LOAD MODEL & GENERATE
------------------------------------------------------------------ */
const loader = new GLTFLoader();
const draco = new DRACOLoader();
draco.setDecoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/");
loader.setDRACOLoader(draco);

let regionMeshes = {}; // Store the point clouds
let originalColors = {}; // Store colors for hover reset

function getModelURL(){
  const u = new URL(location.href);
  const q = u.searchParams.get("model");
  return (q && /^https?:\/\//i.test(q)) ? q : "../assets/Roma_ROMetrics.glb";
}

loader.load(getModelURL(), (gltf) => {
    const model = gltf.scene;
    scene.add(model);

    // Fit Camera
    const box = new THREE.Box3().setFromObject(model);
    const center = box.getCenter(new THREE.Vector3());
    const size = box.getSize(new THREE.Vector3());
    const maxDim = Math.max(size.x, size.y, size.z);
    
    controls.target.copy(center);
    camera.position.copy(center);
    camera.position.z += maxDim * 2.0;
    controls.update();

    // Find Body
    let body = null;
    model.traverse(c => {
        if(c.isSkinnedMesh && c.skeleton){
            if(!body || c.geometry.attributes.position.count > body.geometry.attributes.position.count) body = c;
        }
    });

    if(body) generateMaps(body);
    else document.getElementById('dataDisplay').innerHTML = "Error: No rigged mesh found.";
});

function generateMaps(mesh){
    const pos = mesh.geometry.attributes.position;
    const skinIdx = mesh.geometry.attributes.skinIndex;
    const skinWt = mesh.geometry.attributes.skinWeight;
    const bones = mesh.skeleton.bones;

    const buckets = {}; // "C5-Left" -> [indices]

    const tempPos = new THREE.Vector3();

    for(let i=0; i<pos.count; i++){
        // Get World Pos for Side Calculation
        tempPos.fromBufferAttribute(pos, i);
        tempPos.applyMatrix4(mesh.matrixWorld);
        const isRight = tempPos.x < 0; // Assuming standard T-Pose
        
        // Find Bone
        let maxW=0, bId=0;
        for(let k=0; k<4; k++){
            const w = skinWt.getComponent(i,k);
            if(w > maxW){ maxW=w; bId = skinIdx.getComponent(i,k); }
        }
        const bName = bones[bId].name.toLowerCase();

        // Map Bone to Level
        let level = null;
        for(const m of BONE_MAP){
            if(m.k.some(kw => bName.includes(kw))){ level = m.v; break; }
        }

        if(level){
            const key = `${level}-${isRight?'R':'L'}`;
            if(!buckets[key]) buckets[key] = [];
            buckets[key].push(i);
        }
    }

    // Build Point Clouds
    const worldPosArr = []; // Cache all world positions once
    for(let i=0; i<pos.count; i++){
        tempPos.fromBufferAttribute(pos, i);
        tempPos.applyMatrix4(mesh.matrixWorld);
        worldPosArr.push(tempPos.clone());
    }

    for(const [key, indices] of Object.entries(buckets)){
        const level = key.split('-')[0];
        const data = DB[level] || { color: 0xffffff };

        const geo = new THREE.BufferGeometry();
        const verts = [];
        indices.forEach(idx => {
            const p = worldPosArr[idx];
            verts.push(p.x, p.y, p.z);
        });
        geo.setAttribute('position', new THREE.Float32BufferAttribute(verts, 3));

        const mat = new THREE.PointsMaterial({
            color: data.color,
            size: 0.015,
            sizeAttenuation: true,
            transparent: true,
            opacity: 0.85,
            depthTest: false, // Always visible on top
            depthWrite: false
        });

        const points = new THREE.Points(geo, mat);
        points.userData = { id: key, level: level, ...data };
        points.renderOrder = 999;
        
        scene.add(points);
        regionMeshes[key] = points;
        originalColors[key] = data.color;
    }
}

/* ------------------------------------------------------------------
   4. INTERACTION (RAYCASTER)
------------------------------------------------------------------ */
const raycaster = new THREE.Raycaster();
raycaster.params.Points.threshold = 0.05; // Make dots easier to click
const mouse = new THREE.Vector2();
const ui = document.getElementById('dataDisplay');

let hoveredObject = null;

function updateMouse(e){
    mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
}

function checkIntersects(){
    const visibleMeshes = Object.values(regionMeshes).filter(m => m.visible);
    if(!visibleMeshes.length) return;

    raycaster.setFromCamera(mouse, camera);
    const hits = raycaster.intersectObjects(visibleMeshes, false);

    if(hits.length > 0){
        const hit = hits[0].object;
        
        // Hover Effect
        if(hoveredObject !== hit){
            // Reset previous
            if(hoveredObject) hoveredObject.material.color.setHex(originalColors[hoveredObject.userData.id]);
            
            // Highlight new
            hoveredObject = hit;
            hoveredObject.material.color.setHex(0xffffff); // Flash white
            document.body.style.cursor = "pointer";
        }
        return hit;
    } else {
        if(hoveredObject){
            hoveredObject.material.color.setHex(originalColors[hoveredObject.userData.id]);
            hoveredObject = null;
            document.body.style.cursor = "default";
        }
        return null;
    }
}

window.addEventListener('mousemove', (e) => {
    updateMouse(e);
    checkIntersects(); // Handle hover glow
});

window.addEventListener('click', () => {
    const hit = checkIntersects();
    if(hit){
        updatePanel(hit.userData);
    }
});

function updatePanel(data){
    const mode = document.getElementById('modeSel').value;
    const isDerm = (mode === 'derm');
    const side = data.id.includes('-R') ? "Right" : "Left";

    let html = `
        <div class="data-row"><span class="data-label">LEVEL</span> <span class="data-val highlight" style="font-size:20px; color:${'#'+data.color.toString(16)}">${data.level} (${side})</span></div>
    `;

    if(isDerm){
        // Dermatome View
        html += `
            <div class="data-row"><span class="data-label">TYPE</span> <span class="data-val">Sensory Dermatome</span></div>
            <div class="data-row"><span class="data-label">INNERVATION AREA</span> <span class="data-val">Skin supplied by spinal nerve ${data.level}.</span></div>
        `;
    } else {
        // Myotome View
        html += `
            <div class="data-row"><span class="data-label">PRIMARY MUSCLE</span> <span class="data-val highlight">${data.muscle}</span></div>
            <div class="data-row"><span class="data-label">ACTION</span> <span class="data-val">${data.action}</span></div>
            <hr style="border:0; border-top:1px solid #334155; margin:10px 0;">
            <div class="data-row"><span class="data-label">ORIGIN</span> <span class="data-val">${data.origin}</span></div>
            <div class="data-row"><span class="data-label">INSERTION</span> <span class="data-val">${data.insert}</span></div>
        `;
    }
    
    ui.innerHTML = html;
}

/* ------------------------------------------------------------------
   5. UI CONTROLS
------------------------------------------------------------------ */
const modeSel = document.getElementById('modeSel');
const opSel = document.getElementById('opacitySel');

function updateVis(){
    const mode = modeSel.value;
    const op = parseFloat(opSel.value);

    for(const m of Object.values(regionMeshes)){
        m.material.opacity = op;
        if(mode === 'none') m.visible = false;
        else if(mode === 'derm') m.visible = true; 
        else if(mode === 'myo') {
             // Hide T-spine for myotomes generally as they are mostly sensory on trunk
             const l = m.userData.level;
             if(l.startsWith('T') && l !== 'T1') m.visible = false;
             else m.visible = true;
        }
    }
}

modeSel.addEventListener('change', () => {
    updateVis();
    ui.innerHTML = '<div style="padding:10px; color:#64748b; text-align:center">Select a region...</div>';
});
opSel.addEventListener('input', updateVis);

/* ------------------------------------------------------------------
   6. ANIMATION LOOP
------------------------------------------------------------------ */
function animate(){
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}
animate();

window.addEventListener('resize', () => {
    camera.aspect = innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
