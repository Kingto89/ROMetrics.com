<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ROMetrics â€” Clinical Anatomy Viewer</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{ --bg:#0f172a; --panel:rgba(15, 23, 42, 0.95); --accent:#38bdf8; --text:#f1f5f9; --border:#334155; }
html,body{ margin:0;height:100%;overflow:hidden; background:var(--bg);color:var(--text); font-family:'Inter',sans-serif; }
canvas{ position:fixed;inset:0;width:100%;height:100%; outline:none; }

/* UI Panel */
#uiPanel{
  position:fixed; right:20px; top:20px; width:340px;
  background:var(--panel); border:1px solid var(--border);
  border-radius:12px; padding:20px;
  box-shadow:0 10px 40px rgba(0,0,0,0.6);
  max-height:90vh; overflow-y:auto;
  backdrop-filter: blur(10px);
}

h2 { margin:0 0 15px; font-size:18px; color:#fff; letter-spacing:-0.5px; }

/* Controls */
label { font-size:11px; font-weight:700; color:#94a3b8; display:block; margin-bottom:5px; text-transform:uppercase; letter-spacing:0.5px; }
select, input[type=range] {
  width:100%; padding:10px; border-radius:6px; margin-bottom:15px;
  background:#1e293b; color:#fff; border:1px solid var(--border); font-size:13px; outline:none;
}

/* Data Display */
.info-card { background:rgba(255,255,255,0.03); border-radius:8px; padding:15px; border:1px solid var(--border); margin-top:10px; }
.level-tag { font-size:24px; font-weight:800; letter-spacing:-1px; margin-bottom:5px; display:block; }
.section-title { font-size:11px; color:var(--accent); font-weight:700; text-transform:uppercase; margin-top:12px; display:block; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:2px; margin-bottom:4px; }
.data-text { font-size:13px; line-height:1.5; color:#cbd5e1; }
.muscle-list { margin:0; padding-left:16px; font-size:13px; color:#cbd5e1; }
.muscle-list li { margin-bottom:4px; }
</style>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>
</head>

<body>
<canvas id="c"></canvas>

<div id="uiPanel">
  <h2>Clinical Examiner</h2>
  
  <label>Map Layer</label>
  <select id="modeSel">
    <option value="derm">Dermatomes (Sensory)</option>
    <option value="myo">Myotomes (Motor)</option>
    <option value="none">None (Model Only)</option>
  </select>

  <label>Layer Opacity</label>
  <input id="opacitySel" type="range" min="0" max="1" step="0.05" value="0.85" />

  <div id="dataDisplay">
    <div style="padding:20px; text-align:center; color:#64748b; border:2px dashed #334155; border-radius:8px; font-size:13px;">
      Loading model & calculating map...
    </div>
  </div>
</div>

<script type="module">
import * as THREE from 'three';
import {OrbitControls} from 'three/addons/controls/OrbitControls.js';
import {GLTFLoader} from 'three/addons/loaders/GLTFLoader.js';
import {DRACOLoader} from 'three/addons/loaders/DRACOLoader.js';
import {KTX2Loader} from 'three/addons/loaders/KTX2Loader.js';

/* ------------------------------------------------------------------
   CLINICAL DATABASE
------------------------------------------------------------------ */
const DB = {
  "C2": { color:0xff0000, area:"Back of head, upper neck", muscles:["SCM"], action:"Neck Flexion" },
  "C3": { color:0xff3300, area:"Lower neck", muscles:["Trapezius"], action:"Neck Lateral Flexion" },
  "C4": { color:0xff6600, area:"Top of shoulder", muscles:["Levator Scapulae"], action:"Shoulder Elevation" },
  "C5": { color:0xff9900, area:"Lateral upper arm", muscles:["Deltoid"], action:"Shoulder Abduction" },
  "C6": { color:0xffcc00, area:"Thumb/index", muscles:["Wrist Extensors"], action:"Wrist Extension" },
  "C7": { color:0xffff00, area:"Middle finger", muscles:["Triceps"], action:"Elbow Extension" },
  "C8": { color:0xaaff00, area:"Pinky, ring", muscles:["Finger Flexors"], action:"Finger Flexion" },
  "T1": { color:0x55ff00, area:"Medial forearm", muscles:["Interossei"], action:"Finger Abduction" },
  "T4": { color:0x00ff55, area:"Nipple line", muscles:["Intercostals"], action:"Respiration" },
  "T10":{ color:0x00ffaa, area:"Umbilicus region", muscles:["Abdominals"], action:"Core" },
  "L1": { color:0x00ffff, area:"Upper thigh", muscles:["Iliopsoas"], action:"Hip Flexion" },
  "L2": { color:0x0099ff, area:"Anterior thigh", muscles:["Iliopsoas"], action:"Hip Flexion" },
  "L3": { color:0x0066ff, area:"Medial knee", muscles:["Quadriceps"], action:"Knee Extension" },
  "L4": { color:0x0033ff, area:"Medial shin", muscles:["Tibialis Anterior"], action:"Dorsiflexion" },
  "L5": { color:0x2200ff, area:"Top of foot", muscles:["EHL"], action:"Great Toe Extension" },
  "S1": { color:0x6600ff, area:"Lateral foot", muscles:["Gastroc"], action:"Plantarflexion" },
  "S2": { color:0xaa00ff, area:"Posterior thigh", muscles:["Hamstrings"], action:"Knee Flexion" },
  "S3": { color:0xff00ff, area:"Buttocks", muscles:["Pelvic Floor"], action:"Bladder/Bowel" }
};

/* ------------------------------------------------------------------
   MODEL LOAD
------------------------------------------------------------------ */
const canvas = document.getElementById("c");
const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,2));

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0f172a);

const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0,1.5,3);

const controls = new OrbitControls(camera,renderer.domElement);
controls.enableDamping = true;

scene.add(new THREE.AmbientLight(0xffffff,1.2));

/* Loader */
const loader = new GLTFLoader();
const draco = new DRACOLoader();
draco.setDecoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/");
loader.setDRACOLoader(draco);

function getURL(){
  const u = new URL(location.href);
  const q = u.searchParams.get("model");
  return (q && /^https?:\/\//.test(q)) ? q : "../assets/Roma_ROMetrics.glb";
}

let regionMeshes={}, originalColors={};

/* ------------------------------------------------------------------
   MAIN LOGIC
------------------------------------------------------------------ */
loader.load(getURL(), gltf=>{
  const model = gltf.scene;
  scene.add(model);

  const box = new THREE.Box3().setFromObject(model);
  const center = box.getCenter(new THREE.Vector3());
  controls.target.copy(center);

  let body=null;
  model.traverse(o=>{
    if(o.isSkinnedMesh && !body && o.geometry.attributes.position.count>2000){
      body=o;
    }
  });

  if(!body){
    document.getElementById("dataDisplay").innerHTML="No body mesh found.";
    return;
  }

  createDermMap(body,center);
  document.getElementById("dataDisplay").innerHTML=
    `<div style="padding:15px;text-align:center;color:#fff;background:rgba(56,189,248,0.1);border:1px solid #38bdf8;border-radius:8px;">
      Click a colored dermatome.
     </div>`;
});

/* ------------------------------------------------------------------
   DERMATOME MAP (Fixed + Accurate)
------------------------------------------------------------------ */
function createDermMap(mesh, center){
  const pos = mesh.geometry.attributes.position;
  const skinIdx = mesh.geometry.attributes.skinIndex;
  const skinWt = mesh.geometry.attributes.skinWeight;
  const bones = mesh.skeleton.bones;

  const buckets={};
  const world=new THREE.Vector3();

  const DOT=0.008;

  for(let i=0;i<pos.count;i++){
    world.fromBufferAttribute(pos,i);
    world.applyMatrix4(mesh.matrixWorld);

    const isRight = world.x > center.x;
    const isFront = world.z > center.z;

    // Find dominant bone
    let maxW=0, bID=0;
    for(let j=0;j<4;j++){
      const w = skinWt.getX(i*4+j);
      if(w>maxW){ maxW=w; bID=skinIdx.getX(i*4+j); }
    }

    const b = bones[bID].name.toLowerCase();
    let level=null;

    /* HEAD & NECK */
    if(b.includes("head")) level="C2";
    else if(b.includes("neck")) level="C3";

    /* SHOULDER GIRDLE */
    else if(b.includes("clav")||b.includes("shoulder")) level="C4";

    /* ARMS */
    else if(b.includes("upperarm")) level="C5";
    else if(b.includes("forearm")){
      if(isRight) level="C6"; else level="C7";
    }
    else if(b.includes("hand")){
      if(isFront){
        if(isRight) level="C6"; else level="C7";
      } else {
        level = "C8";
      }
    }

    /* TRUNK */
    else if(b.includes("spine")){
      if(world.y>center.y+0.15) level="T4";
      else level="T10";
    }

    /* PELVIS */
    else if(b.includes("pelvis")) level = isFront?"L1":"S3";

    /* LEGS */
    else if(b.includes("thigh")) level = isFront?"L2":"S2";
    else if(b.includes("calf")) level="L4";
    else if(b.includes("foot")){
      if(isFront) level="L5"; else level="S1";
    }

    if(level){
      const key = level + (isRight?"-R":"-L");
      if(!buckets[key]) buckets[key]=[];
      buckets[key].push(i);
    }
  }

  /* Build meshes */
  for(const key in buckets){
    const level = key.split("-")[0];
    const pts=[];
    const P=new THREE.Vector3();

    buckets[key].forEach(idx=>{
      P.fromBufferAttribute(mesh.geometry.attributes.position,idx)
        .applyMatrix4(mesh.matrixWorld);
      pts.push(P.x,P.y,P.z);
    });

    const geo = new THREE.BufferGeometry();
    geo.setAttribute("position",new THREE.Float32BufferAttribute(pts,3));

    const col = DB[level].color;
    const mat = new THREE.PointsMaterial({
      color:col, size:DOT, transparent:true, opacity:0.85,
      depthTest:false, depthWrite:false
    });

    const p = new THREE.Points(geo,mat);
    p.userData={level,id:key,...DB[level]};
    p.renderOrder=999;

    scene.add(p);
    regionMeshes[key]=p;
    originalColors[key]=col;
  }
}

/* ------------------------------------------------------------------
   INTERACTION
------------------------------------------------------------------ */
const ray=new THREE.Raycaster();
ray.params.Points.threshold=0.05;
const mouse=new THREE.Vector2();
let hovered=null;

function onMove(e){
  mouse.x=(e.clientX/innerWidth)*2-1;
  mouse.y=-(e.clientY/innerHeight)*2+1;

  const visible=Object.values(regionMeshes).filter(m=>m.visible);
  ray.setFromCamera(mouse,camera);

  const hits=ray.intersectObjects(visible);
  if(hits.length){
    const o=hits[0].object;
    if(hovered!==o){
      if(hovered) hovered.material.color.setHex(originalColors[hovered.userData.id]);
      hovered=o;
      hovered.material.color.setHex(0xffffff);
      document.body.style.cursor="pointer";
    }
  } else {
    if(hovered){
      hovered.material.color.setHex(originalColors[hovered.userData.id]);
      hovered=null;
      document.body.style.cursor="default";
    }
  }
}

function onClick(){
  if(hovered) updatePanel(hovered.userData);
}

window.addEventListener("mousemove",onMove);
window.addEventListener("click",onClick);

/* PANEL */
function updatePanel(d){
  const mode = document.getElementById("modeSel").value;
  const side = d.id.includes("-R")?"Right":"Left";
  const hex = "#"+d.color.toString(16).padStart(6,"0");

  let html = `
    <div class="info-card">
      <span class="level-tag" style="color:${hex}">${d.level} <span style="font-size:14px;opacity:0.7">(${side})</span></span>
  `;

  if(mode==="derm"){
    html+=`
      <span class="section-title">Sensory Area</span>
      <div class="data-text">${d.area}</div>
    `;
  } else {
    html+=`
      <span class="section-title">Motor</span>
      <ul class="muscle-list">
        ${d.muscles.map(m=>`<li>${m}</li>`).join("")}
      </ul>
      <span class="section-title">Action</span>
      <div class="data-text">${d.action}</div>
    `;
  }

  html+=`</div>`;
  document.getElementById("dataDisplay").innerHTML=html;
}

/* VISIBILITY */
const modeSel=document.getElementById("modeSel");
const opSel=document.getElementById("opacitySel");

function updateVis(){
  const mode=modeSel.value;
  const op=parseFloat(opSel.value);

  for(const m of Object.values(regionMeshes)){
    m.material.opacity=op;

    if(mode==="none") m.visible=false;
    else if(mode==="derm") m.visible=true;
    else if(mode==="myo"){
      if(m.userData.muscles) m.visible=true;
      else m.visible=false;
    }
  }
}

modeSel.addEventListener("change",updateVis);
opSel.addEventListener("input",updateVis);

/* LOOP */
function loop(){
  requestAnimationFrame(loop);
  controls.update();
  renderer.render(scene,camera);
}
loop();

window.addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
