<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ROMetrics — Clinical Anatomy Viewer</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

<style>
:root{ --bg:#0f172a; --panel:rgba(15, 23, 42, 0.95); --accent:#38bdf8; --text:#f1f5f9; --muted:#94a3b8; --border:#334155; }
html,body{ margin:0;height:100%;overflow:hidden; background:var(--bg);color:var(--text); font-family:'Inter',sans-serif; }
canvas{ position:fixed;inset:0;width:100%;height:100%; outline:none; }

#uiPanel{
  position:fixed; right:20px; top:20px; width:340px;
  background:var(--panel); border:1px solid var(--border);
  border-radius:12px; padding:20px;
  box-shadow:0 10px 40px rgba(0,0,0,0.6);
  backdrop-filter: blur(10px);
  max-height:90vh; overflow-y:auto;
}

h2 { margin:0 0 10px; font-size:18px; color:#fff; letter-spacing:-0.5px; }
label { font-size:12px; font-weight:600; color:var(--muted); margin-bottom:6px; text-transform:uppercase; display:block; }

select, input[type=range] {
  width:100%; padding:10px; border-radius:8px; margin-bottom:10px;
  background:#1e293b; color:#fff; border:1px solid var(--border); font-size:14px;
}

#dataDisplay { margin-top:15px; font-size:14px; line-height:1.6; }
.info-section-title {
  color:var(--accent); font-weight:700;
  text-transform:uppercase; margin-top:12px; margin-bottom:4px;
  border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:3px;
}
.check-item { color:var(--accent); font-weight:700; margin-left:4px; }
.check-text { color:#fff; font-weight:500; margin-left:4px; }
</style>

<script type="importmap">
{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
</script>
</head>

<body>
<canvas id="c"></canvas>

<div id="uiPanel">
  <h2>Clinical Examiner</h2>

  <label>Visualization Mode</label>
  <select id="modeSel">
    <option value="derm">Dermatomes (Sensory Map)</option>
    <option value="myo">Myotomes (Motor Map)</option>
    <option value="none">Model Only</option>
  </select>

  <label>Overlay Opacity</label>
  <input id="opacitySel" type="range" min="0" max="1" step="0.05" value="0.85" />

  <div id="dataDisplay">
    <div style="padding:20px; text-align:center; color:#64748b; border:2px dashed #334155; border-radius:8px;">
      Hover or click a colored region on the body to view clinical data.
    </div>
  </div>
</div>

<script type="module">
import * as THREE from 'three';
import {OrbitControls} from 'three/addons/controls/OrbitControls.js';
import {GLTFLoader} from 'three/addons/loaders/GLTFLoader.js';
import {DRACOLoader} from 'three/addons/loaders/DRACOLoader.js';

/* ------------------------------------------------------------------
   MULTI-AREA SENSORY DISTRIBUTION (✓ BLUE)
------------------------------------------------------------------ */
const SENSORY = {
  "C2": ["Posterior skull", "Occipital region"],
  "C3": ["Side of neck", "Submandibular region"],
  "C4": ["Top of shoulders", "Lower neck"],
  "C5": ["Lateral upper arm (deltoid patch)"],
  "C6": ["Lateral forearm", "Thumb", "Index finger"],
  "C7": ["Posterior forearm", "Middle finger"],
  "C8": ["Medial forearm", "Ring finger", "Pinky finger"],
  "T1": ["Medial upper arm", "Axilla"],
  "T4": ["Nipple line dermatome band"],
  "T10":["Umbilicus dermatome band"],
  "L1": ["Inguinal region", "Upper anterior thigh"],
  "L2": ["Mid anterior thigh"],
  "L3": ["Anterior knee", "Distal thigh"],
  "L4": ["Medial shin", "Medial ankle"],
  "L5": ["Lateral shin", "Dorsum of foot", "Great toe"],
  "S1": ["Lateral foot", "Heel", "Posterolateral calf"],
  "S2": ["Posterior thigh"],
  "S3": ["Buttocks", "Perineum"]
};

/* ------------------------------------------------------------------
   MOTOR DATABASE (unchanged)
------------------------------------------------------------------ */
const MYO = {
  "C2": { muscle:"SCM", action:"Neck Flexion/Rotation" },
  "C3": { muscle:"Upper Trapezius", action:"Neck Lateral Flexion" },
  "C4": { muscle:"Levator Scapulae", action:"Shoulder Elevation" },
  "C5": { muscle:"Deltoid", action:"Shoulder Abduction" },
  "C6": { muscle:"Wrist Extensors", action:"Wrist Extension" },
  "C7": { muscle:"Triceps", action:"Elbow Extension" },
  "C8": { muscle:"Finger Flexors", action:"Finger Flexion" },
  "T1": { muscle:"Interossei", action:"Finger Abduction" },
  "T4": { muscle:"Intercostals", action:"Thoracic Expansion" },
  "T10":{ muscle:"Abdominals", action:"Trunk Flexion" },
  "L1": { muscle:"Iliopsoas (minor)", action:"Hip Flexion" },
  "L2": { muscle:"Iliopsoas", action:"Hip Flexion" },
  "L3": { muscle:"Quadriceps", action:"Knee Extension" },
  "L4": { muscle:"Tibialis Anterior", action:"Dorsiflexion" },
  "L5": { muscle:"EHL", action:"Great Toe Extension" },
  "S1": { muscle:"Gastroc/Soleus", action:"Plantarflexion" },
  "S2": { muscle:"Hamstrings", action:"Knee Flexion" },
  "S3": { muscle:"Pelvic Floor", action:"Sphincter Control" }
};

/* ------------------------------------------------------------------
   SCENE + LOADER
------------------------------------------------------------------ */
const canvas = document.getElementById("c");
const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,2));

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0f172a);

const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 100);
camera.position.set(0,1.5,3);

const controls = new OrbitControls(camera,renderer.domElement);
controls.enableDamping = true;

const loader = new GLTFLoader();
const draco = new DRACOLoader();
draco.setDecoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/");
loader.setDRACOLoader(draco);

function getModelURL(){
  const q = new URL(location.href).searchParams.get("model");
  return (q && /^https?:\/\//.test(q)) ? q : "../assets/Roma_ROMetrics.glb";
}

let regionMeshes={}, originalColors={};

/* ------------------------------------------------------------------
   LOAD MODEL + BUILD DERMATOMES
------------------------------------------------------------------ */
loader.load(getModelURL(), gltf => {
  const model = gltf.scene;
  scene.add(model);

  const box = new THREE.Box3().setFromObject(model);
  const center = box.getCenter(new THREE.Vector3());
  controls.target.copy(center);

  let body=null;
  model.traverse(o=>{
    if(o.isSkinnedMesh && (!body || o.geometry.attributes.position.count > body.geometry.attributes.position.count))
      body=o;
  });

  if(body) buildDermatomes(body,center);
});

/* ------------------------------------------------------------------
   BUILD MAP
------------------------------------------------------------------ */
function buildDermatomes(mesh, center){
  const pos=mesh.geometry.attributes.position;
  const skinIdx=mesh.geometry.attributes.skinIndex;
  const skinWt=mesh.geometry.attributes.skinWeight;
  const bones=mesh.skeleton.bones;

  const buckets={};
  const P=new THREE.Vector3();

  for(let i=0;i<pos.count;i++){
    P.fromBufferAttribute(pos,i).applyMatrix4(mesh.matrixWorld);

    const isRight = P.x > center.x;

    let bestW=0, bID=0;
    for(let k=0;k<4;k++){
      const w=skinWt.getComponent(i,k);
      if(w>bestW){ bestW=w; bID=skinIdx.getComponent(i,k); }
    }

    const b=bones[bID].name.toLowerCase();

    let level=null;
    if(b.includes("head")) level="C2";
    else if(b.includes("neck")) level="C3";
    else if(b.includes("clav")) level="C4";
    else if(b.includes("upperarm")) level="C5";
    else if(b.includes("forearm")) level="C6";
    else if(b.includes("hand")){
      if(P.z>center.z) level="C6"; else level="C7";
    }
    else if(b.includes("spine")){
      if(P.y>center.y+0.15) level="T4"; else level="T10";
    }
    else if(b.includes("pelvis")) level = P.z>center.z?"L1":"S3";
    else if(b.includes("thigh")) level = P.z>center.z?"L2":"S2";
    else if(b.includes("calf")) level="L4";
    else if(b.includes("foot")){
      if(P.z>center.z) level="L5"; else level="S1";
    }

    if(level){
      const key=level+(isRight?"-R":"-L");
      if(!buckets[key]) buckets[key]=[];
      buckets[key].push(i);
    }
  }

  for(const key in buckets){
    const level=key.split("-")[0];
    const pts=[], temp=new THREE.Vector3();

    for(const idx of buckets[key]){
      temp.fromBufferAttribute(mesh.geometry.attributes.position,idx).applyMatrix4(mesh.matrixWorld);
      pts.push(temp.x,temp.y,temp.z);
    }

    const geo=new THREE.BufferGeometry();
    geo.setAttribute("position",new THREE.Float32BufferAttribute(pts,3));

    const col = 0xffffff;
    const mat=new THREE.PointsMaterial({
      color: col, size:0.015, transparent:true, opacity:0.85,
      depthTest:false, depthWrite:false
    });

    const cloud=new THREE.Points(geo,mat);
    cloud.userData={level,id:key};
    cloud.renderOrder=999;

    scene.add(cloud);
    regionMeshes[key]=cloud;
    originalColors[key]=col;
  }
}

/* ------------------------------------------------------------------
   INTERACTION
------------------------------------------------------------------ */
const ray=new THREE.Raycaster();
ray.params.Points.threshold=0.05;
const mouse=new THREE.Vector2();
let hover=null;

window.addEventListener("mousemove",e=>{
  mouse.x=(e.clientX/innerWidth)*2-1;
  mouse.y=-(e.clientY/innerHeight)*2+1;

  ray.setFromCamera(mouse,camera);
  const hits=ray.intersectObjects(Object.values(regionMeshes));

  if(hits.length){
    const o=hits[0].object;
    if(hover!==o){
      if(hover) hover.material.color.setHex(originalColors[hover.userData.id]);
      hover=o;
      hover.material.color.setHex(0x38bdf8);
    }
  } else {
    if(hover){
      hover.material.color.setHex(originalColors[hover.userData.id]);
      hover=null;
    }
  }
});

window.addEventListener("click",()=>{
  if(hover) showPanel(hover.userData);
});

/* ------------------------------------------------------------------
   PANEL
------------------------------------------------------------------ */
function showPanel(d){
  const ui=document.getElementById("dataDisplay");
  const mode=document.getElementById("modeSel").value;
  const side=d.id.includes("-R")?"Right":"Left";
  const L=d.level;

  let html = `
    <div class="info-section-title">${L} Dermatome (${side})</div>
  `;

  if(mode==="derm"){
    html += `<div class="info-section-title">Sensory Distribution</div>`;
    (SENSORY[L]||["—"]).forEach(area=>{
      html+=`<div><span class="check-item">✓</span><span class="check-text">${area}</span></div>`;
    });
  } else {
    html += `
      <div class="info-section-title">Motor Function</div>
      <div class="check-text">${MYO[L]?.muscle||"—"}</div>
      <div class="info-section-title">Action</div>
      <div class="check-text">${MYO[L]?.action||"—"}</div>
    `;
  }

  ui.innerHTML=html;
}

/* ------------------------------------------------------------------
   VISIBILITY
------------------------------------------------------------------ */
const modeSel=document.getElementById("modeSel");
const opSel=document.getElementById("opacitySel");

function updateVis(){
  const mode=modeSel.value;
  const op=parseFloat(opSel.value);

  for(const m of Object.values(regionMeshes)){
    m.material.opacity=op;

    if(mode==="none") m.visible=false;
    else if(mode==="derm") m.visible=true;
    else if(mode==="myo"){
      m.visible = !m.userData.level.startsWith("T") || m.userData.level==="T1";
    }
  }
}

modeSel.addEventListener("change",updateVis);
opSel.addEventListener("input",updateVis);

/* LOOP */
function loop(){
  requestAnimationFrame(loop);
  controls.update();
  renderer.render(scene,camera);
}
loop();

window.addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
