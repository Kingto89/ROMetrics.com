<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ROMetrics — Manual Muscle Testing (MMT)</title>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

<style>
:root {
  --bg:#0b1220;--panel:#0f172a;--line:#1f2937;
  --ctrl:#1e293b;--text:#e2e8f0;--muted:#94a3b8;
}
html,body {
  margin:0;height:100%;background:var(--bg);
  color:var(--text);overflow:hidden;
  font-family:Inter,system-ui,sans-serif;
}
canvas {
  position:fixed;inset:0;width:100%;height:100%;
  display:block;background:var(--bg);
}
.panel {
  position:fixed;right:24px;top:24px;width:340px;
  background:var(--panel);border:1px solid var(--line);
  border-radius:14px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.45);
}
.panel h2 {
  margin:0 0 10px;font-weight:700;color:#fff;font-size:18px;
}
label{display:block;margin-top:8px;font-size:12px;color:var(--muted)}
select,button {
  width:100%;margin-top:4px;padding:10px 12px;border-radius:10px;
  border:1px solid var(--line);background:var(--ctrl);
  color:#fff;font-size:14px;
}
button {cursor:pointer;font-weight:600;}
#status {
  text-align:center;margin-top:10px;font-size:18px;font-weight:700;
}
</style>
</head>

<body>
<canvas id="c"></canvas>

<div class="panel">
  <h2>ROMetrics — MMT</h2>

  <label>Test Level</label>
  <select id="testLevel">
    <option value="3-5" selected>Level 3–5</option>
    <option value="0-2">Level 0–2</option>
  </select>

  <label>Action</label>
  <select id="actionSel" size="10"></select>

  <button id="startBtn">Start Test</button>
  <div id="status"></div>
</div>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "three/addons/controls/OrbitControls.js";
import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
import { DRACOLoader } from "three/addons/loaders/DRACOLoader.js";
import { MeshoptDecoder } from "three/addons/libs/meshopt_decoder.module.js";

/* ========== Scene Setup ========== */
const renderer=new THREE.WebGLRenderer({canvas:document.getElementById("c"),antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(devicePixelRatio);
renderer.outputColorSpace=THREE.SRGBColorSpace;
renderer.shadowMap.enabled=true;

const scene=new THREE.Scene();
scene.background=new THREE.Color(0x0b1220);

const camera=new THREE.PerspectiveCamera(45,innerWidth/innerHeight,0.01,100);
camera.position.set(1.6,1.6,3.2);

const controls=new OrbitControls(camera,renderer.domElement);
controls.target.set(0,1.2,0);
controls.enableDamping=true;
controls.update();

scene.add(new THREE.HemisphereLight(0xffffff,0x444455,0.8));
const dir=new THREE.DirectionalLight(0xffffff,1.2);
dir.position.set(2.5,4,2.5);
dir.castShadow=true;
scene.add(dir);

const ground=new THREE.Mesh(
  new THREE.PlaneGeometry(20,20),
  new THREE.ShadowMaterial({opacity:0.3})
);
ground.rotation.x=-Math.PI/2;
ground.receiveShadow=true;
scene.add(ground);

window.addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});

/* ========== Dynamic Model Loader ========== */
function pickModelUrl(){
  const u=new URL(location.href);
  const q=u.searchParams.get("model");
  if(q && /^https?:\/\//i.test(q)) return q;
  if(q && q.trim()) return new URL(q,location.href).href;
  return "../assets/Roma_ROMetrics.glb";
}
let MODEL_URL=pickModelUrl();
let model=null,skeleton=[];

const loader=new GLTFLoader();
loader.setMeshoptDecoder(MeshoptDecoder);
const draco=new DRACOLoader();
draco.setDecoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/");
loader.setDRACOLoader(draco);

loader.load(MODEL_URL,gltf=>{
  model=gltf.scene;
  model.traverse(o=>{
    if(o.isSkinnedMesh && o.skeleton) skeleton=o.skeleton.bones;
    if(o.isMesh){o.castShadow=true;o.receiveShadow=true;}
  });
  scene.add(model);
  const box=new THREE.Box3().setFromObject(model);
  model.position.y-=box.min.y;
  console.log("✅ Model loaded from",MODEL_URL);
},xhr=>{
  console.log("Loading",Math.round(xhr.loaded/xhr.total*100)+"%");
},err=>{
  console.error("❌ Model load failed",err);
});

/* ========== Utility Functions ========== */
function resolveBind(name){
  return skeleton.find(b=>b.name===name)||null;
}
function resetAll(){
  skeleton.forEach(b=>{
    b.rotation.set(0,0,0);
    if(b.position)b.position.set(0,0,0);
  });
}
function animateToPose(boneName,axis,deg,duration=1000){
  const bone=resolveBind(boneName);
  if(!bone)return;
  const start=bone.rotation[axis];
  const end=THREE.MathUtils.degToRad(deg);
  const startTime=performance.now();
  function step(now){
    const t=Math.min((now-startTime)/duration,1);
    bone.rotation[axis]=THREE.MathUtils.lerp(start,end,t);
    if(t<1)requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* ========== Action Map ========== */
const ACTIONS={
  "shoulder-flexion":{bone:"upperarm_r",axis:"x",deg:90,midpoint:45},
  "shoulder-extension":{bone:"upperarm_r",axis:"x",deg:-60,midpoint:-30},
  "shoulder-abduction":{bone:"upperarm_r",axis:"z",deg:90,midpoint:45},
  "elbow-flexion":{bone:"lowerarm_r",axis:"x",deg:-145,midpoint:-70},
  "elbow-extension":{bone:"lowerarm_r",axis:"x",deg:0,midpoint:-10},
  "hip-flexion":{bone:"thigh_r",axis:"x",deg:120,midpoint:60},
  "hip-extension":{bone:"thigh_r",axis:"x",deg:-30,midpoint:-15},
  "knee-flexion":{bone:"calf_r",axis:"x",deg:-135,midpoint:-70},
  "ankle-dorsiflexion":{bone:"foot_r",axis:"x",deg:20,midpoint:10},
  "ankle-plantarflexion":{bone:"foot_r",axis:"x",deg:-50,midpoint:-25}
};

/* ========== Action Execution ========== */
function performAction(key,level="3-5"){
  if(!ACTIONS[key])return;
  const act=ACTIONS[key];
  const deg=(level==="3-5")?act.midpoint:0;
  animateToPose(act.bone,act.axis,deg,1200);
}

/* ========== UI Elements ========== */
const testSel=document.getElementById("actionSel");
const testLevel=document.getElementById("testLevel");
const startBtn=document.getElementById("startBtn");
const status=document.getElementById("status");

(async function populateTests(){
  const res=await fetch("https://raw.githubusercontent.com/Kingto89/ROMetrics/main/mmt/rometrics_mmt_library.md");
  const text=await res.text();
  const matches=[...text.matchAll(/^###\s+(.*?)$/gm)];
  for(const m of matches){
    const opt=document.createElement("option");
    opt.value=m[1].toLowerCase().replace(/[^a-z0-9]+/g,"-");
    opt.textContent=m[1];
    testSel.appendChild(opt);
  }
})();

/* ========== Test Flow ========== */
let selectedTest=null,holdTimers=[];
testSel.addEventListener("change",()=>{selectedTest=testSel.value;});

function beginTest(){
  if(!selectedTest)return;
  const lvl=testLevel.value;
  resetAll();
  performAction(selectedTest,lvl);
  status.textContent="3";
  holdTimers=[
    setTimeout(()=>status.textContent="4",3000),
    setTimeout(()=>status.textContent="5",6000),
    setTimeout(()=>status.textContent="Test Complete",9000)
  ];
}
function endTest(){
  holdTimers.forEach(clearTimeout);
  holdTimers=[];
  setTimeout(()=>{resetAll();status.textContent="";},1000);
}
startBtn.addEventListener("pointerdown",beginTest);
startBtn.addEventListener("pointerup",endTest);

/* ========== Render Loop ========== */
function render(){
  requestAnimationFrame(render);
  controls.update();
  renderer.render(scene,camera);
}
render();
</script>
</body>
</html>
