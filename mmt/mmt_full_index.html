<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ROMetrics — Manual Muscle Testing (MMT)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b0f14;--card:rgba(255,255,255,.88);--ink:#0f172a;}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:#111}
.bg{position:fixed;inset:0;background:#0b0f14 url('./assets/bg_pt_office.jpg') center/cover no-repeat;filter:saturate(1.05) brightness(.9)}
.overlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(11,15,20,.25),rgba(11,15,20,.6))}
.wrap{position:relative;display:grid;grid-template-columns:1fr auto;gap:16px;max-width:1200px;margin:32px auto;padding:12px}
.card{backdrop-filter:blur(10px);background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
.header{padding:14px 16px;border-bottom:1px solid rgba(0,0,0,.06);display:flex;align-items:center;justify-content:space-between}
.title{font-weight:700}
.muted{color:#1f2937;opacity:.75}
.panel{padding:14px 16px}
.stage{height:min(65vh,520px);display:flex;align-items:center;justify-content:center}
#stageModel{width:100%;height:100%}
.controls{width:280px}
.controls .panel{display:grid;gap:10px;position:relative;}
.select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,.08);font-size:14px;background:#fff}
.small{font-size:12px;color:#475569}
.hand-overlay{position:absolute;width:80px;z-index:10;cursor:grab;touch-action:none;user-select:none;}
#handL{top:80%;left:10%}
#handR{top:80%;right:10%}
#testCountdown{font-weight:600;padding-left:10px;}
.row{display:flex;align-items:center;gap:10px;}
</style>
<script type="module" src="https://unpkg.com/@google/model-viewer@3.5.0/dist/model-viewer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<div class="bg"></div><div class="overlay"></div>
<main class="wrap">
  <section class="card stage" aria-label="3D stage">
    <model-viewer id="stageModel" src="./assets/Roma_ROMetrics.glb" exposure="1" camera-controls auto-rotate reveal="interaction"></model-viewer>
  </section>
  <aside class="card controls" aria-label="MMT controls">
    <div class="header">
      <div><div class="title">ROMetrics — MMT</div>
      <div class="muted small">Select test level & muscle</div></div>
    </div>
    <div class="panel">
      <select id="testLevel" class="select">
        <option value="3-5">Level 3–5</option>
        <option value="0-2">Level 0–2</option>
      </select>
      <select id="test" class="select" size="10"></select>
      <div class="row">
        <button id="startBtn">Start Test</button>
        <span id="testCountdown"></span>
      </div>
    </div>
  </aside>
</main>
<img id="handL" class="hand-overlay" src="./assets/hand_L.png" />
<img id="handR" class="hand-overlay" src="./assets/hand_R.png" />
<script>
const stageModel = document.getElementById('stageModel');
const testList = document.getElementById('test');
const testLevel = document.getElementById('testLevel');
const startBtn = document.getElementById('startBtn');
const countdown = document.getElementById('testCountdown');
let holdTimers = [], selectedTest = null;
const handL = document.getElementById("handL"), handR = document.getElementById("handR");
const ROM_POSITIONS = {
  "elbow-flexion": { midpoint: "elbowFlexMid", handL: [200,100], handR: [300,200] },
  "shoulder-abduction": { midpoint: "shoulderAbductMid", handL: [180,90], handR: [250,220] }
};
function makeDraggable(el){
  el.addEventListener("pointerdown",e=>el.setPointerCapture(e.pointerId));
  el.addEventListener("pointermove",e=>{
    if(el.hasPointerCapture(e.pointerId)){
      el.style.left=(el.offsetLeft+e.movementX)+"px";
      el.style.top=(el.offsetTop+e.movementY)+"px";
    }
  });
}
makeDraggable(handL); makeDraggable(handR);
function isNear(el, [x,y], r=100){
  const rect = el.getBoundingClientRect(), cx=rect.left+rect.width/2, cy=rect.top+rect.height/2;
  return Math.hypot(cx - x, cy - y) < r;
}
function validateHands(){
  const pos = ROM_POSITIONS[selectedTest];
  if(!pos) return false;
  return isNear(handL,pos.handL)&&isNear(handR,pos.handR);
}
function updateBtnState(){
  startBtn.disabled = !(selectedTest && validateHands());
}
testList.addEventListener('change',()=>{
  selectedTest = testList.value;
  const level = testLevel.value;
  updateBtnState();
  if(level==='3-5'){
    const mid = ROM_POSITIONS[selectedTest]?.midpoint;
    if(mid) console.log("Pose model using midpoint:", mid);
  }
});
testLevel.addEventListener('change',updateBtnState);
['pointerup','pointermove'].forEach(evt=>{
  handL.addEventListener(evt, updateBtnState);
  handR.addEventListener(evt, updateBtnState);
});
startBtn.addEventListener('pointerdown',()=>{
  countdown.textContent='3';
  holdTimers.push(setTimeout(()=>countdown.textContent='4',3000));
  holdTimers.push(setTimeout(()=>countdown.textContent='5',6000));
  holdTimers.push(setTimeout(()=>countdown.textContent='Test Complete',9000));
});
startBtn.addEventListener('pointerup',()=>{
  if(countdown.textContent!=="Test Complete") countdown.textContent='';
  holdTimers.forEach(clearTimeout); holdTimers=[];
});
(async function populateTests(){
  const res = await fetch("https://raw.githubusercontent.com/Kingto89/ROMetrics/main/mmt/rometrics_mmt_library.md");
  const text = await res.text();
  const matches = [...text.matchAll(/^###\s+(.*?)$/gm)];
  for(const m of matches){
    const opt = document.createElement('option');
    opt.value = m[1].toLowerCase().replace(/[^a-z0-9]+/g,'-');
    opt.textContent = m[1];
    testList.appendChild(opt);
  }
})();
</script>
</body>
</html>
