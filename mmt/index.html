<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MMT Trainer â€” Side Notes</title>

<script type="importmap">
{
Â  "imports": {
Â  Â  "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
Â  Â  "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
Â  }
}
</script>

<style>
:root{
Â  --bg:#f1f5f9; --panel:#ffffff; --line:#cbd5e1; --ctrl:#e2e8f0;
Â  --text:#0f172a; --muted:#64748b; --primary:#0d9488; --accent:#facc15;
}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);overflow:hidden;font-family:system-ui,Segoe UI,Roboto}
canvas{position:fixed;inset:0;width:100%;height:100%;display:block}

.panel{position:fixed;left:25px;top:12px;width:380px;max-height:92vh;z-index:100;background:var(--panel);
Â  border:1px solid var(--line);border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,.15);display:flex;flex-direction:column;overflow:hidden}
.dragbar{cursor:move;background:var(--ctrl);border-bottom:1px solid var(--line);padding:8px 12px;font-weight:700;display:flex;align-items:center;gap:8px}
.dragbar .hint{margin-left:auto;font-size:12px;color:var(--muted)}
.content{padding:12px;overflow:auto}
label{display:block;font-size:12px;margin-top:8px;color:var(--muted)}
select,button,input[type=range]{width:100%;margin:6px 0 8px 0;padding:8px 10px;border-radius:10px;background:var(--ctrl);border:1px solid var(--line);color:var(--text)}
.row{display:flex;gap:8px}.row>button,.row>select{flex:1}
.mini{padding:6px 10px;border-radius:8px;background:var(--ctrl);border:1px solid var(--line)}
.lockOn{background:#0b3a1f;border-color:#16a34a;color:#fff}
#msg{position:fixed;bottom:10px;left:12px;background:var(--panel);border:1px solid var(--line);border-radius:8px;padding:6px 10px;font-size:12px;z-index:25;color:var(--text)}
#log{display:none;background:var(--ctrl);border:1px solid var(--line);min-height:90px;max-height:130px;overflow:auto;border-radius:8px;padding:8px;font-size:12px;white-space:pre-wrap;color:var(--text)}

/* Resistance button */
#testButton{position:relative;padding:12px 10px;font-weight:700;overflow:hidden;touch-action:none;background:var(--ctrl)}
#resistanceFill{position:absolute;top:0;left:0;width:0;height:100%;background-color:var(--accent);transition:width .1s linear;z-index:1}
#resistanceText{position:relative;z-index:2}
#instructionText{font-size:12px;color:var(--muted);text-align:center;margin:4px 0 12px 0;display:none}

/* Right-side note panel (smaller) */
#notePanel{position:fixed;top:16px;right:16px;width:min(420px,46vw);max-height:70vh;display:none;z-index:140;
Â  background:#e2e8f0; /* light slate */
Â  border:1px solid var(--line);border-radius:12px;box-shadow:0 12px 32px rgba(0,0,0,.25);
Â  display:flex;flex-direction:column;overflow:hidden}
.note-head{display:flex;align-items:center;gap:8px;padding:10px 12px;background:#dbe4ee;border-bottom:1px solid var(--line)}
.note-head h3{margin:0;font-size:16px;font-weight:800;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.note-tabs{display:flex;gap:8px}
.note-tabs button{padding:6px 10px;border-radius:8px;border:1px solid var(--line);background:#fff}
.note-tabs button.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.note-body{padding:12px;overflow:auto;background:#fff}
.note-close{border-radius:8px;border:1px solid var(--line);padding:6px 10px;background:#fff}
@media (max-width: 720px){
Â  #notePanel{right:8px;left:8px;width:auto;max-height:60vh}
}
.hide{display:none !important;}
</style>
</head>
<body>

<div class="panel" id="panel">
Â  <div class="dragbar" id="dragbar">ğŸ’ª MMT Trainer <span class="hint">drag me</span></div>
Â  <div class="content">

Â  Â  <label>MMT Test & Muscle</label>
Â  Â  <select id="actionSel">
Â  Â  Â  <option value="">(Select a test to beginâ€¦)</option>

Â  Â  Â  <optgroup label="Cervical & Capital">
Â  <option value="Capital_Extension">Capital Extension (Rectus Capitis Posterior Major, Obliquus Capitis Superior, Splenius Capitis)</option>
Â  <option value="Cervical_Extension">Cervical Extension (Semispinalis Cervicis, Splenius Cervicis, Longissimus Cervicis)</option>
Â  <option value="Capital_Flexion">Capital Flexion â€” Chin Tuck (Longus Capitis, Rectus Capitis Anterior, Anterior Scalene)</option>
Â  <option value="Cervical_Flexion">Cervical Flexion (Sternocleidomastoid, Longus Colli, Anterior Scalene)</option>
Â  <option value="Single_SCM">Single SCM â€” Anterolateral Flexion (SCM, Longus Capitis, Longus Colli)</option>
Â  <option value="Cervical_Rotation">Cervical Rotation (SCMâ€”contralateral; Splenius Capitisâ€”ipsilateral; Longissimus Capitisâ€”ipsilateral)</option>
</optgroup>


Â  Â  Â  <optgroup label="Scapula">
Â  Â  Â  Â  <option value="Serratus_Anterior">Scapular Abduction & Upward Rotation (Serratus Anterior)</option>
Â  Â  Â  Â  <option value="Upper_Trapezius">Scapular Elevation (Upper Trapezius, Levator Scapulae)</option>
Â  Â  Â  Â  <option value="Middle_Trapezius">Scapular Adduction / Retraction (Middle Trapezius)</option>
Â  Â  Â  Â  <option value="Rhomboids">Scapular Adduction + Downward Rotation (Rhomboids)</option>
Â  Â  Â  Â  <option value="Latissimus_Dorsi">Latissimus Dorsi (shoulder depression/extension pattern)</option>
Â  Â  Â  </optgroup>

Â  Â  Â  <optgroup label="Shoulder">
Â  Â  Â  Â  <option value="Anterior_Deltoid">Shoulder Flexion (Anterior Deltoid, Coracobrachialis)</option>
Â  Â  Â  Â  <option value="Posterior_Deltoid">Shoulder Extension (Posterior Deltoid, Lat, Teres Major)</option>
Â  Â  Â  Â  <option value="Middle_Deltoid">Shoulder Abduction (Middle Deltoid, Supraspinatus)</option>
Â  Â  Â  Â  <option value="Infraspinatus">Shoulder External Rotation (Infraspinatus, Teres Minor)</option>
Â  Â  Â  Â  <option value="Subscapularis">Shoulder Internal Rotation (Subscapularis, Teres Major, Pec Major, Lat)</option>
Â  Â  Â  </optgroup>

Â  Â  Â  <optgroup label="Trunk & Pelvis - Grading Exception">
Â  <option value="Trunk_Ext_Lumbar">Trunk Extension â€” Lumbar (Erector Spinae)</option>
Â  <option value="Trunk_Ext_Thoracic">Trunk Extension â€” Thoracic (Erector Spinae)</option>
Â  <option value="Trunk_Flexion">Trunk Flexion â€” Rectus Abdominis</option>
Â  <option value="Trunk_Rotation">Trunk Rotation â€” External & Internal Obliques</option>
Â  <option value="Pelvic_Elevation">Pelvic Elevation (Hip Hike) â€” Quadratus Lumborum</option>
</optgroup>

Â  Â  Â Â 
Â  Â  Â  <optgroup label="Elbow">
Â  Â  Â  Â  <option value="Biceps_Brachii">Elbow Flexion â€” Biceps Brachii (supinated)</option>
Â  Â  Â  Â  <option value="Brachialis">Elbow Flexion â€” Brachialis (pronated)</option>
Â  Â  Â  Â  <option value="Brachioradialis">Elbow Flexion â€” Brachioradialis (neutral)</option>
Â  Â  Â  Â  <option value="Triceps_Brachii">Elbow Extension â€” Triceps Brachii</option>
Â  Â  Â  </optgroup>

Â  Â  Â  <optgroup label="Wrist">
Â  Â  Â  Â  <option value="ECRL">Wrist Extension â€” Extensor Carpi Radialis Longus (ECRL)</option>
Â  Â  Â  Â  <option value="ECRB">Wrist Extension â€” Extensor Carpi Radialis Brevis (ECRB)</option>
Â  Â  Â  Â  <option value="ECU">Wrist Extension â€” Extensor Carpi Ulnaris (ECU)</option>
Â  Â  Â  Â  <option value="FCR">Wrist Flexion â€” Flexor Carpi Radialis (FCR)</option>
Â  Â  Â  Â  <option value="FCU">Wrist Flexion â€” Flexor Carpi Ulnaris (FCU)</option>
Â  Â  Â  </optgroup>

Â  Â  Â  <optgroup label="Hip">
Â  Â  Â  Â  <option value="Iliopsoas">Hip Flexion (Iliopsoas)</option>
Â  Â  Â  Â  <option value="Glute_Max">Hip Extension (Glute Max, Hamstrings)</option>
Â  Â  Â  Â  <option value="Glute_Med">Hip Abduction (Glute Med, Glute Min)</option>
Â  Â  Â  Â  <option value="Hip_ER">Hip External Rotation</option>
Â  Â  Â  Â  <option value="Hip_IR">Hip Internal Rotation</option>
Â  Â  Â  </optgroup>

Â  Â  Â  <optgroup label="Knee">
Â  Â  Â  Â  <option value="Hamstrings">Knee Flexion (Hamstrings)</option>
Â  Â  Â  Â  <option value="Quadriceps">Knee Extension (Quadriceps)</option>
Â  Â  Â  </optgroup>

Â  Â  Â  <optgroup label="Ankle & Foot -Â  Grading Exception for Gastroc">
Â  Â  Â  Â  <option value="Tibialis_Anterior">Dorsiflexion + Inversion (Tibialis Anterior)</option>
Â  Â  Â  Â  <option value="Foot_Eversion_PF">Foot Eversion + Plantarflexion (Fibularis Longus, Fibularis Brevis)</option>
Â  Â  Â  Â  <option value="Ankle_Dorsiflexion">Ankle Dorsiflexion (Tibialis Anterior; EDL/EHL assist)</option>
Â  Â  Â  Â  Â <option value="Gastrocnemius">Plantar Flexion (Gastrocnemius, Soleus)</option>
Â  Â  Â  </optgroup>
Â  Â  </select>

Â  Â  <div class="row" style="margin-top:10px;">
Â  Â  Â  <button id="startTestBtn" class="mini">â–¶ï¸ Start Test (Grade 3 Position)</button>
Â  Â  Â  <button id="showMMT" class="mini">ğŸ“Œ MMT Placement</button>
Â  Â  </div>

<div class="row" style="align-items:center; margin-top:10px;">
Â  <div style="flex:1;">
Â  Â  <label>Test Grade Selection</label>
Â  Â  <select id="grade-main" name="grade-main">
Â  Â  Â  <option value="3">Grade 3 - 5 (Full ROM / Resistance: none, Mod, Max)</option>
Â  Â  Â  <option value="2">Grade 2 (Full ROM / Gravity Eliminated)</option>
Â  Â  Â  <option value="1">Grade 1 (Trace Contraction)</option>
Â  Â  Â  <option value="0">Grade 0 (No Contraction)</option>
Â  Â  </select>
Â  </div>

Â  <div style="flex:1;">
Â  Â  <label>Grading Exceptions</label>
Â  Â  <select id="GradingExceptions" name="GradingExceptions">
Â  Â  Â  <option value="5">Grade 5 (Full ROM / Maximum Resistance)</option>
Â  Â  Â  <option value="4">Grade 4 (Full ROM / Moderate Resistance)</option>
Â  Â  Â  <option value="3">Grade 3 (Full ROM / No Resistance)</option>
Â  Â  Â  <option value="2">Grade 2 (Full ROM / Gravity Eliminated)</option>
Â  Â  Â  <option value="1">Grade 1 (Trace Contraction)</option>
Â  Â  </select>
Â  </div>
</div>


Â  Â  <div class="row" style="margin-top:10px;">
Â  Â  Â  <button id="testButton" disabled>
Â  Â  Â  Â  <div id="resistanceFill"></div>
Â  Â  Â  Â  <span id="resistanceText">Hold to Apply Resistance (4/5)</span>
Â  Â  Â  </button>
Â  Â  </div>
Â  Â  <p id="instructionText">Hold for 1s (Grade 4), Hold for 2s (Grade 5).</p>

Â  Â  <label>Model Control</label>
Â  Â  <div class="row">
Â  Â  Â  <button id="lock3D" class="mini">ğŸ”“ 3D: Unlocked</button>
Â  Â  Â  <button id="zeroAll" class="mini" title="Reset everything to anatomic baseline">Zero All</button>
Â  Â  </div>

Â  Â  <pre id="log"></pre>
Â  </div>
</div>

<div id="msg">Loadingâ€¦</div>
<canvas id="c"></canvas>

<div id="notePanel" class="hide">
Â  <div class="note-head">
Â  Â  <h3 id="noteTitle">MMT Instructions</h3>
Â  Â  <div class="note-tabs">
Â  Â  Â  <button id="tabHigh" class="active">Grades 3â€“5</button>
Â  Â  Â  <button id="tabLow">Grades 0â€“2</button>
Â  Â  </div>
Â  Â  <button class="note-close" id="closeNote">Close âœ•</button>
Â  </div>
Â  <div class="note-body" id="noteBody">Loadingâ€¦</div>
</div>

<script>
Â  window.ROMETRICS_MODEL_URL = "https://kingto89.github.io/ROMetrics.com/assets/Roma_ROMetrics.glb";
</script>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "three/addons/controls/OrbitControls.js";
import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
import { DRACOLoader } from "three/addons/loaders/DRACOLoader.js";
import { KTX2Loader } from "three/addons/loaders/KTX2Loader.js";
import { MeshoptDecoder } from "three/addons/libs/meshopt_decoder.module.js";

/* ==== Error surfacing ==== */
window.addEventListener('error', (e) => {
Â  const m = document.getElementById("msg");
Â  if (m) m.textContent = `âš ï¸ ${e.message}`;
});

/* ==== UI refs ==== */
const canvas = document.getElementById("c");
const logEl = document.getElementById("log");
const log = (t) => { logEl.textContent += t + "\\n"; logEl.scrollTop = logEl.scrollHeight; };

const actionSel = document.getElementById("actionSel");
const startTestBtn = document.getElementById("startTestBtn");
const showMMT = document.getElementById("showMMT");

const testButton = document.getElementById("testButton");
const resistanceFill = document.getElementById("resistanceFill");
const resistanceText = document.getElementById("resistanceText");
const instructionText = document.getElementById("instructionText");
const gradeMain = document.getElementById("grade-main");

/* ==== THREE setup ==== */
const renderer = new THREE.WebGLRenderer({ canvas, antialias:true });
renderer.setPixelRatio(devicePixelRatio);
renderer.setSize(innerWidth, innerHeight);
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;

const scene = new THREE.Scene();
scene.background = new THREE.Color(0xf1f5f9);

const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.01, 100);
camera.position.set(1.6,1.6,3.2);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true; controls.dampingFactor = .08;
controls.minDistance=.6; controls.maxDistance=6;
controls.target.set(0,1.1,0);

scene.add(new THREE.HemisphereLight(0xffffff, 0x333344, 0.7));
const key = new THREE.DirectionalLight(0xffffff, 1.2);
key.position.set(2.5,4,2.5);
key.castShadow = true;
key.shadow.mapSize.set(2048,2048);
key.shadow.camera.near=0.1; key.shadow.camera.far=15;
key.shadow.camera.left=-4; key.shadow.camera.right=4;
key.shadow.camera.top=4; key.shadow.camera.bottom=-4;
scene.add(key);

const ground = new THREE.Mesh(new THREE.PlaneGeometry(20,20), new THREE.ShadowMaterial({ opacity:.45 }));
ground.rotation.x = -Math.PI/2;
ground.receiveShadow = true;
scene.add(ground);

/* ==== Loader ==== */
const loader = new GLTFLoader();
loader.setMeshoptDecoder(MeshoptDecoder);
const draco = new DRACOLoader(); draco.setDecoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/"); loader.setDRACOLoader(draco);
const ktx2Â  = new KTX2Loader();Â  ktx2.setTranscoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/basis/"); ktx2.detectSupport(renderer); loader.setKTX2Loader(ktx2);

let model=null, skeleton=null;
const initialBoneRot = new Map();

function groundSnap() {
Â  if (!model) return;
Â  const box = new THREE.Box3().setFromObject(model);
Â  const minY = box.min.y;
Â  if (isFinite(minY)) model.position.y -= minY;
}

const MODEL_CANDIDATES = [
Â  window.ROMETRICS_MODEL_URL,
Â  "assets/Roma_ROMetrics.glb",
Â  new URL("assets/Roma_ROMetrics.glb", document.baseURI).href
].filter(Boolean);

function tryNextModelUrl(index, onDone){
Â  if(index >= MODEL_CANDIDATES.length){
Â  Â  onDone(new Error("All model URL fallbacks failed."));
Â  Â  return;
Â  }
Â  const url = MODEL_CANDIDATES[index];
Â  log("Loading model from: " + url);
Â  loader.load(
Â  Â  url,
Â  Â  (gltf)=> onDone(null, gltf),
Â  Â  (xhr)=>{
Â  Â  Â  const pct = xhr.lengthComputable ? Math.min(100, Math.round(100*xhr.loaded/xhr.total)) : null;
Â  Â  Â  document.getElementById("msg").textContent = pct!==null ? `Loading ${pct}%` : "Loadingâ€¦";
Â  Â  },
Â  Â  ()=> tryNextModelUrl(index+1, onDone)
Â  );
}

function loadModel(){
Â  tryNextModelUrl(0, (err, gltf)=>{
Â  Â  if (err){
Â  Â  Â  document.getElementById("msg").textContent = `âš ï¸ Load error: ${err.message}`;
Â  Â  Â  log("All fallbacks failed.");
Â  Â  Â  return;
Â  Â  }
Â  Â  model = gltf.scene;
Â  Â  model.traverse(o=>{
Â  Â  Â  if (o.isMesh){ o.castShadow=true; o.receiveShadow=true; }
Â  Â  Â  if (o.isSkinnedMesh && !skeleton) skeleton = o.skeleton;
Â  Â  });
Â  Â  scene.add(model);
Â  Â  groundSnap();
Â  Â  document.getElementById("msg").textContent = "âœ… Model loaded";

Â  Â  if (skeleton){
Â  Â  Â  skeleton.bones.forEach(b => initialBoneRot.set(b, b.quaternion.clone()));
Â  Â  }
Â  });
}
loadModel();

let boneMap = {
Â  thigh_L: null,
Â  thigh_R: null,
Â  calf_L: null,
Â  calf_R: null,
};

// New function to find and store the key bones
function cacheKeyBones() {
Â  if (!skeleton) return;
Â  skeleton.bones.forEach(b => {
Â  Â  if (b.name === "thigh_L") boneMap.thigh_L = b;
Â  Â  if (b.name === "thigh_R") boneMap.thigh_R = b;
Â  Â  if (b.name === "calf_L")Â  boneMap.calf_LÂ  = b;
Â  Â  if (b.name === "calf_R")Â  boneMap.calf_RÂ  = b;
Â  });
Â  log("Key bones cached for posing.");
}

/* ===== MMT â†’ AUTOACTION MAP (INCORPORATED FIX) ===== */
const MMT_TO_AUTO = {
    /* Cervical & Capital */
    Capital_Extension: "cerv_fe",
    Cervical_Extension: "cerv_fe",
    Capital_Flexion: "cerv_fe",
    Cervical_Flexion: "cerv_fe",
    Single_SCM: "cerv_fe", 
    Cervical_Rotation: "cerv_rot",
    
    /* Scapula - Use Right arm movement as proxy for demonstration */
    Upper_Trapezius: "clavicle_R", 
    Middle_Trapezius: "scap_lr", 
    Rhomboids: "scap_lr", 
    Serratus_Anterior: "scap_lr", 

    /* Shoulder - Right side for test motion */
    Anterior_Deltoid: "sh_fe_r", 
    Posterior_Deltoid: "sh_fe_r", 
    Middle_Deltoid: "sh_aa_r", 
    Infraspinatus: "sh_irer_r", 
    Subscapularis: "sh_irer_r", 
    
    /* Trunk & Pelvis */
    Trunk_Ext_Lumbar: "trunk_fe",
    Trunk_Ext_Thoracic: "trunk_fe",
    Trunk_Flexion: "trunk_fe",
    Trunk_Rotation: "trunk_rot",
    Pelvic_Elevation: "pelvic_hike",
    
    /* Elbow - Right side for test motion */
    Biceps_Brachii: "el_fe_r", 
    Brachialis: "el_fe_r", 
    Brachioradialis: "el_fe_r", 
    Triceps_Brachii: "el_fe_r", 
    
    /* Wrist - Right side for test motion */
    ECRL: "wr_fe_r", 
    ECRB: "wr_fe_r", 
    ECU: "wr_fe_r", 
    FCR: "wr_fe_r", 
    FCU: "wr_fe_r", 

    /* Hip - Right side for test motion */
    Iliopsoas: "hip_fe_r", 
    Glute_Max: "hip_fe_r", 
    Glute_Med: "hip_aa_r", 
    Hip_ER: "hip_irer_r", 
    Hip_IR: "hip_irer_r", 

    /* Knee - Right side for test motion */
    Hamstrings: "knee_fe_r", 
    Quadriceps: "knee_fe_r", 

    /* Ankle & Foot - Right side for test motion */
    Tibialis_Anterior: "ankle_dfpf_r", 
    Foot_Eversion_PF: "ankle_dfpf_r", 
    Ankle_Dorsiflexion: "ankle_dfpf_r", 
    Gastrocnemius: "ankle_dfpf_r" 
};


/*
Â  Allowed positions:
Â  - "prone"
Â  - "supine"
Â  - "short_sit"
Â  - "long_sit"
Â  - "standing"
*/
const MMT_POSE = {
Â  /* CERVICAL / CAPITAL */
Â  Capital_Extension: "prone",
Â  Cervical_Extension: "prone",

Â  Capital_Flexion: "supine",
Â  Cervical_Flexion: "supine",
Â  Single_SCM: "supine",
Â  Cervical_Rotation: "supine",

Â  /* SCAPULA */
Â  Serratus_Anterior: "short_sit",
Â  Upper_Trapezius: "short_sit",
Â  Middle_Trapezius: "prone",
Â  Rhomboids: "prone",
Â  Latissimus_Dorsi: "prone",

Â  /* SHOULDER */
Â  Anterior_Deltoid: "short_sit",
Â  Posterior_Deltoid: "prone",
Â  Middle_Deltoid: "short_sit",
Â  Infraspinatus: "short_sit",
Â  Subscapularis: "short_sit",

Â  /* TRUNK */
Â  Trunk_Ext_Lumbar: "prone",
Â  Trunk_Ext_Thoracic: "prone",
Â  Trunk_Flexion: "supine",
Â  Trunk_Rotation: "supine",
Â  Pelvic_Elevation: "standing",

Â  /* ELBOW */
Â  Biceps_Brachii: "short_sit",
Â  Brachialis: "short_sit",
Â  Brachioradialis: "short_sit",
Â  Triceps_Brachii: "short_sit",

Â  /* WRIST */
Â  ECRL: "short_sit",
Â  ECRB: "short_sit",
Â  ECU: "short_sit",
Â  FCR: "short_sit",
Â  FCU: "short_sit",

Â  /* HIP */
Â  Iliopsoas: "short_sit",
Â  Glute_Max: "prone",
Â  Glute_Med: "side_lying",
Â  Hip_ER: "short_sit",
Â  Hip_IR: "short_sit",

Â  /* KNEE */
Â  Hamstrings: "prone",
Â  Quadriceps: "short_sit",

Â  /* FOOT & ANKLE */
Â  Tibialis_Anterior: "short_sit",
Â  Foot_Eversion_PF: "side_lying",
Â  Ankle_Dorsiflexion: "short_sit",
Â  Gastrocnemius: "standing"
};
Â Â 

/* ===== MMT MOTION CONFIG â€” INSERTED BELOW MODEL LOAD ===== */

const UPPER = [

Â  /* ===== TRUNK ===== */
Â  {key:'trunk_fe',Â  pair:'Trunk â€” Flex / Ext',Â  Â  Â  Â  Â  Â  side:'', plane:'sagittal',Â  Â neutral:0, min:-60, max:80,Â  hints:[/^spine01$/i]},
Â  {key:'trunk_lat', pair:'Trunk â€” Lateral Bend (L / R)',Â  side:'', plane:'frontal',Â  Â  neutral:0, min:-40, max:40,Â  hints:[/^spine01$/i]},
Â  {key:'trunk_rot', pair:'Trunk â€” Rotation (L / R)',Â  Â  Â  side:'', plane:'transverse', neutral:0, min:-45, max:45,Â  hints:[/^spine01$/i]},

Â  /* PELVIC HIKE (QL) */
Â  {key:'pelvic_hike', pair:'Pelvic Elevation', side:'', plane:'frontal', neutral:0, min:0, max:15, hints:[/pelvis|hip/i]},

Â  /* ===== CERVICAL / CAPITAL ===== */
Â  {key:'cerv_fe',Â  Â pair:'Cervical Flex / Ext',Â  Â  Â  Â  Â  Â  Â  Â  side:'', plane:'sagittal',Â  Â neutral:0, min:-60, max:70,Â  hints:[/^neck$|cspine|head/i]},
Â  {key:'cerv_lat',Â  pair:'Cervical Lat Flex (L / R)',Â  Â  Â  Â  Â  side:'', plane:'frontal',Â  Â  neutral:0, min:-45, max:45,Â  hints:[/^neck$|cspine|head/i]},
Â  {key:'cerv_rot',Â  pair:'Cervical Rotation (L / R)',Â  Â  Â  Â  Â  side:'', plane:'transverse', neutral:0, min:-80, max:80,Â  hints:[/^neck$|cspine|head/i]},

Â  /* ===== SCAPULA (SUBSTITUTED WITH CLAVICLE) ===== */
Â  {key:'scap_lr',Â  Â  pair:'Scapular â€” Pro / Ret via Clavicle', side:'', plane:'frontal',Â  Â neutral:0, min:-30, max:30, hints:[/clavicle/i]},
Â  {key:'scap_eldep', pair:'Scapular â€” Elev / Dep via Clavicle', side:'', plane:'frontal',Â  neutral:0, min:-30, max:30, hints:[/clavicle/i]},

Â  /* Clavicle residuals */
Â  {key:'clavicle_L', pair:'Clavicle L â€” Elevation / Depression', side:'l', plane:'frontal', neutral:0, min:-20, max:45, hints:[/clavicle|collar|shoulder|upperarm/i]},
Â  {key:'clavicle_R', pair:'Clavicle R â€” Elevation / Depression', side:'r', plane:'frontal', neutral:0, min:-20, max:45, hints:[/clavicle|collar|shoulder|upperarm/i]},

Â  /* ===== SHOULDER ===== */
Â  {key:'sh_fe_l',Â  Â pair:'Shoulder L â€” Flex / Ext',Â  Â  Â  Â  Â  Â  side:'l', plane:'sagittal',Â  neutral:0, min:-60, max:180, hints:[/upperarm|humerus|shoulder|arm(?!.*lower)/i]},
Â  {key:'sh_fe_r',Â  Â pair:'Shoulder R â€” Flex / Ext',Â  Â  Â  Â  Â  Â  side:'r', plane:'sagittal',Â  neutral:0, min:-60, max:180, hints:[/upperarm|humerus|shoulder|arm(?!.*lower)/i]},

Â  {key:'sh_aa_l',Â  Â pair:'Shoulder L â€” Abd / Add',Â  Â  Â  Â  Â  Â  Â side:'l', plane:'frontal',Â  Â neutral:0, min:-30, max:180, hints:[/upperarm|humerus|shoulder|arm(?!.*lower)/i]},
Â  {key:'sh_aa_r',Â  Â pair:'Shoulder R â€” Abd / Add',Â  Â  Â  Â  Â  Â  Â side:'r', plane:'frontal',Â  Â neutral:0, min:-30, max:180, hints:[/upperarm|humerus|shoulder|arm(?!.*lower)/i]},

Â  {key:'sh_irer_l', pair:'Shoulder L â€” External / Internal',Â  Â side:'l', plane:'transverse',neutral:0, min:-90, max:70, hints:[/upperarm_L/i]},
Â  {key:'sh_irer_r', pair:'Shoulder R â€” External / Internal',Â  Â side:'r', plane:'transverse',neutral:0, min:-90, max:70, hints:[/upperarm_R/i]},

Â  /* ===== ELBOW ===== */
Â  {key:'el_fe_l',Â  Â pair:'Elbow L â€” Flex / Ext', side:'l', plane:'sagittal',Â  neutral:0, min:-10, max:150, hints:[/lowerarm|forearm|ulna|radius/i]},
Â  {key:'el_fe_r',Â  Â pair:'Elbow R â€” Flex / Ext', side:'r', plane:'sagittal',Â  neutral:0, min:-10, max:150, hints:[/lowerarm|forearm|ulna|radius/i]},

Â  /* ===== WRIST ===== */
Â  {key:'wr_ps_l', pair:'Wrist L â€” Pronation / Supination', side:'l', plane:'transverse', neutral:0, min:-95, max:85, hints:[/wrist|hand|forearm|radius|ulna/i]},
Â  {key:'wr_ps_r', pair:'Wrist R â€” Pronation / Supination', side:'r', plane:'transverse', neutral:0, min:-95, max:85, invert:true, hints:[/wrist|hand|forearm|radius|ulna/i]},

Â  {key:'wr_fe_l', pair:'Wrist L â€” Flex / Ext', side:'l', plane:'sagittal', neutral:0, min:-70, max:80, hints:[/wrist|hand/i]},
Â  {key:'wr_fe_r', pair:'Wrist R â€” Flex / Ext', side:'r', plane:'sagittal', neutral:0, min:-70, max:80, hints:[/wrist|hand/i]},

Â  {key:'wr_ru_l', pair:'Wrist L â€” Radial / Ulnar Dev', side:'l', plane:'frontal', neutral:0, min:-40, max:20, hints:[/wrist|hand/i]},
Â  {key:'wr_ru_r', pair:'Wrist R â€” Radial / Ulnar Dev', side:'r', plane:'frontal', neutral:0, min:-40, max:20, invert:true, hints:[/wrist|hand/i]},

];


/* ===== LOWER BODY MOTIONS ===== */

const LOWER = [

Â  /* ===== HIP ===== */
Â  {key:'hip_fe_l',Â  Â pair:'Hip L â€” Flex / Ext',Â  Â  Â  Â  Â  Â  Â  Â  side:'l', plane:'sagittal',Â  neutral:0, min:-30, max:120, hints:[/thigh|femur/i]},
Â  {key:'hip_fe_r',Â  Â pair:'Hip R â€” Flex / Ext',Â  Â  Â  Â  Â  Â  Â  Â  side:'r', plane:'sagittal',Â  neutral:0, min:-30, max:120, hints:[/thigh|femur/i]},

Â  {key:'hip_aa_l',Â  Â pair:'Hip L â€” Abd / Add',Â  Â  Â  Â  Â  Â  Â  Â  Â side:'l', plane:'frontal',Â  Â neutral:0, min:-30, max:45,Â  hints:[/thigh|femur/i]},
Â  {key:'hip_aa_r',Â  Â pair:'Hip R â€” Add / Abd',Â  Â  Â  Â  Â  Â  Â  Â  Â side:'r', plane:'frontal',Â  Â neutral:0, min:-30, max:45,Â  hints:[/thigh|femur/i]},

Â  {key:'hip_irer_l', pair:'Hip L â€” Internal / External',Â  Â  Â  Â side:'l', plane:'transverse',neutral:0, min:-45, max:45,Â  hints:[/thigh|femur/i]},
Â  {key:'hip_irer_r', pair:'Hip R â€” Internal / External',Â  Â  Â  Â side:'r', plane:'transverse',neutral:0, min:-45, max:45,Â  hints:[/thigh|femur/i]},

Â  /* ===== KNEE ===== */
Â  {key:'knee_fe_l', pair:'Knee L â€” Ext / Flex', side:'l', plane:'sagittal', neutral:0, min:-15, max:150, hints:[/calf|tibia|fibula|shin/i]},
Â  {key:'knee_fe_r', pair:'Knee R â€” Ext / Flex', side:'r', plane:'sagittal', neutral:0, min:-15, max:150, hints:[/calf|tibia|fibula|shin/i]},

Â  /* ===== ANKLE ===== */
Â  {key:'ankle_dfpf_l', pair:'Ankle L â€” Dorsi / Plantarflex',Â  Â side:'l', plane:'sagittal', neutral:0, min:-20, max:50, hints:[/ankle|foot|talus|tarsal/i]},
Â  {key:'ankle_dfpf_r', pair:'Ankle R â€” Dorsi / Plantarflex',Â  Â side:'r', plane:'sagittal', neutral:0, min:-20, max:50, hints:[/ankle|foot|talus|tarsal/i]},

Â  /* ===== FOOT ===== */
Â  {key:'foot_invev_l', pair:'Foot L â€” Inversion / Eversion',Â  Â side:'l', plane:'frontal', neutral:0, min:-20, max:35, hints:[/foot|calcaneus|metatars|heel/i]},
Â  {key:'foot_invev_r', pair:'Foot R â€” Inversion / Eversion',Â  Â side:'r', plane:'frontal', neutral:0, min:-20, max:35, hints:[/foot|calcaneus|metatars|heel/i]},

];

/* CURRENT DICT (UPPER by default) */
let CURRENT = UPPER;
Â Â 
/* ==== Resistance fill (restored) ==== */
let resistanceTimer = null;
let resistanceStartTime = 0;
const RESISTANCE_FILL_TIME = 2000;

function handleResistanceButtonDown(e){
Â  if (testButton.disabled) return;
Â  e.preventDefault();
Â  resistanceStartTime = performance.now();
Â  instructionText.style.display = 'block';
Â  testButton.classList.add('active');

Â  resistanceTimer = setInterval(()=>{
Â  Â  const elapsed = performance.now() - resistanceStartTime;
Â  Â  const progress = Math.min(1, elapsed / RESISTANCE_FILL_TIME);
Â  Â  resistanceFill.style.width = `${progress*100}%`;

Â  Â  if (progress >= 1){
Â  Â  Â  resistanceText.textContent = 'Grade 5: Maximum Resistance';
Â  Â  Â  gradeMain.value = '5';
Â  Â  } else if (progress >= 0.5){
Â  Â  Â  resistanceText.textContent = 'Grade 4: Moderate Resistance';
Â  Â  Â  gradeMain.value = '4';
Â  Â  } else {
Â  Â  Â  resistanceText.textContent = 'Applying Resistance...';
Â  Â  }
Â  }, 100);
}

function handleResistanceButtonUp(){
Â  if (!resistanceTimer) return;
Â  clearInterval(resistanceTimer);
Â  resistanceTimer = null;
Â  testButton.classList.remove('active');
Â  resistanceFill.style.width = '0';
Â  resistanceText.textContent = 'Hold to Apply Resistance (4/5)';
Â  instructionText.style.display = 'none';
}

testButton.addEventListener('pointerdown', handleResistanceButtonDown);
testButton.addEventListener('pointerup', handleResistanceButtonUp);
testButton.addEventListener('pointercancel', handleResistanceButtonUp);
testButton.addEventListener('contextmenu', e=>e.preventDefault());

/* ==== Basic enablement ==== */
actionSel.addEventListener('change', ()=>{
Â  testButton.disabled = actionSel.value === "";
});
// When a test is selected, snap the body to the required position
actionSel.addEventListener("change", () => {
Â  applyPoseForTest(actionSel.value);
});

document.getElementById("lock3D").onclick = () => {
Â  controls.enabled = !controls.enabled;
Â  const btn = document.getElementById("lock3D");
Â  btn.textContent = (!controls.enabled ? "ğŸ”’ 3D: Locked" : "ğŸ”“ 3D: Unlocked");
Â  btn.classList.toggle('lockOn', !controls.enabled);
};

document.getElementById("zeroAll").onclick = () => {
Â  if (!skeleton) return;
Â  skeleton.bones.forEach(b=>{
Â  Â  const q0 = initialBoneRot.get(b);
Â  Â  if (q0) b.quaternion.copy(q0);
Â  });
};
/* ===== Grading Exceptions Availability Control ===== */

const exceptionSelect = document.getElementById("GradingExceptions");
const gradeMainSelect = document.getElementById("grade-main");

// Tests that ALLOW grading exceptions
const EXCEPTION_TESTS = new Set([
Â  "Trunk_Ext_Lumbar",
Â  "Trunk_Ext_Thoracic",
Â  "Trunk_Flexion",
Â  "Trunk_Rotation",
Â  "Pelvic_Elevation",
Â  "Gastrocnemius"
]);

function updateGradingExceptionAvailability() {
Â  const key = actionSel.value;

Â  if (EXCEPTION_TESTS.has(key)) {
Â  Â  /** Enable Exceptions */
Â  Â  exceptionSelect.disabled = false;
Â  Â  exceptionSelect.style.opacity = "1";

Â  Â  /** Disable Regular Grade */
Â  Â  gradeMainSelect.disabled = true;
Â  Â  gradeMainSelect.style.opacity = "0.4";

Â  } else {
Â  Â  /** Disable Exceptions */
Â  Â  exceptionSelect.disabled = true;
Â  Â  exceptionSelect.style.opacity = "0.4";
Â  Â  exceptionSelect.value = "3"; // Reset to Grade 3 default

Â  Â  /** Enable Regular Grade */
Â  Â  gradeMainSelect.disabled = false;
Â  Â  gradeMainSelect.style.opacity = "1";
Â  }
}

// Run when test changes
actionSel.addEventListener("change", updateGradingExceptionAvailability);

// Run once on load
updateGradingExceptionAvailability();

/* ===== MOVEMENT FIX: ADVANCED setPair FUNCTION ===== */
function setPair(key, deg) {
Â  Â  const cfg = [...UPPER, ...LOWER].find(x => x.key === key);Â 
Â  Â  if (!cfg || !skeleton) return;
Â  Â Â 
Â  Â  const rad = THREE.MathUtils.degToRad(deg + (cfg.neutral || 0));

Â  Â  // Find the bone using the key prefix (e.g., 'sh_fe_l' -> 'upperarm')
Â  Â  let boneNamePrefix = key.replace(/_[lr]$/, '').split('_')[0];
Â  Â  if (boneNamePrefix === 'cerv') boneNamePrefix = 'neck';
Â  Â Â 
Â  Â  // Find the target bone
Â  Â  const bone = skeleton.bones.find(b => b.name.toLowerCase().includes(boneNamePrefix));
Â  Â  if (!bone) return;

Â  Â  let x = 0, y = 0, z = 0;
Â  Â Â 
Â  Â  // Determine rotation axis based on plane (simplified mapping)
Â  Â  if (cfg.plane === 'sagittal') x = rad; // Flexion/Extension
Â  Â  else if (cfg.plane === 'frontal') z = rad; // Abduction/Adduction
Â  Â  else if (cfg.plane === 'transverse') y = rad; // Internal/External Rotation
Â  Â Â 
Â  Â  // Apply correction for right-side mirroring if applicable
Â  Â  if (key.endsWith('_r')) x = -x;Â 

Â  Â  const e = new THREE.Euler(x, y, z, "XYZ");
Â  Â Â 
Â  Â  // Use the initial bone rotation (baseline) as the start
Â  Â  const qBase = initialBoneRot.get(bone) || new THREE.Quaternion();
Â  Â  const qDelta = new THREE.Quaternion().setFromEuler(e);
Â  Â  bone.quaternion.copy(qBase).multiply(qDelta);
}
Â Â 
function applyPoseForTest(testKey) {
Â  const pose = MMT_POSE[testKey];
Â  if (!pose) return;

Â  // Reset model orientation & bones back to baseline
Â  model.rotation.set(0, 0, 0);
Â  if (skeleton) {
Â  Â  skeleton.bones.forEach(b => {
Â  Â  Â  const q0 = initialBoneRot.get(b);
Â  Â  Â  if (q0) b.quaternion.copy(q0);
Â  Â  });
Â  }

Â  /* ============ PRONE (face down) ============ */
Â  if (pose === "prone") {
Â  Â  model.rotation.x = Math.PI / 2;
Â  Â  return;
Â  }

Â  /* ============ SUPINE (face up) ============ */
Â  if (pose === "supine") {
Â  Â  model.rotation.x = -Math.PI / 2;
Â  Â  return;
Â  }



Â  /* ============ STANDING (default neutral) ============ */
Â  if (pose === "standing") {
Â  Â  // already reset to neutral above
Â  Â  return;
Â  }
/* ============ SHORT SITTING (hips 90Â°, knees 90Â°) ============ */
if (pose === "short_sit") {
Â  if (skeleton) {
Â  Â  // HIP FLEXION â€” thighs (90 degrees)
Â  Â  if (boneMap.thigh_L) boneMap.thigh_L.rotation.x = THREE.MathUtils.degToRad(90);
Â  Â  if (boneMap.thigh_R) boneMap.thigh_R.rotation.x = THREE.MathUtils.degToRad(90);

Â  Â  // KNEE FLEXION â€” calves (-90 degrees)
Â  Â  if (boneMap.calf_L) boneMap.calf_L.rotation.x = THREE.MathUtils.degToRad(-90);
Â  Â  if (boneMap.calf_R) boneMap.calf_R.rotation.x = THREE.MathUtils.degToRad(-90);
Â  }

Â  // === FIXED OFFSET FOR SITTING ===
Â  // This ensures the pelvis/buttocks are on the ground (Y=0) or a slight offset.
Â  // Using your existing fallback value:
Â  model.position.y = -0.4; // This value worked for your model in a previous context
Â  // ================================

Â  return;
}
Â  /* ============ SIDE-LYING (if you use it) ============ */
Â  if (pose === "side_lying") {
Â  Â  model.rotation.z = Math.PI / 2;
Â  Â  return;
Â  }
}

/* ==== Side panel + Markdown loading ==== */
const notePanel = document.getElementById('notePanel');
const noteTitle = document.getElementById('noteTitle');
const noteBodyÂ  = document.getElementById('noteBody');
const tabHighÂ  Â = document.getElementById('tabHigh'); // 3â€“5
const tabLowÂ  Â  = document.getElementById('tabLow');Â  // 0â€“2
const closeNote = document.getElementById('closeNote');

// GitHub RAW URLs for the two docs
const MD_HIGH = "https://raw.githubusercontent.com/Kingto89/ROMetrics.com/main/mmt/rometrics_mmt_threetofive.md";
const MD_LOWÂ  = "https://raw.githubusercontent.com/Kingto89/ROMetrics.com/main/mmt/rometrics_mmt_zerototwo.md";

// Map select values to readable headings to find in MD
const TEST_TO_HEADING = {
Â  Capital_Extension: "Capital Extension",
Â  Cervical_Extension: "Cervical Extension",
Â  Capital_Flexion: "Capital Flexion â€” Chin Tuck",
Â  Cervical_Flexion: "Cervical Flexion",
Â  Single_SCM: "Single Sternocleidomastoid â€” Anterolateral Flexion",
Â  Cervical_Rotation: "Cervical Rotation",
Â  Serratus_Anterior: "Scapular Abduction & Upward Rotation",
Â  Upper_Trapezius: "Scapular Elevation",
Â  Middle_Trapezius: "Scapular Adduction / Retraction",
Â  Rhomboids: "Scapular Adduction + Downward Rotation",
Â  Latissimus_Dorsi: "Latissimus Dorsi",
Â  Anterior_Deltoid: "Shoulder Flexion",
Â  Posterior_Deltoid: "Shoulder Extension",
Â  Middle_Deltoid: "Shoulder Abduction",
Â  Infraspinatus: "Shoulder External Rotation",
Â  Subscapularis: "Shoulder Internal Rotation",
Â  Trunk_Ext_Lumbar: "Trunk Extension â€” Lumbar",
Â  Trunk_Ext_Thoracic: "Trunk Extension â€” Thoracic",
Â  Trunk_Flexion: "Trunk Flexion â€” Rectus Abdominis",
Â  Trunk_Rotation: "Trunk Rotation â€” External & Internal Obliques",
Â  Pelvic_Elevation: "Pelvic Elevation â€” Quadratus Lumborum",
Â  Biceps_Brachii: "Elbow Flexion â€” Biceps Brachii",
Â  Brachialis: "Elbow Flexion â€” Brachialis",
Â  Brachioradialis: "Elbow Flexion â€” Brachioradialis",
Â  Triceps_Brachii: "Elbow Extension",
Â  ECRL: "Wrist Extension â€” ECRL",
Â  ECRB: "Wrist Extension â€” ECRB",
Â  ECU: "Wrist Extension â€” ECU",
Â  FCR: "Wrist Flexion â€” Flexor Carpi Radialis",
Â  FCU: "Wrist Flexion â€” Flexor Carpi Ulnaris",
Â  Iliopsoas: "Hip Flexion",
Â  Glute_Max: "Hip Extension",
Â  Glute_Med: "Hip Abduction",
Â  Hip_ER: "Hip External Rotation",
Â  Hip_IR: "Hip Internal Rotation",
Â  Hamstrings: "Knee Flexion",
Â  Quadriceps: "Knee Extension",
Â  Tibialis_Anterior: "Foot Dorsiflexion + Inversion",
Â  Foot_Eversion_PF: "Foot Eversion + Plantarflexion",
Â  Ankle_Dorsiflexion: "Ankle Dorsiflexion",
Â  Â Gastrocnemius: "Ankle Plantar Flexion"
};

function mdToHtml(md){
Â  // Tiny converter for headings/lists/bold/paragraphs
Â  return md
Â  Â  .replace(/^### (.*)$/gm, "<h3>$1</h3>")
Â  Â  .replace(/^## (.*)$/gm, "<h2>$1</h2>")
Â  Â  .replace(/^\* (.*)$/gm, "<li>$1</li>")
Â  Â  .replace(/^- (.*)$/gm, "<li>$1</li>")
Â  Â  .replace(/(\n<li>.*<\/li>)+/g, m => `<ul>${m}</ul>`)
Â  Â  .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
Â  Â  .replace(/\n{2,}/g, "</p><p>")
Â  Â  .replace(/^([^<\n].*)$/gm, "<p>$1</p>");
}

// Extract section starting with matching "## Heading" until next "##"
function extractSection(md, queryHeading){
Â  const lines = md.split(/\r?\n/);
Â  let start = -1;
Â  for (let i=0;i<lines.length;i++){
Â  Â  if (lines[i].startsWith("## ") && lines[i].toLowerCase().includes(queryHeading.toLowerCase())){
Â  Â  Â  start = i; break;
Â  Â  }
Â  }
Â  if (start === -1){
Â  Â  return md; // fallback: show whole doc if not found
Â  }
Â  let end = lines.length;
Â  for (let j=start+1;j<lines.length;j++){
Â  Â  if (lines[j].startsWith("## ")){ end = j; break; }
Â  }
Â  return lines.slice(start, end).join("\n");
}

async function loadNoteFile(which){
Â  const muscleKey = actionSel.value;
Â  if (!muscleKey){
Â  Â  noteBody.innerHTML = "<p>Select a test first.</p>";
Â  Â  return;
Â  }
Â  const heading = TEST_TO_HEADING[muscleKey] || muscleKey.replaceAll("_"," ");
Â  noteTitle.textContent = heading + " â€” MMT Instructions";
Â  const url = (which === 'high') ? MD_HIGH : MD_LOW;
Â  noteBody.innerHTML = "Loadingâ€¦";
Â  try{
Â  Â  const res = await fetch(url);
Â  Â  if (!res.ok) throw new Error("HTTP " + res.status);
Â  Â  const text = await res.text();
Â  Â  const section = extractSection(text, heading);
Â  Â  noteBody.innerHTML = mdToHtml(section);
Â  }catch(e){
Â  Â  noteBody.textContent = "Failed to load instructions.";
Â  }
}

function openNote(which='high'){
Â  tabHigh.classList.toggle('active', which==='high');
Â  tabLow.classList.toggle('active', which!=='high');
Â  notePanel.classList.remove('hide');
Â  notePanel.style.display = "flex";
Â  loadNoteFile(which);
}

showMMT.addEventListener('click', ()=> openNote('high'));
tabHigh.addEventListener('click', ()=> openNote('high'));
tabLow.addEventListener('click', ()=> openNote('low'));
closeNote.addEventListener('click', ()=> notePanel.classList.add('hide'));

/* ==== Loop & resize ==== */
addEventListener("resize", ()=>{
Â  camera.aspect = innerWidth/innerHeight;
Â  camera.updateProjectionMatrix();
Â  renderer.setSize(innerWidth, innerHeight);
});

/* === AUTO-MOVEMENT FOR MMT: Start Test (INCORPORATED FIX) === */
startTestBtn.addEventListener("click", () => {
Â  const test = actionSel.value;
Â  if (!test) return;

Â  // Determine which AUTOACTION motion belongs to this MMT test
Â  const autoKey = MMT_TO_AUTO[test];
Â  const cfg = autoKey ? [...UPPER, ...LOWER].find(x => x.key === autoKey) : null;
Â  if (!cfg) {
        console.warn(`No motion configuration found for test: ${test}`);
        return; 
    }

Â  let current = 0;
Â  const target = cfg.max;
Â  const step = 2;Â  Â  Â  Â  Â  // Increased speed for visibility
Â  const interval = 10;Â  Â  Â // Faster interval for smoother animation

 // Reset the joint to its initial pose before starting the motion
 setPair(cfg.key, 0);

Â  const timer = setInterval(() => {
Â  Â  current += step;
Â  Â  if (current >= target) {
Â  Â  Â  current = target;
Â  Â  Â  clearInterval(timer);
Â  Â  }
Â  Â  setPair(cfg.key, current);
Â  }, interval);
});
Â Â 
(function loop(){
Â  controls.update();
Â  renderer.render(scene, camera);
Â  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
