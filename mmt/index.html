<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MMT Trainer ‚Äî Side Notes (Room + Place & Save)</title>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

<style>
:root{
  --bg:#f1f5f9; --panel:#ffffff; --line:#cbd5e1; --ctrl:#e2e8f0;
  --text:#0f172a; --muted:#64748b; --primary:#0d9488; --accent:#facc15;
}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);overflow:hidden;font-family:system-ui,Segoe UI,Roboto}
canvas{position:fixed;inset:0;width:100%;height:100%;display:block}

.panel{position:fixed;left:25px;top:12px;width:380px;max-height:92vh;z-index:100;background:var(--panel);
  border:1px solid var(--line);border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,.15);display:flex;flex-direction:column;overflow:hidden}
.dragbar{cursor:move;background:var(--ctrl);border-bottom:1px solid var(--line);padding:8px 12px;font-weight:700;display:flex;align-items:center;gap:8px}
.dragbar .hint{margin-left:auto;font-size:12px;color:var(--muted)}
.content{padding:12px;overflow:auto}
label{display:block;font-size:12px;margin-top:8px;color:var(--muted)}
select,button,input[type=range]{width:100%;margin:6px 0 8px 0;padding:8px 10px;border-radius:10px;background:var(--ctrl);border:1px solid var(--line);color:var(--text)}
.row{display:flex;gap:8px}.row>button,.row>select{flex:1}
.mini{padding:6px 10px;border-radius:8px;background:var(--ctrl);border:1px solid var(--line)}
.lockOn{background:#0b3a1f;border-color:#16a34a;color:#fff}
#msg{position:fixed;bottom:10px;left:12px;background:var(--panel);border:1px solid var(--line);
  border-radius:8px;padding:6px 10px;font-size:12px;z-index:25;color:var(--text)}
#log{display:none;background:var(--ctrl);border:1px solid var(--line);min-height:90px;max-height:130px;overflow:auto;border-radius:8px;padding:8px;font-size:12px;white-space:pre-wrap;color:var(--text)}

/* Resistance button */
#testButton{position:relative;padding:12px 10px;font-weight:700;overflow:hidden;touch-action:none;background:var(--ctrl)}
#resistanceFill{position:absolute;top:0;left:0;width:0;height:100%;background-color:var(--accent);transition:width .1s linear;z-index:1}
#resistanceText{position:relative;z-index:2}
#instructionText{font-size:12px;color:var(--muted);text-align:center;margin:4px 0 12px 0;display:none}

/* Right-side note panel (smaller) */
#notePanel{position:fixed;top:16px;right:16px;width:min(420px,46vw);max-height:70vh;display:none;z-index:140;
  background:#e2e8f0;border:1px solid var(--line);border-radius:12px;box-shadow:0 12px 32px rgba(0,0,0,.25);
  display:flex;flex-direction:column;overflow:hidden}
.note-head{display:flex;align-items:center;gap:8px;padding:10px 12px;background:#dbe4ee;border-bottom:1px solid var(--line)}
.note-head h3{margin:0;font-size:16px;font-weight:800;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.note-tabs{display:flex;gap:8px}
.note-tabs button{padding:6px 10px;border-radius:8px;border:1px solid var(--line);background:#fff}
.note-tabs button.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.note-body{padding:12px;overflow:auto;background:#fff}
.note-close{border-radius:8px;border:1px solid var(--line);padding:6px 10px;background:#fff}
@media (max-width: 720px){
  #notePanel{right:8px;left:8px;width:auto;max-height:60vh}
}
.hide{display:none !important;}

/* Placement controls */
.badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);
  background:#fff;font-size:12px}
</style>
</head>
<body>

<div class="panel" id="panel">
  <div class="dragbar" id="dragbar">üí™ MMT Trainer <span class="hint">drag me</span></div>
  <div class="content">

    <label>MMT Test & Muscle</label>
    <select id="actionSel">
      <option value="">(Select a test to begin‚Ä¶)</option>
      <optgroup label="Cervical & Capital">
        <option value="Capital_Extension">Capital Extension</option>
        <option value="Cervical_Extension">Cervical Extension</option>
        <option value="Capital_Flexion">Capital Flexion ‚Äî Chin Tuck</option>
        <option value="Cervical_Flexion">Cervical Flexion</option>
        <option value="Single_SCM">Single SCM ‚Äî Anterolateral Flexion</option>
        <option value="Cervical_Rotation">Cervical Rotation</option>
      </optgroup>
      <optgroup label="Scapula">
        <option value="Serratus_Anterior">Scapular Abduction & Upward Rotation</option>
        <option value="Upper_Trapezius">Scapular Elevation</option>
        <option value="Middle_Trapezius">Scapular Adduction / Retraction</option>
        <option value="Rhomboids">Scapular Adduction + Downward Rotation</option>
        <option value="Latissimus_Dorsi">Latissimus Dorsi</option>
      </optgroup>
      <optgroup label="Shoulder">
        <option value="Anterior_Deltoid">Shoulder Flexion</option>
        <option value="Posterior_Deltoid">Shoulder Extension</option>
        <option value="Middle_Deltoid">Shoulder Abduction</option>
        <option value="Infraspinatus">Shoulder External Rotation</option>
        <option value="Subscapularis">Shoulder Internal Rotation</option>
      </optgroup>
      <optgroup label="Trunk & Pelvis">
        <option value="Trunk_Ext_Lumbar">Trunk Extension ‚Äî Lumbar</option>
        <option value="Trunk_Ext_Thoracic">Trunk Extension ‚Äî Thoracic</option>
        <option value="Trunk_Flexion">Trunk Flexion ‚Äî Rectus Abdominis</option>
        <option value="Trunk_Rotation">Trunk Rotation</option>
        <option value="Pelvic_Elevation">Pelvic Elevation ‚Äî Hip Hike</option>
      </optgroup>
      <optgroup label="Elbow">
        <option value="Biceps_Brachii">Elbow Flexion ‚Äî Biceps (sup)</option>
        <option value="Brachialis">Elbow Flexion ‚Äî Brachialis (pro)</option>
        <option value="Brachioradialis">Elbow Flexion ‚Äî Brachioradialis (neutral)</option>
        <option value="Triceps_Brachii">Elbow Extension ‚Äî Triceps</option>
      </optgroup>
      <optgroup label="Wrist">
        <option value="ECRL">Wrist Extension ‚Äî ECRL</option>
        <option value="ECRB">Wrist Extension ‚Äî ECRB</option>
        <option value="ECU">Wrist Extension ‚Äî ECU</option>
        <option value="FCR">Wrist Flexion ‚Äî FCR</option>
        <option value="FCU">Wrist Flexion ‚Äî FCU</option>
      </optgroup>
      <optgroup label="Hip">
        <option value="Iliopsoas">Hip Flexion ‚Äî Iliopsoas</option>
        <option value="Glute_Max">Hip Extension ‚Äî Glute Max</option>
        <option value="Glute_Med">Hip Abduction ‚Äî Glute Med</option>
        <option value="Hip_ER">Hip External Rotation</option>
        <option value="Hip_IR">Hip Internal Rotation</option>
      </optgroup>
      <optgroup label="Knee">
        <option value="Hamstrings">Knee Flexion ‚Äî Hamstrings</option>
        <option value="Quadriceps">Knee Extension ‚Äî Quadriceps</option>
      </optgroup>
      <optgroup label="Ankle & Foot">
        <option value="Tibialis_Anterior">Dorsiflexion + Inversion</option>
        <option value="Foot_Eversion_PF">Eversion + Plantarflexion</option>
        <option value="Ankle_Dorsiflexion">Ankle Dorsiflexion</option>
        <option value="Gastrocnemius">Plantar Flexion ‚Äî Gastroc/Soleus</option>
      </optgroup>
    </select>

    <div class="row" style="margin-top:10px;">
      <button id="startTestBtn" class="mini">‚ñ∂Ô∏è Start Test </button>
      <button id="showMMT" class="mini">üìå MMT Placement</button>
    </div>

    <div class="row" style="align-items:center; margin-top:10px;">
      <div style="flex:1;">
        <label>Test Grade Selection</label>
        <select id="grade-main" name="grade-main">
          <option value="3">Grade 3 - 5 (Full ROM / Resistance: none, Mod, Max)</option>
          <option value="2">Grade 2 (Full ROM / Gravity Eliminated)</option>
          <option value="1">Grade 1 (Trace Contraction)</option>
          <option value="0">Grade 0 (No Contraction)</option>
        </select>
      </div>
      <div style="flex:1;">
        <label>Grading Exceptions</label>
        <select id="GradingExceptions" name="GradingExceptions">
          <option value="5">Grade 5 (Full ROM / Maximum Resistance)</option>
          <option value="4">Grade 4 (Full ROM / Moderate Resistance)</option>
          <option value="3">Grade 3 (Full ROM / No Resistance)</option>
          <option value="2">Grade 2 (Full ROM / Gravity Eliminated)</option>
          <option value="1">Grade 1 (Trace Contraction)</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="testButton" disabled>
        <div id="resistanceFill"></div>
        <span id="resistanceText">Hold to Apply Resistance (4/5)</span>
      </button>
    </div>
    <p id="instructionText">Hold for 1s (Grade 4), Hold for 2s (Grade 5).</p>

    <label>Model Control</label>
    <div class="row">
      <button id="lock3D" class="mini">üîì 3D: Unlocked</button>
      <button id="zeroAll" class="mini" title="Reset everything to anatomic baseline">Zero All</button>
    </div>

    <label>Placement</label>
    <div class="row">
      <button id="placeSave" class="mini">üìç Place (click surface) & Save</button>
      <span id="placeHint" class="badge">Tip: click floor/table</span>
    </div>
    <div class="row">
      <button id="nudgeUp"   class="mini">‚¨ÜÔ∏è Nudge Up</button>
      <button id="nudgeDown" class="mini">‚¨áÔ∏è Nudge Down</button>
    </div>
    <div class="row">
      <button id="nudgeFwd"  class="mini">‚¨ÖÔ∏è Nudge Toward</button>
      <button id="nudgeBack" class="mini">‚û°Ô∏è Nudge Away</button>
    </div>

    <pre id="log"></pre>
  </div>
</div>

<div id="msg">Loading‚Ä¶</div>
<canvas id="c"></canvas>

<!-- Right-side notes panel -->
<div id="notePanel" class="hide">
  <div class="note-head">
    <h3 id="noteTitle">MMT Instructions</h3>
    <div class="note-tabs">
      <button id="tabHigh" class="active">Grades 3‚Äì5</button>
      <button id="tabLow">Grades 0‚Äì2</button>
    </div>
    <button class="note-close" id="closeNote">Close ‚úï</button>
  </div>
  <div class="note-body" id="noteBody">Loading‚Ä¶</div>
</div>

<script>
  window.ROMETRICS_MODEL_URL = "https://kingto89.github.io/ROMetrics.com/assets/Roma_ROMetrics.glb";
</script>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "three/addons/controls/OrbitControls.js";
import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
import { DRACOLoader } from "three/addons/loaders/DRACOLoader.js";
import { KTX2Loader } from "three/addons/loaders/KTX2Loader.js";
import { MeshoptDecoder } from "three/addons/libs/meshopt_decoder.module.js";

/* ==== Error surfacing ==== */
window.addEventListener('error', (e) => {
  const m = document.getElementById("msg");
  if (m) m.textContent = `‚ö†Ô∏è ${e.message}`;
});

/* ==== UI refs ==== */
const canvas = document.getElementById("c");
const logEl = document.getElementById("log");
const log = (t) => { logEl.textContent += t + "\\n"; logEl.scrollTop = logEl.scrollHeight; };

const actionSel = document.getElementById("actionSel");
const startTestBtn = document.getElementById("startTestBtn");
const showMMT = document.getElementById("showMMT");

const testButton = document.getElementById("testButton");
const resistanceFill = document.getElementById("resistanceFill");
const resistanceText = document.getElementById("resistanceText");
const instructionText = document.getElementById("instructionText");
const gradeMain = document.getElementById("grade-main");

const placeSaveBtn = document.getElementById("placeSave");
const nudgeUp   = document.getElementById("nudgeUp");
const nudgeDown = document.getElementById("nudgeDown");
const nudgeFwd  = document.getElementById("nudgeFwd");
const nudgeBack = document.getElementById("nudgeBack");
const placeHint = document.getElementById("placeHint");

/* ==== Start Test Button Glow Fix (NEW) ==== */
startTestBtn.addEventListener('click', () => {
  startTestBtn.classList.add('lockOn');
  setTimeout(() => { startTestBtn.classList.remove('lockOn'); }, 300);
});

/* ==== THREE setup ==== */
const renderer = new THREE.WebGLRenderer({ canvas, antialias:true });
renderer.setPixelRatio(devicePixelRatio);
renderer.setSize(innerWidth, innerHeight);
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;

const scene = new THREE.Scene();
scene.background = new THREE.Color(0xf1f5f9);

const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.01, 100);
camera.position.set(2.2,1.7,3.8);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true; controls.dampingFactor = .08;
controls.minDistance=.6; controls.maxDistance=8;
controls.target.set(0,1.1,0);

scene.add(new THREE.HemisphereLight(0xffffff, 0x333344, 0.6));
const key = new THREE.DirectionalLight(0xffffff, 1.2);
key.position.set(3.5,5,3);
key.castShadow = true;
key.shadow.mapSize.set(2048,2048);
key.shadow.camera.near=0.1; key.shadow.camera.far=20;
key.shadow.camera.left=-6; key.shadow.camera.right=6;
key.shadow.camera.top=6; key.shadow.camera.bottom=-6;
scene.add(key);

/* ==== Room / exam props ==== */
const placeables = []; // meshes we can place on
const room = new THREE.Group(); scene.add(room);

// Floor
const floorMat = new THREE.MeshStandardMaterial({ color: 0xe5e7eb, roughness: 0.95, metalness: 0 });
const floor = new THREE.Mesh(new THREE.PlaneGeometry(8,6), floorMat);
floor.rotation.x = -Math.PI/2; floor.position.y = 0;
floor.receiveShadow = true; room.add(floor); placeables.push(floor);

// Walls
const wallMat = new THREE.MeshStandardMaterial({ color: 0xf8fafc, roughness: 1 });
const wallBack  = new THREE.Mesh(new THREE.PlaneGeometry(8,3), wallMat);  wallBack.position.set(0,1.5,-3); room.add(wallBack);
const wallLeft  = new THREE.Mesh(new THREE.PlaneGeometry(6,3), wallMat);  wallLeft.rotation.y = Math.PI/2; wallLeft.position.set(-4,1.5,0); room.add(wallLeft);
const wallRight = new THREE.Mesh(new THREE.PlaneGeometry(6,3), wallMat);  wallRight.rotation.y = -Math.PI/2; wallRight.position.set(4,1.5,0); room.add(wallRight);

// Exam table (red top)
const table = new THREE.Group(); room.add(table);
const base = new THREE.Mesh(new THREE.BoxGeometry(1.8,0.55,0.7), new THREE.MeshStandardMaterial({ color:0xd1d5db, roughness:.9 }));
base.position.set(0,0.275,0.4); base.castShadow = true; base.receiveShadow = true; table.add(base);
const top = new THREE.Mesh(new THREE.BoxGeometry(1.9,0.08,0.75), new THREE.MeshStandardMaterial({ color:0xb91c1c, roughness:.8 }));
top.position.set(0,0.56,0.4); top.castShadow = true; top.receiveShadow = true; table.add(top); placeables.push(top);
const pillow = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.06,0.3), new THREE.MeshStandardMaterial({ color:0xfef2f2, roughness:.95 }));
pillow.position.set(0.55,0.63,0.4); pillow.castShadow = true; pillow.receiveShadow = true; table.add(pillow);

// Curtain
const curtain = new THREE.Mesh(new THREE.BoxGeometry(0.02,2.4,2.0), new THREE.MeshStandardMaterial({ color:0x60a5fa, transparent:true, opacity:0.5, roughness:1 }));
curtain.position.set(-0.95,1.2,0.9); room.add(curtain);

// Stool
const stoolSeat = new THREE.Mesh(new THREE.CylinderGeometry(0.22,0.22,0.06,24), new THREE.MeshStandardMaterial({ color:0x374151, roughness:.8 }));
stoolSeat.position.set(-0.8,0.4,-0.3); stoolSeat.castShadow = stoolSeat.receiveShadow = true; room.add(stoolSeat);
const stoolLeg = new THREE.Mesh(new THREE.CylinderGeometry(0.05,0.05,0.35,12), new THREE.MeshStandardMaterial({ color:0x9ca3af, metalness:.2, roughness:.5 }));
stoolLeg.position.set(-0.8,0.22,-0.3); stoolLeg.castShadow = stoolLeg.receiveShadow = true; room.add(stoolLeg);

// Step
const step = new THREE.Mesh(new THREE.BoxGeometry(0.45,0.15,0.35), new THREE.MeshStandardMaterial({ color:0x9ca3af, roughness:.9 }));
step.position.set(0.6,0.075,0.9); step.castShadow = step.receiveShadow = true; room.add(step);

// Door & Window
const door = new THREE.Mesh(new THREE.BoxGeometry(0.9,2.1,0.05), new THREE.MeshStandardMaterial({ color:0x111827, roughness:.7 }));
door.position.set(-3.1,1.05,-2.95); room.add(door);
const windowPane = new THREE.Mesh(new THREE.PlaneGeometry(1.6,0.8), new THREE.MeshStandardMaterial({ color:0x93c5fd, transparent:true, opacity:.5 }));
windowPane.position.set(2.2,1.6,-2.95); room.add(windowPane);

/* ==== Loader ==== */
const loader = new GLTFLoader();
loader.setMeshoptDecoder(MeshoptDecoder);
const draco = new DRACOLoader(); draco.setDecoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/"); loader.setDRACOLoader(draco);
const ktx2  = new KTX2Loader();  ktx2.setTranscoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/basis/"); ktx2.detectSupport(renderer); loader.setKTX2Loader(ktx2);

let model=null, skeleton=null;
const initialBoneRot = new Map();

/* ==== Persistence ==== */
const SEAT_KEY = "rometrics_room_pose_v1";
function savePose() {
  if(!model) return;
  const p = model.position; const r = model.rotation;
  localStorage.setItem(SEAT_KEY, JSON.stringify({ p:[p.x,p.y,p.z], r:[r.x,r.y,r.z] }));
}
function loadPose() {
  try{
    const raw = localStorage.getItem(SEAT_KEY);
    if(!raw) return false;
    const {p,r} = JSON.parse(raw);
    if (p && model) model.position.set(p[0],p[1],p[2]);
    if (r && model) model.rotation.set(r[0],r[1],r[2]);
    return true;
  } catch { return false; }
}

/* ==== Helpers ==== */
function snapBottomTo(hitY){
  const box = new THREE.Box3().setFromObject(model);
  const minY = box.min.y;
  if (isFinite(minY)) model.position.y += (hitY - minY);
}
function seatedLegs(){
  if(!skeleton) return;
  const get = (n)=> skeleton.bones.find(b => b.name === n);
  const thighL = get("thigh_L");
  const thighR = get("thigh_R");
  const calfL  = get("calf_L");
  const calfR  = get("calf_R");
  [thighL,thighR,calfL,calfR].forEach(b=>{
    const q0 = initialBoneRot.get(b); if(b&&q0) b.quaternion.copy(q0);
  });
  const rad = THREE.MathUtils.degToRad;
  if (thighL) thighL.rotateX(rad(90));
  if (thighR) thighR.rotateX(rad(90));
  if (calfL)  calfL.rotateX(rad(-90));
  if (calfR)  calfR.rotateX(rad(-90));
}

/* ==== Load model ==== */
const MODEL_CANDIDATES = [
  window.ROMETRICS_MODEL_URL,
  "assets/Roma_ROMetrics.glb",
  new URL("assets/Roma_ROMetrics.glb", document.baseURI).href
].filter(Boolean);

function tryNextModelUrl(index, onDone){
  if(index >= MODEL_CANDIDATES.length){ onDone(new Error("All model URL fallbacks failed.")); return; }
  const url = MODEL_CANDIDATES[index];
  log("Loading model from: " + url);
  loader.load(url,
    (gltf)=> onDone(null, gltf),
    (xhr)=>{
      const pct = xhr.lengthComputable ? Math.min(100, Math.round(100*xhr.loaded/xhr.total)) : null;
      document.getElementById("msg").textContent = pct!==null ? `Loading ${pct}%` : "Loading‚Ä¶";
    },
    ()=> tryNextModelUrl(index+1, onDone)
  );
}

function loadModel(){
  tryNextModelUrl(0, (err, gltf)=>{
    if (err){
      document.getElementById("msg").textContent = `‚ö†Ô∏è Load error: ${err.message}`;
      log("All fallbacks failed.");
      return;
    }
    model = gltf.scene;
    model.scale.set(1.5,1.5,1.5);
    model.traverse(o=>{
      if (o.isMesh){ o.castShadow=true; o.receiveShadow=true; }
      if (o.isSkinnedMesh && !skeleton) skeleton = o.skeleton;
    });
    scene.add(model);
    document.getElementById("msg").textContent = "‚úÖ Model loaded";

    if (skeleton){
      skeleton.bones.forEach(b => initialBoneRot.set(b, b.quaternion.clone()));
    }

    // Default: place on floor center
    const box = new THREE.Box3().setFromObject(model);
    model.position.y -= box.min.y;
    model.position.x = -0.2; model.position.z = 0.2;

    // Restore pose if saved
    if(!loadPose()){
      // If no saved pose, seat on table by default
      seatedLegs();
      snapBottomTo(top.position.y + 0.04);
      model.position.set(0.2, model.position.y, 0.5);
    }
  });
}
loadModel();

/* ==== Placement (raycast) ==== */
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();
let placing = false;

function onPointerDown(e){
  if(!placing || !model) return;
  const rect = renderer.domElement.getBoundingClientRect();
  mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
  mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);
  const hits = raycaster.intersectObjects(placeables, false);
  if(hits.length){
    const hit = hits[0];
    model.position.copy(hit.point);
    snapBottomTo(hit.point.y);
    // If the surface is the red table top, auto-seat
    if (hit.object === top) seatedLegs();
    savePose();
    placing = false;
    placeSaveBtn.classList.remove('lockOn');
    placeHint.textContent = "Saved ‚úì";
    setTimeout(()=> placeHint.textContent = "Tip: click floor/table", 900);
  }
}

placeSaveBtn.addEventListener('click', ()=>{
  placing = true;
  placeSaveBtn.classList.add('lockOn');
  placeHint.textContent = "Click any floor/table surface‚Ä¶";
});
renderer.domElement.addEventListener('pointerdown', onPointerDown);

/* ==== Nudgers ==== */
function doNudge(dx,dy,dz){
  if(!model) return;
  model.position.x += dx;
  model.position.y += dy;
  model.position.z += dz;
  savePose();
}
nudgeUp.addEventListener('click',   ()=> doNudge(0, +0.01, 0));
nudgeDown.addEventListener('click', ()=> doNudge(0, -0.02, 0)); // a bit stronger down
nudgeFwd.addEventListener('click',  ()=> doNudge(0, 0, -0.03));
nudgeBack.addEventListener('click', ()=> doNudge(0, 0, +0.03));

/* ==== Basic enablement ==== */
actionSel.addEventListener('change', ()=>{
  testButton.disabled = actionSel.value === "";
});

document.getElementById("lock3D").onclick = () => {
  controls.enabled = !controls.enabled;
  const btn = document.getElementById("lock3D");
  btn.textContent = (!controls.enabled ? "üîí 3D: Locked" : "üîì 3D: Unlocked");
  btn.classList.toggle('lockOn', !controls.enabled);
};

document.getElementById("zeroAll").onclick = () => {
  if (!skeleton) return;
  skeleton.bones.forEach(b=>{
    const q0 = initialBoneRot.get(b);
    if (q0) b.quaternion.copy(q0);
  });
};

/* ==== Loop & resize ==== */
addEventListener("resize", ()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});
(function loop(){
  controls.update();
  renderer.render(scene, camera);
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
