<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ROMetrics â€” Manual Muscle Testing (MMT Integrated)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

<style>
:root{
  --bg:#0b0f14;--panel:#0f172a;--line:#1f2937;
  --text:#e2e8f0;--muted:#cbd5e1;
}
html,body{
  margin:0;height:100%;overflow:hidden;
  background:var(--bg);color:var(--text);
  font-family:Inter,system-ui,sans-serif;
}
canvas{
  position:fixed;inset:0;width:100%;height:100%;display:block;
}
.panel{
  position:fixed;right:20px;top:20px;width:340px;
  background:var(--panel);border-radius:16px;padding:16px;
  box-shadow:0 8px 30px rgba(0,0,0,.45);
  overflow-y:auto;max-height:90vh;
}
.panel h2{margin:0 0 12px;font-size:18px;font-weight:700;color:#fff}
label{display:block;margin-top:10px;margin-bottom:4px;font-weight:600}
select,button{
  width:100%;padding:10px 12px;border-radius:10px;
  border:1px solid var(--line);
  background:#fff;color:#111;font-size:14px;font-weight:500;
}
button{cursor:pointer;font-weight:700}
#status{text-align:center;margin-top:6px;font-weight:700;font-size:18px}
.hand{
  position:absolute;width:100px;user-select:none;
  cursor:grab;touch-action:none;z-index:10;
}
#handL{bottom:60px;left:80px}
#handR{bottom:60px;right:80px}
</style>
</head>
<body>
<canvas id="c"></canvas>

<div class="panel">
  <h2>ROMetrics â€” MMT</h2>
  <label for="testLevel">Test Level</label>
  <select id="testLevel">
    <option value="3-5" selected>Level 3â€“5</option>
    <option value="0-2">Level 0â€“2</option>
  </select>

  <label for="testSel">Select Muscle Test</label>
  <select id="testSel" size="12"></select>

  <button id="startBtn" disabled>Start Test</button>
  <div id="status"></div>
</div>

<img id="handL" class="hand" src="./assets/hand_L.png">
<img id="handR" class="hand" src="./assets/hand_R.png">

<script type="module">
import * as THREE from 'three';
import {OrbitControls} from 'three/addons/controls/OrbitControls.js';
import {GLTFLoader} from 'three/addons/loaders/GLTFLoader.js';

/* ---------- Renderer + Scene ---------- */
const renderer=new THREE.WebGLRenderer({canvas:document.getElementById('c'),antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(devicePixelRatio);
renderer.outputEncoding=THREE.sRGBEncoding;

const scene=new THREE.Scene();
scene.background=new THREE.Color(0x0b0f14);
const camera=new THREE.PerspectiveCamera(50,innerWidth/innerHeight,0.1,100);
camera.position.set(0,1.6,3);
const controls=new OrbitControls(camera,renderer.domElement);
controls.target.set(0,1.2,0);
controls.update();

scene.add(new THREE.HemisphereLight(0xffffff,0x404040,0.9));
const dir=new THREE.DirectionalLight(0xffffff,1);
dir.position.set(2,5,3);
scene.add(dir);

window.addEventListener('resize',()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});

/* ---------- Load Roma Model (Correct Live Path) ---------- */
let model=null,skeleton=[];
const loader=new GLTFLoader();
const MODEL_URL="/ROMetrics/assets/Roma_ROMetrics.glb?v=1";
try{
  const glb=await loader.loadAsync(MODEL_URL);
  model=glb.scene;
  model.traverse(o=>{if(o.isBone)skeleton.push(o);});
  scene.add(model);
  console.log('âœ… Roma model loaded from',MODEL_URL);
}catch(e){console.error('âŒ Model load failed',e);}

/* ---------- Core Helpers ---------- */
function resolveBind(name){return skeleton.find(b=>b.name===name)||null;}
function setRotation(bone,axis,deg){
  if(!bone)return;
  const rad=THREE.MathUtils.degToRad(deg);
  if(axis==='x')bone.rotation.x=rad;
  if(axis==='y')bone.rotation.y=rad;
  if(axis==='z')bone.rotation.z=rad;
}
function resetAll(){
  skeleton.forEach(b=>{
    b.rotation.set(0,0,0);
    if(b.position)b.position.set(0,0,0);
  });
}

/* ---------- Action Map ---------- */
const ACTIONS={
  'shoulder-flexion':{bone:'upperarm_r',axis:'x',deg:90,midpoint:45},
  'shoulder-extension':{bone:'upperarm_r',axis:'x',deg:-60,midpoint:-30},
  'shoulder-abduction':{bone:'upperarm_r',axis:'z',deg:90,midpoint:45},
  'elbow-flexion':{bone:'lowerarm_r',axis:'x',deg:-145,midpoint:-70},
  'elbow-extension':{bone:'lowerarm_r',axis:'x',deg:0,midpoint:-10},
  'hip-flexion':{bone:'thigh_r',axis:'x',deg:120,midpoint:60},
  'hip-extension':{bone:'thigh_r',axis:'x',deg:-30,midpoint:-15},
  'knee-flexion':{bone:'calf_r',axis:'x',deg:-135,midpoint:-70},
  'ankle-dorsiflexion':{bone:'foot_r',axis:'x',deg:20,midpoint:10},
  'ankle-plantarflexion':{bone:'foot_r',axis:'x',deg:-50,midpoint:-25}
};

/* ---------- Animation Function ---------- */
function animateToPose(boneName,axis,deg,duration=1000){
  const bone=resolveBind(boneName);
  if(!bone)return;
  const start=bone.rotation[axis];
  const end=THREE.MathUtils.degToRad(deg);
  const startTime=performance.now();
  function step(now){
    const t=Math.min((now-startTime)/duration,1);
    bone.rotation[axis]=THREE.MathUtils.lerp(start,end,t);
    if(t<1)requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}
function performAction(key,level='3-5'){
  if(!ACTIONS[key])return;
  const act=ACTIONS[key];
  const deg=(level==='3-5')?act.midpoint:0;
  animateToPose(act.bone,act.axis,deg,1200);
}

/* ---------- Hand Logic ---------- */
const handL=document.getElementById('handL');
const handR=document.getElementById('handR');
function makeDraggable(el){
  el.addEventListener('pointerdown',e=>{
    e.preventDefault();el.setPointerCapture(e.pointerId);
  });
  el.addEventListener('pointermove',e=>{
    if(el.hasPointerCapture(e.pointerId)){
      el.style.left=(el.offsetLeft+e.movementX)+'px';
      el.style.top=(el.offsetTop+e.movementY)+'px';
    }
  });
  el.addEventListener('pointerup',()=>{el.releasePointerCapture;updateHandGate();});
}
makeDraggable(handL);makeDraggable(handR);

const HAND_TARGETS={
  'shoulder-flexion':{L:[180,400],R:[300,350]},
  'elbow-flexion':{L:[160,450],R:[310,420]},
  'hip-flexion':{L:[180,420],R:[320,420]},
  'knee-flexion':{L:[200,440],R:[330,440]},
  'ankle-dorsiflexion':{L:[220,470],R:[340,470]}
};
function isNear(el,[x,y],r=60){
  const rect=el.getBoundingClientRect();
  const cx=rect.left+rect.width/2;
  const cy=rect.top+rect.height/2;
  return Math.hypot(cx-x,cy-y)<r;
}
function handsReady(){
  if(!selectedTest||!HAND_TARGETS[selectedTest])return false;
  const t=HAND_TARGETS[selectedTest];
  return isNear(handL,t.L)&&isNear(handR,t.R);
}

/* ---------- UI & Control ---------- */
const testSel=document.getElementById('testSel');
const testLevel=document.getElementById('testLevel');
const startBtn=document.getElementById('startBtn');
const status=document.getElementById('status');
let selectedTest=null,holdTimers=[];

testSel.addEventListener('change',()=>{
  testSel.addEventListener('change',()=>{
  selectedTest = testSel.value;
  
  // ðŸ”¥ Instant pose on select (fixes your issue)
  resetAll();
  performAction(selectedTest, testLevel.value);

  updateHandGate();
});
  
function updateHandGate(){
  startBtn.disabled=!(selectedTest&&handsReady());
}

/* ---------- Test Flow ---------- */
function beginTest(){
  if(!selectedTest)return;
  const lvl=testLevel.value;
  resetAll();
  performAction(selectedTest,lvl);
  status.textContent='3';
  holdTimers=[
    setTimeout(()=>status.textContent='4',3000),
    setTimeout(()=>status.textContent='5',6000),
    setTimeout(()=>status.textContent='Test Complete',9000)
  ];
}
function endTest(){
  holdTimers.forEach(clearTimeout);
  holdTimers=[];
  setTimeout(()=>{resetAll();status.textContent='';},1000);
}
startBtn.addEventListener('pointerdown',beginTest);
startBtn.addEventListener('pointerup',endTest);
['pointermove','pointerup'].forEach(evt=>{
  handL.addEventListener(evt,updateHandGate);
  handR.addEventListener(evt,updateHandGate);
});
testLevel.addEventListener('change',updateHandGate);

/* ---------- Test List Loader ---------- */
(async function populateTests(){
  const res=await fetch("https://raw.githubusercontent.com/Kingto89/ROMetrics/main/mmt/rometrics_mmt_library.md");
  const text=await res.text();
  const matches=[...text.matchAll(/^###\s+(.*?)$/gm)];
  for(const m of matches){
    const opt=document.createElement('option');
    opt.value=m[1].toLowerCase().replace(/[^a-z0-9]+/g,'-');
    opt.textContent=m[1];
    testSel.appendChild(opt);
  }
})();

/* ---------- Render Loop ---------- */
function render(){
  requestAnimationFrame(render);
  renderer.render(scene,camera);
}
render();
</script>
</body>
</html>
