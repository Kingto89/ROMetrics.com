<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MMT Trainer ‚Äî Side Notes (Hard‚ÄëWired Pose)</title>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

<style>
:root{
  --bg:#f1f5f9; --panel:#ffffff; --line:#cbd5e1; --ctrl:#e2e8f0;
  --text:#0f172a; --muted:#64748b; --primary:#0d9488; --accent:#facc15;
}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);overflow:hidden;font-family:system-ui,Segoe UI,Roboto}
canvas{position:fixed;inset:0;width:100%;height:100%;display:block}

.panel{position:fixed;left:25px;top:12px;width:380px;max-height:92vh;z-index:100;background:var(--panel);
  border:1px solid var(--line);border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,.15);display:flex;flex-direction:column;overflow:hidden}
.dragbar{cursor:move;background:var(--ctrl);border-bottom:1px solid var(--line);padding:8px 12px;font-weight:700;display:flex;align-items:center;gap:8px}
.dragbar .hint{margin-left:auto;font-size:12px;color:var(--muted)}
.content{padding:12px;overflow:auto}
label{display:block;font-size:12px;margin-top:8px;color:var(--muted)}
select,button,input[type=range]{width:100%;margin:6px 0 8px 0;padding:8px 10px;border-radius:10px;background:var(--ctrl);border:1px solid var(--line);color:var(--text)}
.row{display:flex;gap:8px}.row>button,.row>select{flex:1}
.mini{padding:6px 10px;border-radius:8px;background:var(--ctrl);border:1px solid var(--line)}
.lockOn{background:#0b3a1f;border-color:#16a34a;color:#fff}
#msg{position:fixed;bottom:10px;left:12px;background:var(--panel);border:1px solid var(--line);border-radius:8px;padding:6px 10px;font-size:12px;z-index:25;color:var(--text)}
#log{display:none;background:var(--ctrl);border:1px solid var(--line);min-height:90px;max-height:130px;overflow:auto;border-radius:8px;padding:8px;font-size:12px;white-space:pre-wrap;color:var(--text)}

#notePanel{position:fixed;top:16px;right:16px;width:min(420px,46vw);max-height:70vh;display:none;z-index:140;
  background:#e2e8f0;border:1px solid var(--line);border-radius:12px;box-shadow:0 12px 32px rgba(0,0,0,.25);
  display:flex;flex-direction:column;overflow:hidden}
.note-head{display:flex;align-items:center;gap:8px;padding:10px 12px;background:#dbe4ee;border-bottom:1px solid var(--line)}
.note-head h3{margin:0;font-size:16px;font-weight:800;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.note-tabs{display:flex;gap:8px}
.note-tabs button{padding:6px 10px;border-radius:8px;border:1px solid var(--line);background:#fff}
.note-tabs button.active{background:#0d9488;color:#fff;border-color:#0d9488}
.note-body{padding:12px;overflow:auto;background:#fff}
.note-close{border-radius:8px;border:1px solid var(--line);padding:6px 10px;background:#fff}
@media (max-width: 720px){
  #notePanel{right:8px;left:8px;width:auto;max-height:60vh}
}
.hide{display:none !important;}
</style>
</head>
<body>

<div class="panel" id="panel">
  <div class="dragbar" id="dragbar">üí™ MMT Trainer <span class="hint">drag me</span></div>
  <div class="content">
    <label>MMT Test & Muscle</label>
    <select id="actionSel">
      <option value="">(Select a test to begin‚Ä¶)</option>
      <optgroup label="Cervical & Capital">
        <option value="Capital_Extension">Capital Extension (Rectus Capitis Posterior Major, Obliquus Capitis Superior, Splenius Capitis)</option>
        <option value="Cervical_Extension">Cervical Extension (Semispinalis Cervicis, Splenius Cervicis, Longissimus Cervicis)</option>
        <option value="Capital_Flexion">Capital Flexion ‚Äî Chin Tuck (Longus Capitis, Rectus Capitis Anterior, Anterior Scalene)</option>
        <option value="Cervical_Flexion">Cervical Flexion (Sternocleidomastoid, Longus Colli, Anterior Scalene)</option>
        <option value="Single_SCM">Single SCM ‚Äî Anterolateral Flexion (SCM, Longus Capitis, Longus Colli)</option>
        <option value="Cervical_Rotation">Cervical Rotation (SCM‚Äîcontralateral; Splenius Capitis‚Äîipsilateral; Longissimus Capitis‚Äîipsilateral)</option>
      </optgroup>
      <optgroup label="Scapula">
        <option value="Serratus_Anterior">Scapular Abduction & Upward Rotation (Serratus Anterior)</option>
        <option value="Upper_Trapezius">Scapular Elevation (Upper Trapezius, Levator Scapulae)</option>
        <option value="Middle_Trapezius">Scapular Adduction / Retraction (Middle Trapezius)</option>
        <option value="Rhomboids">Scapular Adduction + Downward Rotation (Rhomboids)</option>
        <option value="Latissimus_Dorsi">Latissimus Dorsi (shoulder depression/extension pattern)</option>
      </optgroup>
      <optgroup label="Shoulder">
        <option value="Anterior_Deltoid">Shoulder Flexion (Anterior Deltoid, Coracobrachialis)</option>
        <option value="Posterior_Deltoid">Shoulder Extension (Posterior Deltoid, Lat, Teres Major)</option>
        <option value="Middle_Deltoid">Shoulder Abduction (Middle Deltoid, Supraspinatus)</option>
        <option value="Infraspinatus">Shoulder External Rotation (Infraspinatus, Teres Minor)</option>
        <option value="Subscapularis">Shoulder Internal Rotation (Subscapularis, Teres Major, Pec Major, Lat)</option>
      </optgroup>
      <optgroup label="Trunk & Pelvis - Grading Exception">
        <option value="Trunk_Ext_Lumbar">Trunk Extension ‚Äî Lumbar (Erector Spinae)</option>
        <option value="Trunk_Ext_Thoracic">Trunk Extension ‚Äî Thoracic (Erector Spinae)</option>
        <option value="Trunk_Flexion">Trunk Flexion ‚Äî Rectus Abdominis</option>
        <option value="Trunk_Rotation">Trunk Rotation ‚Äî External & Internal Obliques</option>
        <option value="Pelvic_Elevation">Pelvic Elevation (Hip Hike) ‚Äî Quadratus Lumborum</option>
      </optgroup>
      <optgroup label="Elbow">
        <option value="Biceps_Brachii">Elbow Flexion ‚Äî Biceps Brachii (supinated)</option>
        <option value="Brachialis">Elbow Flexion ‚Äî Brachialis (pronated)</option>
        <option value="Brachioradialis">Elbow Flexion ‚Äî Brachioradialis (neutral)</option>
        <option value="Triceps_Brachii">Elbow Extension ‚Äî Triceps Brachii</option>
      </optgroup>
      <optgroup label="Wrist">
        <option value="ECRL">Wrist Extension ‚Äî Extensor Carpi Radialis Longus (ECRL)</option>
        <option value="ECRB">Wrist Extension ‚Äî Extensor Carpi Radialis Brevis (ECRB)</option>
        <option value="ECU">Wrist Extension ‚Äî Extensor Carpi Ulnaris (ECU)</option>
        <option value="FCR">Wrist Flexion ‚Äî Flexor Carpi Radialis (FCR)</option>
        <option value="FCU">Wrist Flexion ‚Äî Flexor Carpi Ulnaris (FCU)</option>
      </optgroup>
      <optgroup label="Hip">
        <option value="Iliopsoas">Hip Flexion (Iliopsoas)</option>
        <option value="Glute_Max">Hip Extension (Glute Max, Hamstrings)</option>
        <option value="Glute_Med">Hip Abduction (Glute Med, Glute Min)</option>
        <option value="Hip_ER">Hip External Rotation</option>
        <option value="Hip_IR">Hip Internal Rotation</option>
      </optgroup>
      <optgroup label="Knee">
        <option value="Hamstrings">Knee Flexion (Hamstrings)</option>
        <option value="Quadriceps">Knee Extension (Quadriceps)</option>
      </optgroup>
      <optgroup label="Ankle & Foot -  Grading Exception for Gastroc">
        <option value="Tibialis_Anterior">Dorsiflexion + Inversion (Tibialis Anterior)</option>
        <option value="Foot_Eversion_PF">Foot Eversion + Plantarflexion (Fibularis Longus, Fibularis Brevis)</option>
        <option value="Ankle_Dorsiflexion">Ankle Dorsiflexion (Tibialis Anterior; EDL/EHL assist)</option>
        <option value="Gastrocnemius">Plantar Flexion (Gastrocnemius, Soleus)</option>
      </optgroup>
    </select>

    <div class="row" style="margin-top:10px;">
      <button id="startTestBtn" class="mini">‚ñ∂Ô∏è Start Test </button>
      <button id="showMMT" class="mini">üìå MMT Placement</button>
    </div>

    <div class="row" style="align-items:center; margin-top:10px;">
      <div style="flex:1;">
        <label>Test Grade Selection</label>
        <select id="grade-main" name="grade-main">
          <option value="3">Grade 3 - 5 (Full ROM / Resistance: none, Mod, Max)</option>
          <option value="2">Grade 2 (Full ROM / Gravity Eliminated)</option>
          <option value="1">Grade 1 (Trace Contraction)</option>
          <option value="0">Grade 0 (No Contraction)</option>
        </select>
      </div>
      <div style="flex:1;">
        <label>Grading Exceptions</label>
        <select id="GradingExceptions" name="GradingExceptions">
          <option value="5">Grade 5 (Full ROM / Maximum Resistance)</option>
          <option value="4">Grade 4 (Full ROM / Moderate Resistance)</option>
          <option value="3">Grade 3 (Full ROM / No Resistance)</option>
          <option value="2">Grade 2 (Full ROM / Gravity Eliminated)</option>
          <option value="1">Grade 1 (Trace Contraction)</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="testButton" disabled>
        <div id="resistanceFill"></div>
        <span id="resistanceText">Hold to Apply Resistance (4/5)</span>
      </button>
    </div>
    <p id="instructionText">Hold for 1s (Grade 4), Hold for 2s (Grade 5).</p>

    <label>Model Control</label>
    <div class="row">
      <button id="lock3D" class="mini">üîì 3D: Unlocked</button>
      <button id="zeroAll" class="mini" title="Reset to anatomic baseline">Zero All</button>
    </div>
  </div>
</div>

<div id="msg">Loading‚Ä¶</div>
<canvas id="c"></canvas>

<!-- Right-side notes panel -->
<div id="notePanel" class="hide">
  <div class="note-head">
    <h3 id="noteTitle">MMT Instructions</h3>
    <div class="note-tabs">
      <button id="tabHigh" class="active">Grades 3‚Äì5</button>
      <button id="tabLow">Grades 0‚Äì2</button>
    </div>
    <button class="note-close" id="closeNote">Close ‚úï</button>
  </div>
  <div class="note-body" id="noteBody">Loading‚Ä¶</div>
</div>

<script>
  // Use your live model path (uploaded in your repo)
  window.ROMETRICS_MODEL_URL = "https://kingto89.github.io/ROMetrics.com/assets/Roma_ROMetrics.glb";
</script>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "three/addons/controls/OrbitControls.js";
import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
import { DRACOLoader } from "three/addons/loaders/DRACOLoader.js";
import { KTX2Loader } from "three/addons/loaders/KTX2Loader.js";
import { MeshoptDecoder } from "three/addons/libs/meshopt_decoder.module.js";

/* ==== Hard-wired numeric pose (edit these) ==== */
const POSE = {
  x: 0.31,   // back(-) / toward(+)
  y: 0.00,   // down(-) / up(+)
  z: 0.90,  // left(-) / right(+)
  ryDeg: 30,  // rotation 0‚Äì360
  s: 1.15,   // scale
  seated: false // true = sit legs
};

/* ==== Error surfacing ==== */
window.addEventListener('error', (e) => {
  const m = document.getElementById("msg");
  if (m) m.textContent = `‚ö†Ô∏è ${e.message}`;
});

/* ==== UI refs ==== */
const $ = (id)=>document.getElementById(id);
const canvas = $("c");
const logEl = $("log");
const log = (t) => { if(logEl){ logEl.textContent += t + "\\n"; logEl.scrollTop = logEl.scrollHeight; } };

const actionSel = $("actionSel");
const startTestBtn = $("startTestBtn");
const showMMT = $("showMMT");
const testButton = $("testButton");
const resistanceFill = $("resistanceFill");
const resistanceText = $("resistanceText");
const instructionText = $("instructionText");
const gradeMain = $("grade-main");

/* ==== Start Test Button Glow Fix ==== */
startTestBtn.addEventListener('click', () => {
  startTestBtn.classList.add('lockOn');
  setTimeout(() => startTestBtn.classList.remove('lockOn'), 300);
});

/* ==== THREE setup ==== */
const renderer = new THREE.WebGLRenderer({ canvas, antialias:true });
renderer.setPixelRatio(devicePixelRatio);
renderer.setSize(innerWidth, innerHeight);
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;

const scene = new THREE.Scene();
scene.background = new THREE.Color(0xf1f5f9);

const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.01, 200);
camera.position.set(1.8,1.6,3.2);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true; controls.dampingFactor = .08;
controls.minDistance=.6; controls.maxDistance=20;
controls.target.set(0,1.05,0); 

/* Lights */
scene.add(new THREE.HemisphereLight(0xffffff, 0x8ca0b3, 0.8));
const key = new THREE.DirectionalLight(0xffffff, 1.1);
key.position.set(3.5,5,3.5);
key.castShadow = true;
key.shadow.mapSize.set(2048,2048);
key.shadow.camera.near=0.1; key.shadow.camera.far=50;
key.shadow.camera.left=-10; key.shadow.camera.right=10;
key.shadow.camera.top=10; key.shadow.camera.bottom=-10;
scene.add(key);

/* ==== ROOM GEOMETRY (simple eval room) ==== */
const room = new THREE.Group();
scene.add(room);

// Floor (vinyl)
const floor = new THREE.Mesh(
  new THREE.PlaneGeometry(12, 12),
  new THREE.MeshStandardMaterial({ color: 0xe2e8f0, roughness:0.9, metalness:0 })
);
floor.rotation.x = -Math.PI/2;
floor.receiveShadow = true;
room.add(floor);

// Walls
const wallMat = new THREE.MeshStandardMaterial({ color: 0xf8fafc, roughness: 1, metalness: 0 });
const backWall = new THREE.Mesh(new THREE.PlaneGeometry(12, 3), wallMat);
backWall.position.set(0, 1.5, -6);
room.add(backWall);
const leftWall = new THREE.Mesh(new THREE.PlaneGeometry(12, 3), wallMat);
leftWall.rotation.y = Math.PI/2;
leftWall.position.set(-6, 1.5, 0);
room.add(leftWall);

// Long blue table (extended)
const TABLE_HEIGHT = 0.46;
const TABLE_THICK = 0.08;
const TABLE_W = 0.7;
const TABLE_D = 2.2; // Long enough
const tableTop = new THREE.Mesh(
  new THREE.BoxGeometry(TABLE_W, TABLE_THICK, TABLE_D),
  new THREE.MeshStandardMaterial({ color: 0x1e3a8a, roughness:0.85, metalness:0.05 }) // deep blue
);
tableTop.position.set(0, TABLE_HEIGHT, 0.35);
tableTop.castShadow = true; tableTop.receiveShadow = true;
room.add(tableTop);

// Table base (simple box legs)
const base = new THREE.Mesh(
  new THREE.BoxGeometry(TABLE_W*0.6, TABLE_HEIGHT, TABLE_D*0.8),
  new THREE.MeshStandardMaterial({ color: 0x374151, roughness:0.9, metalness:0.05 })
);
base.position.set(0, TABLE_HEIGHT/2, 0.35);
base.castShadow = true; base.receiveShadow = true;
room.add(base);

// Cabinet
const cabinet = new THREE.Mesh(
  new THREE.BoxGeometry(1.0, 0.9, 0.45),
  new THREE.MeshStandardMaterial({ color: 0x9ca3af, roughness:0.8 })
);
cabinet.position.set(-1.6, 0.45, -0.6);
cabinet.castShadow = true; cabinet.receiveShadow = true;
room.add(cabinet);

// Stool
const stoolSeat = new THREE.Mesh(
  new THREE.CylinderGeometry(0.18, 0.18, 0.06, 24),
  new THREE.MeshStandardMaterial({ color: 0x6b7280, roughness:0.8 })
);
stoolSeat.position.set(0.95, 0.52, -0.2);
stoolSeat.castShadow = true; stoolSeat.receiveShadow = true;
room.add(stoolSeat);
const stoolLeg = new THREE.Mesh(
  new THREE.CylinderGeometry(0.03, 0.03, 0.5, 16),
  new THREE.MeshStandardMaterial({ color: 0x4b5563, roughness:0.8 })
);
stoolLeg.position.set(0.95, 0.25, -0.2);
stoolLeg.castShadow = true; stoolLeg.receiveShadow = true;
room.add(stoolLeg);

// Shadow catcher slightly above floor to enhance contact shadows
const shadowCatch = new THREE.Mesh(new THREE.PlaneGeometry(6,6), new THREE.ShadowMaterial({ opacity:0.4 }));
shadowCatch.rotation.x = -Math.PI/2;
shadowCatch.position.y = 0.001;
shadowCatch.receiveShadow = true;
room.add(shadowCatch);
 // ---- View preset: room yaw + camera distance (ONE BLOCK) ----
(() => {
  // Turn the whole room left/right (negative = left, positive = right)
  const ROOM_YAW_DEG = -70;
  room.rotation.y = degToRad(ROOM_YAW_DEG);

  // Zoom preset: set camera distance from the controls target
  function setCameraDistance(d){
    const dir = new THREE.Vector3()
      .subVectors(camera.position, controls.target)
      .normalize();
    camera.position.copy(controls.target).addScaledVector(dir, d);
  }
  setCameraDistance(4.8); // bigger = farther, smaller = closer
})();
/* ==== Loader ==== */
const loader = new GLTFLoader();
loader.setMeshoptDecoder(MeshoptDecoder);
const draco = new DRACOLoader(); draco.setDecoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/"); loader.setDRACOLoader(draco);
const ktx2  = new KTX2Loader();  ktx2.setTranscoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/basis/"); ktx2.detectSupport(renderer); loader.setKTX2Loader(ktx2);

let model=null, skeleton=null;
const initialBoneRot = new Map();

/* ==== Utilities ==== */
function degToRad(d){ return d * Math.PI / 180; }

function seatPoseOnlyLegs(){
  if(!skeleton) return;
  const get = (n)=> skeleton.bones.find(b => b.name === n);
  const thighL = get("thigh_L"), thighR = get("thigh_R"), calfL = get("calf_L"), calfR = get("calf_R");
  [thighL,thighR,calfL,calfR].forEach(b=>{
    if(!b) return;
    const q0 = initialBoneRot.get(b);
    if (q0) b.quaternion.copy(q0);
  });
  const rad = THREE.MathUtils.degToRad;
  if (thighL) thighL.rotateX(rad(90));
  if (thighR) thighR.rotateX(rad(90));
  if (calfL)  calfL.rotateX(rad(-90));
  if (calfR)  calfR.rotateX(rad(-90));
}

/* ==== Load model ==== */
function addModel(gltf){
  model = gltf.scene;
  model.traverse(o=>{
    if (o.isMesh){ o.castShadow=true; o.receiveShadow=true; }
    if (o.isSkinnedMesh && !skeleton) skeleton = o.skeleton;
  });

  // store baseline bone rotations
  if (skeleton){
    skeleton.bones.forEach(b => initialBoneRot.set(b, b.quaternion.clone()));
  }

  // Apply hard-wired numeric transform (no saving, no snapping)
  model.scale.set(POSE.s, POSE.s, POSE.s);
  model.position.set(POSE.x, POSE.y, POSE.z);
  model.rotation.set(0, degToRad(POSE.ryDeg), 0);
  if (POSE.seated) seatPoseOnlyLegs();

  scene.add(model);
  $("msg").textContent = "‚úÖ Model loaded";
}

const MODEL_CANDIDATES = [
  window.ROMETRICS_MODEL_URL,
  "assets/Roma_ROMetrics.glb",
  new URL("assets/Roma_ROMetrics.glb", document.baseURI).href
].filter(Boolean);

function tryNextModelUrl(index){
  if(index >= MODEL_CANDIDATES.length){
    $("msg").textContent = "‚ö†Ô∏è Could not load model from any path.";
    return;
  }
  const url = MODEL_CANDIDATES[index];
  $("msg").textContent = "Loading model‚Ä¶ " + url;
  loader.load(
    url,
    (gltf)=> addModel(gltf),
    (xhr)=>{
      const pct = xhr.lengthComputable ? Math.min(100, Math.round(100*xhr.loaded/xhr.total)) : null;
      $("msg").textContent = pct!==null ? `Loading ${pct}%` : "Loading‚Ä¶";
    },
    ()=> tryNextModelUrl(index+1)
  );
}

tryNextModelUrl(0);

/* ==== Wire UI ==== */
$("lock3D").onclick = () => {
  controls.enabled = !controls.enabled;
  const btn = $("lock3D");
  btn.textContent = (!controls.enabled ? "üîí 3D: Locked" : "üîì 3D: Unlocked");
  btn.classList.toggle('lockOn', !controls.enabled);
};
$("zeroAll").onclick = () => {
  if (!skeleton) return;
  skeleton.bones.forEach(b=>{
    const q0 = initialBoneRot.get(b);
    if (q0) b.quaternion.copy(q0);
  });
};

/* ==== Side panel + Markdown loading ==== */
const notePanel = document.getElementById('notePanel');
const noteTitle = document.getElementById('noteTitle');
const noteBody  = document.getElementById('noteBody');
const tabHigh   = document.getElementById('tabHigh'); // 3‚Äì5
const tabLow    = document.getElementById('tabLow');  // 0‚Äì2
const closeNote = document.getElementById('closeNote');

// GitHub RAW URLs for the two docs
const MD_HIGH = "https://raw.githubusercontent.com/Kingto89/ROMetrics.com/main/mmt/rometrics_mmt_threetofive.md";
const MD_LOW  = "https://raw.githubusercontent.com/Kingto89/ROMetrics.com/main/mmt/rometrics_mmt_zerototwo.md";

// Map select values to readable headings to find in MD
const TEST_TO_HEADING = {
  Serratus_Anterior: "Scapular Abduction & Upward Rotation",
  Upper_Trapezius: "Scapular Elevation",
  Middle_Trapezius: "Scapular Adduction / Retraction",
  Rhomboids: "Scapular Adduction + Downward Rotation",
  Latissimus_Dorsi: "Latissimus Dorsi",
  Anterior_Deltoid: "Shoulder Flexion",
  Posterior_Deltoid: "Shoulder Extension",
  Middle_Deltoid: "Shoulder Abduction",
  Infraspinatus: "Shoulder External Rotation",
  Subscapularis: "Shoulder Internal Rotation",
  Biceps_Brachii: "Elbow Flexion ‚Äî Biceps Brachii",
  Brachialis: "Elbow Flexion ‚Äî Brachialis",
  Brachioradialis: "Elbow Flexion ‚Äî Brachioradialis",
  Triceps_Brachii: "Elbow Extension",
  ECRL: "Wrist Extension ‚Äî ECRL",
  ECRB: "Wrist Extension ‚Äî ECRB",
  ECU: "Wrist Extension ‚Äî ECU",
  FCR: "Wrist Flexion ‚Äî Flexor Carpi Radialis",
  FCU: "Wrist Flexion ‚Äî Flexor Carpi Ulnaris",
  Iliopsoas: "Hip Flexion",
  Glute_Max: "Hip Extension",
  Glute_Med: "Hip Abduction",
  Hip_ER: "Hip External Rotation",
  Hip_IR: "Hip Internal Rotation",
  Hamstrings: "Knee Flexion",
  Quadriceps: "Knee Extension",
  Tibialis_Anterior: "Foot Dorsiflexion + Inversion",
  Gastrocnemius: "Ankle Plantar Flexion"
};

function mdToHtml(md){
  // Tiny converter for headings/lists/bold/paragraphs
  return md
    .replace(/^### (.*)$/gm, "<h3>$1</h3>")
    .replace(/^## (.*)$/gm, "<h2>$1</h2>")
    .replace(/^\* (.*)$/gm, "<li>$1</li>")
    .replace(/^- (.*)$/gm, "<li>$1</li>")
    .replace(/(\n<li>.*<\/li>)+/g, m => `<ul>${m}</ul>`)
    .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
    .replace(/\n{2,}/g, "</p><p>")
    .replace(/^([^<\n].*)$/gm, "<p>$1</p>");
}

// Extract section starting with matching "## Heading" until next "##"
function extractSection(md, queryHeading){
  const lines = md.split(/\r?\n/);
  let start = -1;
  for (let i=0;i<lines.length;i++){
    if (lines[i].startsWith("## ") && lines[i].toLowerCase().includes(queryHeading.toLowerCase())){
      start = i; break;
    }
  }
  if (start === -1){
    return md; // fallback: show whole doc if not found
  }
  let end = lines.length;
  for (let j=start+1;j<lines.length;j++){
    if (lines[j].startsWith("## ")){ end = j; break; }
  }
  return lines.slice(start, end).join("\n");
}

async function loadNoteFile(which){
  const muscleKey = actionSel.value;
  if (!muscleKey){
    noteBody.innerHTML = "<p>Select a test first.</p>";
    return;
  }
  const heading = TEST_TO_HEADING[muscleKey] || muscleKey.replaceAll("_"," ");
  noteTitle.textContent = heading + " ‚Äî MMT Instructions";
  const url = (which === 'high') ? MD_HIGH : MD_LOW;
  noteBody.innerHTML = "Loading‚Ä¶";
  try{
    const res = await fetch(url);
    if (!res.ok) throw new Error("HTTP " + res.status);
    const text = await res.text();
    const section = extractSection(text, heading);
    noteBody.innerHTML = mdToHtml(section);
  }catch(e){
    noteBody.textContent = "Failed to load instructions.";
  }
}

function openNote(which='high'){
  tabHigh.classList.toggle('active', which==='high');
  tabLow.classList.toggle('active', which!=='high');
  notePanel.classList.remove('hide');
  notePanel.style.display = "flex";
  loadNoteFile(which);
}

showMMT.addEventListener('click', ()=> openNote('high'));
tabHigh.addEventListener('click', ()=> openNote('high'));
tabLow.addEventListener('click', ()=> openNote('low'));
closeNote.addEventListener('click', ()=> notePanel.classList.add('hide'));

/* ==== Loop & resize ==== */
addEventListener("resize", ()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});
(function loop(){
  controls.update();
  renderer.render(scene, camera);
  requestAnimationFrame(loop);
})();

</script>
</body>
</html>
