<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>3D Motion Lab â€” Joint Trainer</title>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

<style>
:root{--bg:#0b1220;--panel:#0f172a;--line:#1f2937;--ctrl:#1e293b;--text:#e2e8f0;--muted:#cbd5e1}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);overflow:hidden;font-family:system-ui,Segoe UI,Roboto}
canvas{position:fixed;inset:0;width:100%;height:100%;display:block}
.panel{position:fixed;left:12px;top:12px;width:360px;max-height:90vh;z-index:20;background:var(--panel);border:1px solid var(--line);border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,.4);display:flex;flex-direction:column;overflow:hidden}
.dragbar{cursor:move;background:#0c1628;border-bottom:1px solid #162235;padding:8px 12px;font-weight:700;display:flex;align-items:center;gap:8px}
.dragbar .hint{margin-left:auto;font-size:12px;color:#9fb0c9}
.content{padding:12px;overflow:auto}
label{display:block;font-size:12px;margin-top:8px;color:var(--muted)}
select,button,input[type=range]{width:100%;margin:6px 0 8px 0;padding:8px 10px;border-radius:10px;background:var(--ctrl);border:1px solid #334155;color:var(--text)}
.row{display:flex;gap:8px}.row>button{flex:1}
.mini{padding:6px 10px;border-radius:8px;background:var(--ctrl);border:1px solid #334155}
.seg{display:flex;gap:8px}
.seg button{flex:1;padding:8px 10px;border-radius:10px;background:#142033;border:1px solid #334155;color:#cbd5e1}
.seg button.on{background:#1f2c43;color:#fff;border-color:#47618e}
details{border:1px solid #162235;border-radius:10px;padding:8px;background:#0b1426;margin-top:8px}
summary{cursor:pointer;font-weight:600;color:#dbe7ff}
#log{background:#0b1220;border:1px solid #1f2937;min-height:90px;max-height:130px;overflow:auto;border-radius:8px;padding:8px;font-size:12px;white-space:pre-wrap}
#msg{position:fixed;bottom:10px;left:12px;background:rgba(15,23,42,.75);border:1px solid #334155;border-radius:8px;padding:6px 10px;font-size:12px;z-index:25}
optgroup{color:#9fb0c9;font-style:normal}

/* ROM modal â€” single collapsible column */
.modal{position:fixed;right:16px;bottom:16px;width:min(560px,92vw);max-height:78vh;z-index:30;background:rgba(8,13,26,.96);border:1px solid #334155;border-radius:12px;backdrop-filter:blur(6px);display:none;flex-direction:column;overflow:hidden}
.modal.on{display:flex}
.modal .top{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid #1f2a40;background:#0c1628}
.modal .top h4{margin:0;font-size:14px}
.modal .x{margin-left:auto;background:transparent;border:0;color:#9fb0c9;font-size:18px;cursor:pointer}
.rom-scroll{overflow:auto;padding:12px}
.rom-item{border:1px solid #2a3a55;border-radius:10px;background:#101a2e;margin:8px 0}
.rom-item summary{padding:10px 12px;list-style:none}
.rom-item summary::-webkit-details-marker{display:none}
.rom-item .inner{padding:8px 12px;border-top:1px solid #1c2941}
.rom-row{display:flex;gap:10px;font-size:13px;padding:4px 0}
.rom-head{font-weight:700}
.badge{display:inline-block;padding:2px 6px;border-radius:6px;border:1px solid #2a3a55;background:#132038;color:#cbd5e1;font-size:11px;margin-left:6px}
</style>
</head>
<body>
  <div class="panel" id="panel">
    <div class="dragbar" id="dragbar">ðŸ§­ Joint Lab <span class="hint">drag me</span></div>
    <div class="content">
      <div class="row">
        <button id="reload" class="mini">Reload Model</button>
        <button id="romBtn" class="mini">ðŸ“˜ ROM Reference</button>
      </div>
      <label>Body Region</label>
      <div class="seg">
        <button id="segUpper" class="on">Upper Body</button>
        <button id="segLower">Lower Body</button>
      </div>

      <label>Motion</label>
      <select id="actionSel"></select>

      <label><span id="pairLabel">Angle (Â°)</span></label>
      <input type="range" id="actionDeg" min="-90" max="150" step="1" value="0">
      <div class="row">
        <button id="zeroAction" class="mini">Zero Motion</button>
      </div>

      <details>
        <summary>Bone (Advanced)</summary>
        <label>Bone (auto-detected)</label>
        <select id="boneSel"></select>
        <div class="row">
          <div style="flex:1">
            <label>Rotate X (Â°)</label>
            <input type="range" min="-180" max="180" step="1" value="0" id="rx">
          </div>
          <div style="flex:1">
            <label>Rotate Y (Â°)</label>
            <input type="range" min="-180" max="180" step="1" value="0" id="ry">
          </div>
        </div>
        <label>Rotate Z (Â°)</label>
        <input type="range" min="-180" max="180" step="1" value="0" id="rz">
        <div class="row"><button id="zeroBone" class="mini">Zero Bone</button></div>
      </details>

      <details>
        <summary>Model (no rig required)</summary>
        <div class="row">
          <div style="flex:1">
            <label>Model X (m)</label>
            <input type="range" min="-2" max="2" step="0.01" value="0" id="mx">
          </div>
          <div style="flex:1">
            <label>Model Z (m)</label>
            <input type="range" min="-2" max="2" step="0.01" value="0.6" id="mz">
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label>Model Y (m)</label>
            <input type="range" min="-0.2" max="0.6" step="0.005" value="0" id="my">
          </div>
          <div style="flex:1">
            <label>Scale (%)</label>
            <input type="range" min="40" max="200" step="1" value="62" id="ms">
          </div>
        </div>
        <label>Yaw (Â°)</label>
        <input type="range" min="0" max="360" step="1" value="0" id="myaw">
        <div class="row"><button id="resetModel" class="mini">Reset Model</button></div>
      </details>

      <label>Event Log</label>
      <pre id="log"></pre>
    </div>
  </div>

  <!-- ROM Reference Modal â€” one collapsible column -->
  <div class="modal" id="romModal" aria-modal="true" role="dialog">
    <div class="top">
      <h4>ROM Reference</h4>
      <button class="x" id="romClose" aria-label="Close">âœ•</button>
    </div>
    <div class="rom-scroll" id="romScroll"></div>
  </div>

  <div id="msg">Loadingâ€¦</div>
  <canvas id="c"></canvas>

  <script type="module">
  import * as THREE from "three";
  import { OrbitControls } from "three/addons/controls/OrbitControls.js";
  import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
  import { DRACOLoader } from "three/addons/loaders/DRACOLoader.js";
  import { KTX2Loader } from "three/addons/loaders/KTX2Loader.js";
  import { MeshoptDecoder } from "three/addons/libs/meshopt_decoder.module.js";

  /* ===== UI ===== */
  const msg = document.getElementById("msg");
  const logEl = document.getElementById("log");
  const log = (t)=>{ logEl.textContent += t + "\\n"; logEl.scrollTop = logEl.scrollHeight; };

  const panel = document.getElementById("panel");
  const dragbar = document.getElementById("dragbar");
  const reloadBtn = document.getElementById("reload");
  const romBtn = document.getElementById("romBtn");
  const romModal = document.getElementById("romModal");
  const romClose = document.getElementById("romClose");
  const romScroll = document.getElementById("romScroll");

  const segUpper = document.getElementById("segUpper");
  const segLower = document.getElementById("segLower");

  const actionSel = document.getElementById("actionSel");
  const actionDeg = document.getElementById("actionDeg");
  const pairLabel = document.getElementById("pairLabel");
  const zeroAction = document.getElementById("zeroAction");

  const boneSel = document.getElementById("boneSel");
  const rx = document.getElementById("rx");
  const ry = document.getElementById("ry");
  const rz = document.getElementById("rz");
  const zeroBone = document.getElementById("zeroBone");

  const mx = document.getElementById("mx");
  const my = document.getElementById("my");
  const mz = document.getElementById("mz");
  const ms = document.getElementById("ms");
  const myaw = document.getElementById("myaw");
  const resetModel = document.getElementById("resetModel");

  /* ===== Draggable panel ===== */
  (function(){
    let dragging=false, sx=0, sy=0, startLeft=0, startTop=0;
    const onDown = (e)=>{ dragging=true; sx=e.clientX; sy=e.clientY;
      const r = panel.getBoundingClientRect();
      startLeft = r.left; startTop = r.top;
      e.preventDefault();
    };
    const onMove = (e)=>{ if(!dragging) return;
      const dx = e.clientX - sx, dy = e.clientY - sy;
      panel.style.left = Math.max(8, startLeft + dx) + "px";
      panel.style.top = Math.max(8, startTop + dy) + "px";
    };
    const onUp = ()=>{ dragging = false; };
    dragbar.addEventListener("pointerdown", onDown);
    window.addEventListener("pointermove", onMove);
    window.addEventListener("pointerup", onUp);
  })();

  /* ===== Three setup ===== */
  const canvas = document.getElementById("c");
  const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
  renderer.setPixelRatio(devicePixelRatio);
  renderer.setSize(innerWidth, innerHeight);
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0b1220);

  const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.01, 100);
  camera.position.set(1.6, 1.6, 3.2);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true; controls.dampingFactor = 0.08;
  controls.minDistance = 0.6; controls.maxDistance = 6;
  controls.target.set(0,1.1,0);

  scene.add(new THREE.HemisphereLight(0xffffff, 0x333344, 0.7));
  const key = new THREE.DirectionalLight(0xffffff, 1.2);
  key.position.set(2.5,4,2.5);
  key.castShadow = true;
  key.shadow.mapSize.set(2048,2048);
  key.shadow.camera.near = 0.1; key.shadow.camera.far = 15;
  key.shadow.camera.left = -4; key.shadow.camera.right = 4; key.shadow.camera.top = 4; key.shadow.camera.bottom = -4;
  scene.add(key);

  const ground = new THREE.Mesh(new THREE.PlaneGeometry(20,20), new THREE.ShadowMaterial({ opacity: 0.45 }));
  ground.rotation.x = -Math.PI/2; ground.receiveShadow = true; scene.add(ground);

  /* ===== Loader (same as working build) ===== */
  const loader = new GLTFLoader();
  loader.setMeshoptDecoder(MeshoptDecoder);
  const draco = new DRACOLoader(); draco.setDecoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/"); loader.setDRACOLoader(draco);
  const ktx2 = new KTX2Loader(); ktx2.setTranscoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/basis/"); ktx2.detectSupport(renderer); loader.setKTX2Loader(ktx2);

  let model = null, skeleton = null;
  const initialBoneRot = new Map();

  function pickModelUrl(){
    const u = new URL(location.href);
    const q = u.searchParams.get("model");
    if (q && /^https?:\/\//i.test(q)) return q;
    if (q && q.trim()) return new URL(q, location.href).href;
    return "./Athletic_Grace_1006002620_texture.glb";
  }
  let MODEL_URL = pickModelUrl();

  function groundSnap(){
    if (!model) return;
    const box = new THREE.Box3().setFromObject(model);
    const minY = box.min.y;
    if (isFinite(minY)) model.position.y -= minY;
  }

  /* ===== Joint definitions (used for menu + ROM) ===== */
  const UPPER = [
    {key:'trunk_fe',  pair:'Trunk â€” Flex / Ext',            side:'', plane:'Sagittal',   neutral:0, min:-60, max:80,  hints:[/spine|chest|thor/i]},
    {key:'trunk_lat', pair:'Trunk â€” Lateral Bend (L / R)',  side:'', plane:'Frontal',    neutral:0, min:-40, max:40,  hints:[/spine|chest|thor/i]},
    {key:'trunk_rot', pair:'Trunk â€” Rotation (L / R)',      side:'', plane:'Transverse', neutral:0, min:-45, max:45,  hints:[/spine|chest|thor/i]},
    {key:'cerv_fe',   pair:'Cervical Flex / Ext',           side:'', plane:'Sagittal',   neutral:0, min:-60, max:70,  hints:[/neck|cspine|head/i]},
    {key:'cerv_lat',  pair:'Cervical Lat Flex (L / R)',     side:'', plane:'Frontal',    neutral:0, min:-45, max:45,  hints:[/neck|cspine|head/i]},
    {key:'cerv_rot',  pair:'Cervical Rotation (L / R)',     side:'', plane:'Transverse', neutral:0, min:-80, max:80,  hints:[/neck|cspine|head/i]},
    {key:'sh_fe_l',   pair:'Shoulder L â€” Flex / Ext',       side:'l', plane:'Sagittal',  neutral:0, min:-180, max:60, hints:[/upper.?arm|humerus|shoulder|arm(?!.*lower)/i]},
    {key:'sh_fe_r',   pair:'Shoulder R â€” Flex / Ext',       side:'r', plane:'Sagittal',  neutral:0, min:-180, max:60, hints:[/upper.?arm|humerus|shoulder|arm(?!.*lower)/i]},
    {key:'sh_aa_l',   pair:'Shoulder L â€” Abd / Add',        side:'l', plane:'Frontal',   neutral:0, min:-180, max:40, hints:[/upper.?arm|humerus|shoulder|arm(?!.*lower)/i]},
    {key:'sh_aa_r',   pair:'Shoulder R â€” Abd / Add',        side:'r', plane:'Frontal',   neutral:0, min:-180, max:40, hints:[/upper.?arm|humerus|shoulder|arm(?!.*lower)/i]},
    {key:'sh_irer_l', pair:'Shoulder L â€” Internal / External', side:'l', plane:'Transverse', neutral:0, min:-70, max:90, hints:[/upper.?arm|humerus|shoulder|arm(?!.*lower)/i]},
    {key:'sh_irer_r', pair:'Shoulder R â€” Internal / External', side:'r', plane:'Transverse', neutral:0, min:-70, max:90, hints:[/upper.?arm|humerus|shoulder|arm(?!.*lower)/i]},
    {key:'el_fe_l',   pair:'Elbow L â€” Flex / Ext',          side:'l', plane:'Sagittal',  neutral:0, min:-150, max:10, hints:[/lower.?arm|forearm|ulna|radius/i]},
    {key:'el_fe_r',   pair:'Elbow R â€” Flex / Ext',          side:'r', plane:'Sagittal',  neutral:0, min:-150, max:10, hints:[/lower.?arm|forearm|ulna|radius/i]},
    {key:'fa_ps_l',   pair:'Forearm L â€” Pronation / Supination', side:'l', plane:'Transverse', neutral:0, min:-85, max:95, hints:[/lower.?arm|forearm|ulna|radius/i]},
    {key:'fa_ps_r',   pair:'Forearm R â€” Pronation / Supination', side:'r', plane:'Transverse', neutral:0, min:-85, max:95, hints:[/lower.?arm|forearm|ulna|radius/i]},
    {key:'wr_fe_l',   pair:'Wrist L â€” Flex / Ext',          side:'l', plane:'Sagittal',  neutral:0, min:-80, max:70, hints:[/wrist|hand(?!.*thumb|.*index|.*middle|.*ring|.*pinky)/i]},
    {key:'wr_fe_r',   pair:'Wrist R â€” Flex / Ext',          side:'r', plane:'Sagittal',  neutral:0, min:-80, max:70, hints:[/wrist|hand(?!.*thumb|.*index|.*middle|.*ring|.*pinky)/i]},
    {key:'wr_ru_l',   pair:'Wrist L â€” Radial / Ulnar Dev',  side:'l', plane:'Frontal',   neutral:0, min:-20, max:40, hints:[/wrist|hand(?!.*thumb|.*index|.*middle|.*ring|.*pinky)/i]},
    {key:'wr_ru_r',   pair:'Wrist R â€” Radial / Ulnar Dev',  side:'r', plane:'Frontal',   neutral:0, min:-20, max:40, hints:[/wrist|hand(?!.*thumb|.*index|.*middle|.*ring|.*pinky)/i]},
  ];
  const LOWER = [
    {key:'hip_fe_l',   pair:'Hip L â€” Flex / Ext',            side:'l', plane:'Sagittal',  neutral:0, min:-120, max:30, hints:[/upper.?leg|thigh|femur/i]},
    {key:'hip_fe_r',   pair:'Hip R â€” Flex / Ext',            side:'r', plane:'Sagittal',  neutral:0, min:-120, max:30, hints:[/upper.?leg|thigh|femur/i]},
    {key:'hip_aa_l',   pair:'Hip L â€” Abd / Add',             side:'l', plane:'Frontal',   neutral:0, min:-45,  max:30, hints:[/upper.?leg|thigh|femur/i]},
    {key:'hip_aa_r',   pair:'Hip R â€” Abd / Add',             side:'r', plane:'Frontal',   neutral:0, min:-45,  max:30, hints:[/upper.?leg|thigh|femur/i]},
    {key:'hip_irer_l', pair:'Hip L â€” Internal / External',   side:'l', plane:'Transverse',neutral:0, min:-45,  max:45, hints:[/upper.?leg|thigh|femur/i]},
    {key:'hip_irer_r', pair:'Hip R â€” Internal / External',   side:'r', plane:'Transverse',neutral:0, min:-45,  max:45, hints:[/upper.?leg|thigh|femur/i]},
    {key:'knee_fe_l',  pair:'Knee L â€” Flex / Ext',           side:'l', plane:'Sagittal',  neutral:0, min:-150, max:5,  hints:[/lower.?leg|calf|shin|tibia|fibula/i]},
    {key:'knee_fe_r',  pair:'Knee R â€” Flex / Ext',           side:'r', plane:'Sagittal',  neutral:0, min:-150, max:5,  hints:[/lower.?leg|calf|shin|tibia|fibula/i]},
    {key:'ankle_dfpf_l', pair:'Ankle L â€” Dorsi / Plantarflex', side:'l', plane:'Sagittal',  neutral:0, min:-20,  max:50, hints:[/ankle|foot|talus|tarsal/i]},
    {key:'ankle_dfpf_r', pair:'Ankle R â€” Dorsi / Plantarflex', side:'r', plane:'Sagittal',  neutral:0, min:-20,  max:50, hints:[/ankle|foot|talus|tarsal/i]},
    {key:'foot_invev_l', pair:'Foot L â€” Inversion / Eversion', side:'l', plane:'Frontal',   neutral:0, min:-20,  max:35, hints:[/foot|calcaneus|heel|metatars/i]},
    {key:'foot_invev_r', pair:'Foot R â€” Inversion / Eversion', side:'r', plane:'Frontal',   neutral:0, min:-20,  max:35, hints:[/foot|calcaneus|heel|metatars/i]},
  ];

  /* ===== ROM modal content (single column; collapsible) ===== */
  function renderRom(){
    const makeItem = (obj)=>{
      const el = document.createElement('details');
      el.className = 'rom-item';
      const side = (obj.side||'â€”').toUpperCase();
      el.innerHTML = \`
        <summary>\${obj.pair} <span class="badge">\${obj.plane} plane</span> <span class="badge">Side: \${side}</span></summary>
        <div class="inner">
          <div class="rom-row"><div class="rom-head">Expected ROM (Â°)</div><div>\${obj.min} to \${obj.max}</div></div>
        </div>\`;
      return el;
    };
    romScroll.innerHTML = '';
    const title = document.createElement('div');
    title.style.padding = '0 4px 6px 4px';
    title.style.fontWeight = '700';
    title.textContent = 'All Motions';
    romScroll.appendChild(title);
    [...UPPER, ...LOWER].forEach(obj => romScroll.appendChild(makeItem(obj)));
  }

  /* ===== UI: actions ===== */
  function fillActionMenu(){
    actionSel.innerHTML = "";
    const ph = document.createElement("option");
    ph.value = ""; ph.textContent = "(Select a motionâ€¦)";
    actionSel.appendChild(ph);

    const list = (CURRENT===UPPER) ? UPPER : LOWER;
    const og = document.createElement("optgroup");
    og.label = (CURRENT===UPPER) ? "Cervical, Trunk, Shoulder & Arm" : "Hip, Leg & Foot";
    for (const item of list){
      const opt = document.createElement("option");
      opt.value = item.key;
      opt.textContent = item.pair;
      og.appendChild(opt);
    }
    actionSel.appendChild(og);

    actionSel.value = "";
    pairLabel.textContent = "Angle (Â°)";
    actionDeg.disabled = true;
    zeroAction.disabled = true;
  }
  function cfgFromKey(k){
    const list = (CURRENT===UPPER) ? UPPER : LOWER;
    return list.find(x=>x.key===k) || null;
  }
  function syncActionUI(forceZero=false){
    const key = actionSel.value;
    const cfg = cfgFromKey(key);
    if (!cfg){
      actionDeg.disabled = true;
      zeroAction.disabled = true;
      pairLabel.textContent = "Angle (Â°)";
      return;
    }
    pairLabel.textContent = cfg.pair + " â€” Angle (Â°)";
    actionDeg.min = String(cfg.min);
    actionDeg.max = String(cfg.max);
    if (forceZero) actionDeg.value = "0";
    actionDeg.disabled = false;
    zeroAction.disabled = false;
  }

  let CURRENT = UPPER;
  segUpper.onclick = ()=>{ CURRENT = UPPER; segUpper.classList.add('on'); segLower.classList.remove('on'); fillActionMenu(); actionDeg.value='0'; actionDeg.disabled=true; zeroAction.disabled=true; };
  segLower.onclick = ()=>{ CURRENT = LOWER; segLower.classList.add('on'); segUpper.classList.remove('on'); fillActionMenu(); };

  actionSel.addEventListener("change", ()=>syncActionUI(true));

  /* ===== Minimal motion apply (kept simple) ===== */
  const JOINT_BIND = new Map();
  const EXCLUDE = /(pelvis|root|spine|clavicle|scapula)/i;
  function sideRegex(side){
    if (!side) return [/.*/];
    if (side==='l'){ return [/\.l\b/i, /_l\b/i, /\bleft\b/i, /mixamorig:.*left/i]; }
    return [/\.r\b/i, /_r\b/i, /\bright\b/i, /mixamorig:.*right/i];
  }
  function findBoneBy(cfg){
    if (!skeleton) return null;
    const names = skeleton.bones.map(b=>b.name.toLowerCase());
    const sideREs = sideRegex(cfg.side);
    for (const cand of cfg.hints){
      for (let i=0;i<names.length;i++){
        if (EXCLUDE.test(names[i])) continue;
        if (!sideREs.some(r=>r.test(names[i]))) continue;
        if (cand.test(names[i])) return skeleton.bones[i];
      }
    }
    return null;
  }
  function resolveBind(key,cfg){
    if (JOINT_BIND.has(key)) return JOINT_BIND.get(key);
    const bone = findBoneBy(cfg);
    if (!bone){ console.warn('No bind for', key); return null; }
    const axis = ({Sagittal:'x', Frontal:'z', Transverse:'y'})[cfg.plane] || 'x';
    const qBind = bone.quaternion.clone();
    const o = {bone, axis, qBind};
    JOINT_BIND.set(key,o);
    return o;
  }
  function applyPairAngle(key,cfg,deg){
    const o = resolveBind(key,cfg); if(!o) return;
    const e = new THREE.Euler(0,0,0,"XYZ");
    const r = THREE.MathUtils.degToRad(deg + (cfg.neutral||0));
    if (o.axis==='x') e.set(r,0,0,"XYZ");
    if (o.axis==='y') e.set(0,r,0,"XYZ");
    if (o.axis==='z') e.set(0,0,r,"XYZ");
    const q = new THREE.Quaternion().setFromEuler(e);
    o.bone.quaternion.copy(o.qBind).multiply(q);
  }
  actionDeg.addEventListener("input", ()=>{
    const key = actionSel.value; const cfg = cfgFromKey(key);
    if (cfg) applyPairAngle(key,cfg, parseFloat(actionDeg.value)||0);
  });
  zeroAction.onclick = ()=>{ const key = actionSel.value; const cfg = cfgFromKey(key); if (!cfg) return; actionDeg.value="0"; applyPairAngle(key,cfg,0); };

  /* ===== Populate bones (minimal) ===== */
  function populateBones(){
    boneSel.innerHTML = "";
    if (!skeleton) { const o=document.createElement('option'); o.value=""; o.textContent="(No skeleton)"; boneSel.appendChild(o); return; }
    skeleton.bones.forEach((b,i)=>{
      const o=document.createElement('option'); o.value=String(i); o.textContent=b.name||`Bone ${i}`; boneSel.appendChild(o);
    });
  }
  boneSel.onchange = ()=>{}; // keep quiet; advanced bone is optional

  /* ===== Load model ===== */
  function clearModel(){
    if (model) scene.remove(model);
    model = null; skeleton = null;
    boneSel.innerHTML = "";
  }
  function loadModel(){
    msg.textContent = "Loadingâ€¦"; log("Loading model...");
    clearModel();
    loader.load(
      MODEL_URL,
      (gltf) => {
        model = gltf.scene;
        model.traverse(o => {
          if (o.isMesh) { o.castShadow = true; o.receiveShadow = true; }
          if (o.isSkinnedMesh && !skeleton) skeleton = o.skeleton;
        });
        scene.add(model);
        model.position.set(parseFloat(mx.value), parseFloat(my.value), parseFloat(mz.value));
        model.scale.setScalar(parseInt(ms.value,10)/100); // default 62%
        model.rotation.y = THREE.MathUtils.degToRad(parseFloat(myaw.value));
        groundSnap();
        msg.textContent = "âœ… Model loaded";
        log("Model load OK");
        populateBones();
        fillActionMenu();
      },
      (xhr) => {
        msg.textContent = xhr.lengthComputable ? `Loading ${Math.round((xhr.loaded/xhr.total)*100)}%` : "Loadingâ€¦";
      },
      (err) => {
        console.error(err);
        msg.textContent = "âš ï¸ Load error";
        log(`Error: ${err?.message || err}`);
      }
    );
  }
  loadModel();

  // Reset model uses +25% scale too
  resetModel.onclick = ()=>{
    mx.value="0"; my.value="0"; mz.value="0.6"; ms.value="62"; myaw.value="0";
    if (model){
      model.position.set(0,0,0.6);
      model.scale.setScalar(0.62);
      model.rotation.y = 0;
    }
    groundSnap();
  };

  reloadBtn.onclick = ()=>{ MODEL_URL = (new URL(location.href)).searchParams.get("model") || MODEL_URL; loadModel(); };

  /* ===== ROM Modal wiring (single column) ===== */
  romBtn.onclick = ()=>{ renderRom(); romModal.classList.add('on'); };
  romClose.onclick = ()=> romModal.classList.remove('on');

  /* ===== Render ===== */
  addEventListener("resize", () => {
    camera.aspect = innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
  });
  (function animate(){
    controls.update();
    renderer.render(scene, camera);
    requestAnimationFrame(animate);
  })();
  </script>
</body>
</html>
