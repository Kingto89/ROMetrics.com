<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PT Lab ‚Äî Goniometry Trainer (Dots Immediate)</title>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

<style>
  html,body{margin:0;height:100%;background:#0b1220;color:#e5e7eb;overflow:hidden;font-family:system-ui,Segoe UI,Roboto}
  canvas{position:fixed; inset:0; z-index:0; width:100%; height:100%; display:block}

  .panel{
    position:fixed; left:0; top:0; bottom:0; width:360px;
    background:#0f172a; border-right:1px solid #1f2937; padding:14px; overflow:auto; z-index:50;
  }
  h3{margin:8px 0 12px 0}
  label{display:block;font-size:13px;margin-top:10px;color:#cbd5e1}
  select,button,input[type=range]{width:100%;margin:6px 0 8px 0;padding:8px 10px;border-radius:10px;background:#1e293b;border:1px solid #334155;color:#e2e8f0}
  .row{display:flex;gap:8px}.row>button{flex:1}
  #log{background:#0b1220;border:1px solid #1f2937;height:130px;overflow:auto;border-radius:8px;padding:8px}
  .hide{display:none}.lockOn{background:#0b3a1f;border-color:#16a34a}

  .pill{
    display:flex; flex-direction:column; align-items:center; gap:4px;
    border:2px solid #334155; border-radius:12px; padding:8px 6px; line-height:1; user-select:none;
    transition: box-shadow .15s, border-color .15s, transform .08s;
  }
  .pill .top{display:flex; align-items:center; gap:6px; font-weight:700}
  .pill .dot{width:10px; height:10px; border-radius:999px; display:inline-block}
  .pill.orange{border-color:#f59e0b}.pill .dot.orange{background:#f59e0b}
  .pill.red{border-color:#ef4444}.pill .dot.red{background:#ef4444}
  .pill.green{border-color:#22c55e}.pill .dot.green{background:#22c55e}
  .pill.active{box-shadow:0 0 0 3px rgba(59,130,246,.35) inset; transform: translateY(-1px);}

  .hud,.toast,#msg{z-index:40}
  .hud{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:rgba(15,23,42,.75);border:1px solid #334155;border-radius:10px;padding:6px 10px;font-weight:700;backdrop-filter:blur(6px)}
  .toast{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(2,6,23,.7);border:1px solid #334155;border-radius:10px;padding:6px 10px;font-size:13px;display:none}
  #msg{position:fixed;top:10px;left:10px;background:rgba(15,23,42,.7);border:1px solid #334155;border-radius:8px;padding:6px 10px;font-size:13px}

  details{border:1px solid #1f2937; border-radius:10px; padding:6px 8px; background:#0b1220}
  details+details{margin-top:8px}
  summary{cursor:pointer; font-weight:600; color:#e2e8f0}
  .group{padding:6px 4px}

  .note{
    position:fixed; right:16px; bottom:16px; width:min(520px, 90vw);
    background:rgba(2,6,23,.9); border:1px solid #334155; border-radius:12px;
    padding:14px 46px 14px 14px; z-index:45; backdrop-filter: blur(6px);
  }
  .note .x{ position:absolute; top:8px; right:10px; width:auto; background:transparent; border:0; color:#94a3b8; font-size:18px; cursor:pointer; }
  .note.hide{display:none}

  /* SVG overlay for dots + goniometer */
  #gonioHost{position:fixed; inset:0; z-index:30; pointer-events:none}
  #gonioHost svg{width:100vw;height:100vh;background:transparent;pointer-events:auto}
  .tick{stroke:#64748b;stroke-width:.9}.tickBig{stroke-width:1.6}
  .labelOuter{fill:#e5e7eb;font-size:11px;text-anchor:middle;dominant-baseline:middle;paint-order:stroke;stroke:#0b1220;stroke-width:3px}
  .labelInner{fill:#fca5a5;font-size:8.2px;text-anchor:middle;dominant-baseline:middle;paint-order:stroke;stroke-width:3px;stroke:#0b1220}
  .rulerTick{stroke:#94a3b8}
  .ruLbl{fill:#cbd5e1;font-size:9.5px;dominant-baseline:middle;paint-order:stroke;stroke:#0b1220;stroke-width:3px}
  .scrLine{stroke-width:2.2; stroke-linecap:round}
  .cursor-armed{cursor: crosshair !important;}
</style>
</head>
<body>
<div class="panel">
  <h3>Goniometry Trainer</h3>

  <label>Region</label>
  <select id="regionSel">
    <option value="cervical_spine">Cervical Spine</option>
    <option value="thoracic_lumbar_spine">Thoracic & Lumbar Spine</option>
    <option value="glenohumeral_joint">Glenohumeral Joint</option>
    <option value="elbow_radioulnar">Elbow & Radioulnar Joints</option>
    <option value="wrist">Wrist</option>
    <option value="hip">Hip</option>
    <option value="knee">Knee</option>
    <option value="talocrural_ankle">Talocrural (Ankle)</option>
    <option value="transverse_tarsal_subtalar">Transverse Tarsal & Subtalar</option>
    <option value="fingers_mcp_pip_dip">Fingers (MCP, PIP, DIP)</option>
    <option value="thumb_cmc_mcp_ip">Thumb (CMC, MCP, IP)</option>
    <option value="toes_mtp_pip_dip">Toes (MTP, PIP, DIP)</option>
  </select>

  <label>Motion</label>
  <select id="motionSel"></select>

  <div class="row">
    <button id="showNote">üìå Show goniometer placement</button>
  </div>

  <div class="row">
    <button class="pill orange" id="pickFulcrum">
      <div class="top"><span class="dot orange"></span><span>1</span></div>
      <div class="label">Fulcrum</div>
    </button>
    <button class="pill red" id="pickStationary">
      <div class="top"><span class="dot red"></span><span>2</span></div>
      <div class="label">Stationary</div>
    </button>
    <button class="pill green" id="pickMoving">
      <div class="top"><span class="dot green"></span><span>3</span></div>
      <div class="label">Moving</div>
    </button>
  </div>

  <label>Range of Motion</label>
  <div class="row">
    <button id="startROM">‚ñ∂Ô∏è Start ROM</button>
    <button id="resetROM">‚Ü∫ Reset ROM</button>
    <button id="resetMeasurement" title="Clear dots + lines + goniometer">üßπ Reset Measurement</button>
  </div>

  <label>Event Log</label>
  <pre id="log"></pre>
</div>

<!-- SVG overlay -->
<div id="gonioHost" class="hide" aria-hidden="true">
  <svg id="gonioSvg" aria-label="Universal goniometer">
    <g id="screenDots">
      <line id="scrLineA" class="scrLine" stroke="#ef4444" x1="0" y1="0" x2="0" y2="0" style="display:none"/>
      <line id="scrLineB" class="scrLine" stroke="#22c55e" x1="0" y1="0" x2="0" y2="0" style="display:none"/>
      <circle id="scrFulcrum" r="6" fill="#f59e0b" cx="-100" cy="-100" style="display:none"/>
      <circle id="scrStationary" r="6" fill="#ef4444" cx="-100" cy="-100" style="display:none"/>
      <circle id="scrMoving" r="6" fill="#22c55e" cx="-100" cy="-100" style="display:none"/>
    </g>
    <g id="viewport" transform="translate(0,0) scale(1)">
      <g id="rotWrap" transform="rotate(0)">
        <g id="instrument"><!-- head + arms -->
          <g id="head">
            <circle r="120" fill="none" stroke="#94a3b8" stroke-width="1.6"/>
            <circle r="86"  fill="none" stroke="#94a3b8" stroke-width="0.9" opacity="0.65"/>
            <g id="ticks"></g>
            <g id="labelsFixed">
              <g id="numsOut"></g>
              <g id="numsInWrap"><g id="numsIn"></g></g>
            </g>
            <circle r="3.2" fill="#94a3b8"/>
          </g>
          <g id="armA_grp">
            <rect x="-10" y="120" width="20" height="260" rx="10" stroke="#ef4444" fill="none" stroke-width="3" />
            <line id="axisA" x1="0" y1="380" x2="0" y2="-116" stroke="#ef4444" stroke-width="1.6" opacity=".85" stroke-linecap="round"/>
            <g id="armA_ruler"></g>
            <circle id="armA_knob" cx="0" cy="380" r="10" fill="#ef4444"/>
          </g>
          <g id="armB_grp">
            <rect x="-10" y="-380" width="20" height="500" rx="10" stroke="#22c55e" fill="none" stroke-width="3"/>
            <line id="axisB" x1="0" y1="-380" x2="0" y2="124" stroke="#22c55e" stroke-width="1.6" opacity=".85" stroke-linecap="round"/>
            <g id="armB_ruler"></g>
            <circle id="armB_knob" cx="0" cy="-380" r="10" fill="#22c55e"/>
          </g>
        </g>
      </g>
    </g>
  </svg>
</div>

<div id="msg">Loading‚Ä¶</div>
<div class="hud" id="hud">Angle: 0¬∞</div>
<canvas id="c"></canvas>

<div id="note" class="note hide">
  <button class="x" id="noteClose">‚úï</button>
  <h4 id="noteTitle">Note</h4>
  <div id="noteBody" class="md">Loading‚Ä¶</div>
</div>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "three/addons/controls/OrbitControls.js";
import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
import { DRACOLoader } from "three/addons/loaders/DRACOLoader.js";
import { KTX2Loader } from "three/addons/loaders/KTX2Loader.js";
import { MeshoptDecoder } from "three/addons/libs/meshopt_decoder.module.js";

/* UI refs */
const logEl = document.getElementById("log");
const msg = document.getElementById("msg");
const hud = document.getElementById("hud");
const note = document.getElementById("note");
document.getElementById("noteClose").onclick = ()=> note.classList.add("hide");
const regionSel = document.getElementById("regionSel");
const motionSel = document.getElementById("motionSel");
const resetMeasurementBtn = document.getElementById("resetMeasurement");
const startROMBtn = document.getElementById("startROM");
const resetROMBtn = document.getElementById("resetROM");
const pickFulcrum = document.getElementById("pickFulcrum");
const pickStationary = document.getElementById("pickStationary");
const pickMoving = document.getElementById("pickMoving");

/* helpers */
const log = (t)=>{ logEl.textContent += t + "\\n"; logEl.scrollTop = logEl.scrollHeight; };

/* motions */
const REGION_MOTIONS = { cervical_spine:["Flexion","Extension","Lateral Flexion","Rotation"], thoracic_lumbar_spine:["Flexion","Extension","Lateral Flexion","Rotation"], glenohumeral_joint:["Flexion","Extension","Abduction","Internal Rotation","External Rotation"], elbow_radioulnar:["Flexion","Extension","Pronation","Supination"], wrist:["Flexion","Extension","Radial Deviation","Ulnar Deviation"], hip:["Flexion","Extension","Abduction","Adduction","Internal Rotation","External Rotation"], knee:["Flexion","Extension"], talocrural_ankle:["Dorsiflexion","Plantarflexion"], transverse_tarsal_subtalar:["Inversion","Eversion"], fingers_mcp_pip_dip:["MCP Flexion","MCP Extension","PIP Flexion","PIP Extension","DIP Flexion","DIP Extension"], thumb_cmc_mcp_ip:["CMC Flexion","CMC Extension","CMC Abduction","CMC Adduction","MCP Flexion","MCP Extension","IP Flexion","IP Extension"], toes_mtp_pip_dip:["MTP Flexion","MTP Extension","PIP Flexion","PIP Extension","DIP Flexion","DIP Extension"] };
function refreshMotions(){ const list = REGION_MOTIONS?.[regionSel.value] || []; motionSel.innerHTML=""; (list.length?list:["(No motions)"]).forEach(t=>{ const o=document.createElement("option"); o.value=t; o.textContent=t; motionSel.appendChild(o); }); }
refreshMotions(); regionSel.onchange = refreshMotions;

/* three.js setup */
const canvas = document.getElementById("c");
const renderer = new THREE.WebGLRenderer({ canvas, antialias:true });
renderer.setPixelRatio(devicePixelRatio); renderer.setSize(innerWidth, innerHeight);
renderer.outputColorSpace = THREE.SRGBColorSpace; renderer.toneMapping = THREE.ACESFilmicToneMapping;

const scene = new THREE.Scene(); scene.background = new THREE.Color(0x0b1220);
const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.01, 100);
camera.position.set(1.6, 1.6, 2.8);
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true; controls.dampingFactor = 0.08; controls.minDistance=0.8; controls.maxDistance=6; controls.target.set(0,1.1,0);

scene.add(new THREE.HemisphereLight(0xffffff, 0x333344, 0.7));
const key = new THREE.DirectionalLight(0xffffff, 1.2); key.position.set(2.5,4,2.5); scene.add(key);

const groundGeo = new THREE.PlaneGeometry(20,20);
const groundMat = new THREE.ShadowMaterial({opacity:0.45});
const ground = new THREE.Mesh(groundGeo, groundMat); ground.rotation.x=-Math.PI/2; ground.receiveShadow=true; scene.add(ground);

/* model loader (kept same path as your recent builds) */
const loader = new GLTFLoader();
loader.setMeshoptDecoder(MeshoptDecoder);
const draco = new DRACOLoader(); draco.setDecoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/"); loader.setDRACOLoader(draco);
const ktx2 = new KTX2Loader(); ktx2.setTranscoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/basis/"); ktx2.detectSupport(renderer); loader.setKTX2Loader(ktx2);

let model = null;
const MODEL_URL = "./Athletic_Grace_1006002620_texture.glb";
function addFallback(){
  if (model) return;
  const g = new THREE.Group();
  const mat = new THREE.MeshStandardMaterial({color:0xa0a4ae, metalness:0.1, roughness:0.8});
  const mk = (geo,y,s=1)=>{ const m=new THREE.Mesh(geo,mat); m.position.y=y; m.scale.setScalar(s); g.add(m); };
  mk(new THREE.CapsuleGeometry(0.22,0.8,8,16), 1.1);
  mk(new THREE.SphereGeometry(0.16,16,16),        1.8);
  mk(new THREE.CylinderGeometry(0.1,0.12,0.3,12), 1.45);
  mk(new THREE.CylinderGeometry(0.11,0.11,0.8,12),0.55);
  scene.add(g); model=g; msg.textContent="‚ö†Ô∏è Using fallback mannequin (GLB not found).";
}
async function loadModel(){
  try {
    const head = await fetch(MODEL_URL, {method:"HEAD", cache:"no-store"});
    if (!head.ok) { addFallback(); return; }
  } catch { addFallback(); return; }
  loader.load(MODEL_URL, (gltf)=>{
    model = gltf.scene; scene.add(model); msg.textContent="‚úÖ Model loaded";
  }, undefined, ()=>{ addFallback(); });
}
loadModel();

/* overlay + goniometer */
const host = document.getElementById('gonioHost');
const svg = document.getElementById('gonioSvg');
const scr = { fulcrum:null, stationary:null, moving:null };
const scrFulcrum = document.getElementById('scrFulcrum');
const scrStationary = document.getElementById('scrStationary');
const scrMoving = document.getElementById('scrMoving');
const scrLineA = document.getElementById('scrLineA');
const scrLineB = document.getElementById('scrLineB');

function setDotEl(el, p){ if(!p){ el.style.display='none'; return; } el.setAttribute('cx', p.x); el.setAttribute('cy', p.y); el.style.display='block'; }
function setLineEl(el, a, b, color){ if(a&&b){ el.setAttribute('x1',a.x); el.setAttribute('y1',a.y); el.setAttribute('x2',b.x); el.setAttribute('y2',b.y); el.style.display='block'; if(color) el.setAttribute('stroke',color);} else el.style.display='none'; }

/* minimal goniometer engine for display */
const Gonio = (()=>{
  const viewport = document.getElementById('viewport');
  const rotWrap = document.getElementById('rotWrap');
  const labelsFixed = document.getElementById('labelsFixed');
  const armA_ruler = document.getElementById('armA_ruler');
  const armB_ruler = document.getElementById('armB_ruler');

  let zoom=1, panX=innerWidth/2, panY=innerHeight/2, baseRot=0, userRot=0, mov=30, scale=1, zeroRef=0;
  const clamp360=a=>(a%360+360)%360; const toDegUp=(x,y)=>clamp360(Math.atan2(-y,x)*180/Math.PI+90); const shortest=(a,b)=>{ let d=clamp360(a-b); return d>180?360-d:d; };

  (function buildTicks(){
    const ticks = document.getElementById('ticks');
    const numsOut = document.getElementById('numsOut');
    const numsIn = document.getElementById('numsIn');
    const R=120, Rin=86;
    const line=(p,x1,y1,x2,y2,cls)=>{ const n=document.createElementNS('http://www.w3.org/2000/svg','line'); n.setAttribute('x1',x1); n.setAttribute('y1',y1); n.setAttribute('x2',x2); n.setAttribute('y2',y2); if(cls)n.setAttribute('class',cls); p.appendChild(n); };
    const text=(p,x,y,t,cls,rot)=>{ const n=document.createElementNS('http://www.w3.org/2000/svg','text'); n.setAttribute('x',x); n.setAttribute('y',y); n.setAttribute('class',cls||'labelOuter'); if(rot)n.setAttribute('transform',`rotate(${rot} ${x} ${y})`); n.textContent=t; p.appendChild(n); return n; };
    for(let d=0; d<360; d+=5){ const a=(d-90)*Math.PI/180, big=d%30===0, len=big?12:6; line(ticks,Math.cos(a)*(R-len),Math.sin(a)*(R-len),Math.cos(a)*R,Math.sin(a)*R,big?'tick tickBig':'tick'); }
    const rWhite=R-8;
    for(let d=0; d<360; d+=10){ const diff90=Math.abs(((d-90)%360+540)%360-180); const diff270=Math.abs(((d-270)%360+540)%360-180); const val=Math.min(diff90,diff270); if(val%20===0 && val<=80){ const a=(d-90)*Math.PI/180,x=Math.cos(a)*rWhite,y=Math.sin(a)*rWhite; text(numsOut,x,y,String(val),'labelOuter'); } }
    const rInner=Rin+9, valFromTheta=th=>{const t=(th+180)%360; return t<=180?t:360-t;};
    for(let th=0; th<360; th+=10){ const v=valFromTheta(th); if(v%10!==0) continue; if(v===0 && th!==180) continue; const a=(th-90)*Math.PI/180,x=Math.cos(a)*rInner,y=Math.sin(a)*rInner; text(numsIn,x,y,String(v),'labelInner'); }
    armA_ruler.innerHTML=''; armB_ruler.innerHTML='';
  })();

  function applyView(){ viewport.setAttribute('transform',`translate(${panX},${panY}) scale(${zoom*scale})`); }
  function applyRot(){ rotWrap.setAttribute('transform',`rotate(${baseRot+userRot})`); labelsFixed.setAttribute('transform',`rotate(${-(baseRot+userRot)})`); }
  function render(){ document.getElementById('armA_grp').setAttribute('transform','rotate(0)'); document.getElementById('armB_grp').setAttribute('transform',`rotate(${mov})`); }
  function show(){ host.classList.remove('hide'); host.setAttribute('aria-hidden','false'); }
  function hide(){ /* keep overlay up for dots; do not hide host */ }
  function setPose(cx,cy,baseDeg,movDeg){ panX=cx; panY=cy; baseRot=baseDeg; mov=clamp360(movDeg-baseDeg); applyView(); applyRot(); render(); }
  function degFromScreenVec(dx,dy){ return toDegUp(dx,dy); }
  function zeroHere(){ zeroRef = clamp360(mov); }
  function setMovDegRel(deg){ mov = clamp360(zeroRef + deg); render(); }
  function setUserRot(deg){ userRot = clamp360(deg); applyRot(); render(); }
  function getUserRot(){ return (userRot%360+360)%360; }
  function setPan(x,y){ panX=x; panY=y; applyView(); }
  function getPan(){ return {x:panX,y:panY}; }
  const angle = ()=> shortest(mov, zeroRef);
  return { show, hide, setPose, degFromScreenVec, zeroHere, setMovDegRel, setUserRot, getUserRot, setPan, getPan, get angle(){ return angle(); } };
})();

/* state */
let target = null;
function arm(pill, key){
  [pickFulcrum,pickStationary,pickMoving].forEach(b=>b.classList.remove('active'));
  pill.classList.add('active'); target = key;
  document.body.classList.add('cursor-armed');
  log(`Place ${key}‚Ä¶`);
}

pickFulcrum.onclick   = ()=> arm(pickFulcrum,   "fulcrum");
pickStationary.onclick= ()=> arm(pickStationary,"stationary");
pickMoving.onclick    = ()=> arm(pickMoving,    "moving");

/* universal click handler (canvas or svg) */
function handlePlacement(e){
  if(!target) return;
  const leftPanel = document.querySelector('.panel');
  if(leftPanel && leftPanel.contains(e.target)) return;

  const r = renderer.domElement.getBoundingClientRect();
  const x = Math.min(Math.max(e.clientX - r.left, 0), r.width);
  const y = Math.min(Math.max(e.clientY - r.top, 0), r.height);
  const p = { x, y };

  // show overlay and draw chosen dot immediately
  host.classList.remove('hide'); host.setAttribute('aria-hidden','false');

  if (target === 'fulcrum') setDotEl(scrFulcrum, p);
  if (target === 'stationary') setDotEl(scrStationary, p);
  if (target === 'moving') setDotEl(scrMoving, p);

  // save and draw lines
  scr[target] = p;
  setLineEl(scrLineA, scr.fulcrum, scr.stationary, '#ef4444');
  setLineEl(scrLineB, scr.fulcrum, scr.moving, '#22c55e');

  // if all three exist, align + show goniometer
  if(scr.fulcrum && scr.stationary && scr.moving){
    const Fs = scr.fulcrum, Ss = scr.stationary, Ms = scr.moving;
    const baseDeg = Gonio.degFromScreenVec(Ss.x - Fs.x, Ss.y - Fs.y);
    const movDeg  = Gonio.degFromScreenVec(Ms.x - Fs.x, Ms.y - Fs.y);
    Gonio.show();
    Gonio.setPose(Fs.x, Fs.y, baseDeg, movDeg);
    Gonio.zeroHere();
  }

  // disarm after each placement
  target = null;
  [pickFulcrum,pickStationary,pickMoving].forEach(b=>b.classList.remove('active'));
  document.body.classList.remove('cursor-armed');

  log(`Pinned ${Object.keys(scr).filter(k=>scr[k]).length}/3 @ ${x|0},${y|0}`);
}

renderer.domElement.addEventListener('pointerdown', handlePlacement, {passive:false});
document.getElementById('gonioSvg').addEventListener('pointerdown', handlePlacement, {passive:false});

/* reset */
resetMeasurementBtn.onclick = ()=>{
  scr.fulcrum = scr.stationary = scr.moving = null;
  [scrFulcrum,scrStationary,scrMoving].forEach(el=>{ el.style.display='none'; });
  [scrLineA,scrLineB].forEach(el=> el.style.display='none');
  document.getElementById('instrument').style.display='';
  host.classList.add('hide'); host.setAttribute('aria-hidden','true');
  log('Measurement reset');
};

let romActive=false;
startROMBtn.onclick = ()=>{ romActive=true; Gonio.zeroHere(); log('ROM start'); };
resetROMBtn.onclick = ()=>{ romActive=false; log('ROM reset'); };

/* render loop */
addEventListener("resize", ()=>{ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth, innerHeight); });
(function anim(){ controls.update(); hud.textContent = `Angle: ${Gonio.angle.toFixed ? Gonio.angle.toFixed(0) : 0}¬∞`; renderer.render(scene,camera); requestAnimationFrame(anim); })();
</script>
</body>
</html>
