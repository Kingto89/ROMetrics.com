<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PT Lab — Goniometry Trainer</title>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

<style>
  html,body{margin:0;height:100%;background:#0b1220;color:#e5e7eb;overflow:hidden;font-family:system-ui,Segoe UI,Roboto}
  canvas{position:fixed; inset:0; z-index:0; width:100%; height:100%; display:block}

  .panel{
    position:fixed; left:0; top:0; bottom:0; width:360px;
    background:#0f172a; border-right:1px solid #1f2937; padding:14px; overflow:auto; z-index:50;
  }
  h3{margin:8px 0 12px 0}
  label{display:block;font-size:13px;margin-top:10px;color:#cbd5e1}
  select,button,input[type=range]{width:100%;margin:6px 0 8px 0;padding:8px 10px;border-radius:10px;background:#1e293b;border:1px solid #334155;color:#e2e8f0}
  .row{display:flex;gap:8px}.row>button{flex:1}
  #log{background:#0b1220;border:1px solid #1f2937;height:130px;overflow:auto;border-radius:8px;padding:8px}
  .hide{display:none}.lockOn{background:#0b3a1f;border-color:#16a34a}

  .pill{display:flex;flex-direction:column;align-items:center;gap:4px;border:2px solid #334155;border-radius:12px;padding:8px 6px;line-height:1}
  .pill .top{display:flex;align-items:center;gap:6px;font-weight:700}
  .pill .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
  .pill.orange{border-color:#f59e0b}.pill .dot.orange{background:#f59e0b}
  .pill.red{border-color:#ef4444}.pill .dot.red{background:#ef4444}
  .pill.green{border-color:#22c55e}.pill .dot.green{background:#22c55e}
  .pill .label{font-size:12px;color:#cbd5e1}

  .hud,.toast,#msg{z-index:40}
  .hud{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:rgba(15,23,42,.75);border:1px solid #334155;border-radius:10px;padding:6px 10px;font-weight:700;backdrop-filter:blur(6px)}
  .toast{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(2,6,23,.7);border:1px solid #334155;border-radius:10px;padding:6px 10px;font-size:13px;display:none}
  #msg{position:fixed;top:10px;left:10px;background:rgba(15,23,42,.7);border:1px solid #334155;border-radius:8px;padding:6px 10px;font-size:13px}

  details{border:1px solid #1f2937;border-radius:10px;padding:6px 8px;background:#0b1220}
  details+details{margin-top:8px}
  summary{cursor:pointer;font-weight:600;color:#e2e8f0}
  .group{padding:6px 4px}

  /* Note bubble */
  .note{position:fixed;right:16px;bottom:16px;width:min(520px,90vw);background:rgba(2,6,23,.9);border:1px solid #334155;border-radius:12px;padding:14px 46px 14px 14px;z-index:45;backdrop-filter:blur(6px);max-height:60vh;overflow:auto}
  .note h4{margin:0 0 6px 0}
  .note .x{position:absolute;top:8px;right:10px;width:auto;height:auto;line-height:1;cursor:pointer;border:0;background:transparent;color:#94a3b8;font-size:18px;display:block}
  .note .md *{margin:0 0 6px 0;line-height:1.35}
  .note .md{font-size:13px}
  .note .md ul{padding-left:18px}

  /////////////////////////
</style>
</head>
<body>
<div class="panel">




<!-- Note bubble -->
<div id="note" class="note hide">
  <button class="x" id="noteClose">✕</button>
  <h4 id="noteTitle">Note</h4>
  <div id="noteBody" class="md">Loading…</div>
</div>

<script type="module">



/* Motions */
const REGION_MOTIONS = {
  cervical_spine: ["Flexion","Extension","Lateral Flexion","Rotation"],
  thoracic_lumbar_spine: ["Flexion","Extension","Lateral Flexion","Rotation"],
  glenohumeral_joint: ["Flexion","Extension","Abduction","Internal Rotation","External Rotation"],
  elbow_radioulnar: ["Flexion","Extension","Pronation","Supination"],
  wrist: ["Flexion","Extension","Radial Deviation","Ulnar Deviation"],
  hip: ["Flexion","Extension","Abduction","Adduction","Internal Rotation","External Rotation"],
  knee: ["Flexion","Extension"],
  talocrural_ankle: ["Dorsiflexion","Plantarflexion"],
  transverse_tarsal_subtalar: ["Inversion","Eversion"],
  fingers_mcp_pip_dip: ["MCP Flexion","MCP Extension","PIP Flexion","PIP Extension","DIP Flexion","DIP Extension"],
  thumb_cmc_mcp_ip: ["CMC Flexion","CMC Extension","CMC Abduction","CMC Adduction","MCP Flexion","MCP Extension","IP Flexion","IP Extension"],
  toes_mtp_pip_dip: ["MTP Flexion","MTP Extension","PIP Flexion","PIP Extension","DIP Flexion","DIP Extension"]
};
function refreshMotions(){
  const list = REGION_MOTIONS?.[regionSel.value] || [];
  motionSel.innerHTML = "";
  (list.length? list: ["(No motions)"]).forEach(t=>{
    const o=document.createElement("option"); o.value=t; o.textContent=t; motionSel.appendChild(o);
  });
}
refreshMotions();
regionSel.onchange = refreshMotions;

/* ===================== THREE SETUP ===================== */
const canvas = document.getElementById("c");
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
renderer.setPixelRatio(devicePixelRatio);
renderer.setSize(innerWidth, innerHeight);
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.0;
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
renderer.domElement.style.touchAction = 'none';

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0b1220);

const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.01, 100);
camera.position.set(1.6, 1.6, 2.8);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.08;
controls.enablePan = true;
controls.screenSpacePanning = false;
controls.minDistance = 0.8;
controls.maxDistance = 6;
controls.target.set(0, 1.1, 0);

/* Lights + shadow */
scene.add(new THREE.HemisphereLight(0xffffff, 0x333344, 0.7));
const key = new THREE.DirectionalLight(0xffffff, 1.2);
key.position.set(2.5, 4, 2.5);
key.castShadow = true;
key.shadow.mapSize.set(2048,2048);
key.shadow.camera.near = 0.1;
key.shadow.camera.far = 15;
key.shadow.camera.left = -4;
key.shadow.camera.right = 4;
key.shadow.camera.top = 4;
key.shadow.camera.bottom = -4;
scene.add(key);

/* Ground plane */
const groundGeo = new THREE.PlaneGeometry(20, 20);
const groundMat = new THREE.ShadowMaterial({ opacity: 0.45 });
const ground = new THREE.Mesh(groundGeo, groundMat);
ground.rotation.x = -Math.PI/2;
ground.position.y = 0;
ground.receiveShadow = true;
scene.add(ground);

/* ========== Model loader (+ ground-snap) ========== */
const loader = new GLTFLoader();
loader.setMeshoptDecoder(MeshoptDecoder);
const draco = new DRACOLoader(); draco.setDecoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/"); loader.setDRACOLoader(draco);
const ktx2 = new KTX2Loader(); ktx2.setTranscoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/basis/"); ktx2.detectSupport(renderer); loader.setKTX2Loader(ktx2);

let model = null;
const MODEL_URL = "/ROMetrics.com/assets/Roma_ROMetrics.glb?v=1";
function addFallbackMannequin(){
  if (model) return;
  const g = new THREE.Group();
  const mat = new THREE.MeshStandardMaterial({color:0xa0a4ae, metalness:0.1, roughness:0.8});
  const mk = (geo,y,s=1)=>{ const m=new THREE.Mesh(geo,mat); m.position.y=y; m.scale.setScalar(s); m.castShadow=true; g.add(m); };
  mk(new THREE.CapsuleGeometry(0.22,0.8,8,16), 1.1);
  mk(new THREE.SphereGeometry(0.16,16,16),        1.8);
  mk(new THREE.CylinderGeometry(0.1,0.12,0.3,12), 1.45);
  mk(new THREE.CylinderGeometry(0.11,0.11,0.8,12),0.55);
  g.traverse(o=>{ if(o.isMesh){ o.castShadow = true; }});
  scene.add(g); model = g; msg.textContent = "⚠️ GLB missing/blocked — fallback mannequin shown";
  groundSnap();
}
function groundSnap(){
  if(!model) return;
  const box = new THREE.Box3().setFromObject(model);
  const minY = box.min.y;
  model.position.y -= minY; // feet at y=0
}

async function loadModel() {
  try {
    const head = await fetch(MODEL_URL, { method: "HEAD", cache: "no-store" });
    if (!head.ok) { msg.textContent = `⚠️ ${MODEL_URL} (HTTP ${head.status}) — using fallback`; addFallbackMannequin(); return; }
  } catch { msg.textContent = `⚠️ Network error — using fallback`; addFallbackMannequin(); return; }

  loader.load(MODEL_URL, (gltf) => {
    model = gltf.scene;
    model.traverse(o=>{ if(o.isMesh){ o.castShadow = true; }});
    scene.add(model);

    groundSnap();
    model.position.x = 0;
    model.position.z = 0.6;
    model.scale.setScalar(1.0);

    controls.target.set(0,1.1,0);
    msg.textContent = "✅ Model loaded";
  }, (xhr) => {
    msg.textContent = xhr.lengthComputable ? `Loading ${Math.round((xhr.loaded/xhr.total)*100)}%` : "Loading…";
  }, () => { msg.textContent = "⚠️ Loader error — using fallback"; addFallbackMannequin(); });
  setTimeout(()=>{ if (!model) addFallbackMannequin(); }, 6000);
}
loadModel();

///Moved   /* ===================== SCREEN-SPACE DOTS (no 3D raycast) ===================== */

/* ===================== NOTES LOADER (Markdown) ===================== */
function mdToHtml(md){
  let html = md
    .replace(/^### (.*)$/gm, '<h5>$1</h5>')
    .replace(/^## (.*)$/gm, '<h4>$1</h4>')
    .replace(/^# (.*)$/gm, '<h3>$1</h3>')
    .replace(/^\* (.*)$/gm, '<li>$1</li>');
  html = html.replace(/(<li>[\s\S]*?<\/li>)/g, '<ul>$1</ul>');
  html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  return html;
}
async function loadNote(region, motion){
  const url = `./goniometer-placement-guide/${region}.md?${Date.now()}`;
  try{
    const res = await fetch(url);
    if(!res.ok){ throw new Error(`HTTP ${res.status}`); }
    const md = await res.text();
    const re = new RegExp(`(^|\\n)##?\\s*${motion}\\s*\\n([\\s\\S]*?)(\\n##?\\s|$)`,'i');
    const m = md.match(re);
    const section = m ? m[2].trim() : md;
    noteTitle.textContent = `${regionToTitle(region)} — ${motion}`;
    noteBody.innerHTML = mdToHtml(section || "—");
  }catch(e){
    console.error(e);
    noteTitle.textContent = `${regionToTitle(region)} — ${motion}`;
    noteBody.textContent = "Failed to load note.";
  }
}
function regionToTitle(r){
  return ({
    cervical_spine:"Cervical Spine",
    thoracic_lumbar_spine:"Thoracic & Lumbar Spine",
    glenohumeral_joint:"Glenohumeral Joint",
    elbow_radioulnar:"Elbow & Radioulnar Joints",
    wrist:"Wrist", hip:"Hip", knee:"Knee",
    talocrural_ankle:"Talocrural (Ankle)",
    transverse_tarsal_subtalar:"Transverse Tarsal & Subtalar",
    fingers_mcp_pip_dip:"Fingers (MCP, PIP, DIP)",
    thumb_cmc_mcp_ip:"Thumb (CMC, MCP, IP)",
    toes_mtp_pip_dip:"Toes (MTP, PIP, DIP)"
  }[r]||r.replace(/_/g,' '));
}
document.getElementById("showNote").onclick = async ()=>{
  const region = regionSel.value;
  const motion = motionSel.value || "(General)";
  await loadNote(region, motion);
  note.classList.remove("hide");
};


</script>
</body>
</html>
